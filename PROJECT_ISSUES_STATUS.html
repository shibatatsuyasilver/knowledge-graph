<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¡ˆå•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆç‹€æ…‹è¿½è¹¤ (Project Issues & Solutions Status)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color Palette */
            --primary-color: #2563eb;       /* Modern Blue */
            --primary-dark: #1e40af;
            --secondary-color: #475569;     /* Slate Gray */
            --bg-color: #f8fafc;            /* Light Grayish Blue */
            --card-bg: #ffffff;
            --text-color: #1e293b;          /* Dark Slate */
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            
            /* Status Colors */
            --success-bg: #dcfce7;
            --success-text: #166534;
            --warning-bg: #fef9c3;
            --warning-text: #854d0e;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            --info-bg: #e0f2fe;
            --info-text: #075985;
            --neutral-bg: #f1f5f9;
            --neutral-text: #475569;

            /* Spacing & Layout */
            --container-width: 100%;
            --sidebar-width: 280px;
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            
            /* Typography */
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            --font-zh: 'Noto Sans TC', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-main);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-zh), var(--font-main);
            color: var(--text-color);
            margin-bottom: 0.75em;
            font-weight: 700;
            line-height: 1.3;
        }

        h1 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 0; /* Reset margin for card context */
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        h2::before {
            content: '';
            display: block;
            width: 6px;
            height: 24px;
            background-color: var(--primary-color);
            border-radius: 4px;
        }

        h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            color: var(--secondary-color);
        }
        
        h4 {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-top: 1.25rem;
        }

        p {
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }
        
        strong {
            color: var(--text-color);
            font-weight: 600;
        }

        /* Layout */
        .container {
            max-width: var(--container-width);
            margin: 0;
            padding: 2rem;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            gap: 2.5rem;
            align-items: start;
        }

        /* Sidebar */
        .sidebar {
            grid-column: 1;
            position: sticky;
            top: 2rem;
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .sidebar h3 {
            font-size: 1.1rem;
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
        }

        .nav-link {
            display: block;
            color: var(--secondary-color);
            text-decoration: none;
            padding: 0.6rem 0.75rem;
            margin-bottom: 0.25rem;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: var(--neutral-bg);
            color: var(--primary-color);
        }
        
        .nav-link:active, .nav-link:focus {
             background-color: var(--info-bg);
             color: var(--primary-dark);
             border-left-color: var(--primary-color);
        }

        .nav-link.sub-link {
            padding-left: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .nav-link.sub-link:hover {
            color: var(--text-color);
        }

        /* Main Content */
        .main-content {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        section {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: box-shadow 0.3s ease;
        }
        
        section:hover {
            box-shadow: var(--shadow-md);
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th, td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        th {
            background-color: var(--neutral-bg);
            color: var(--secondary-color);
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: var(--bg-color);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1;
            white-space: nowrap;
        }

        .badge.done {
            background-color: var(--success-bg);
            color: var(--success-text);
        }

        .badge.pending {
            background-color: var(--warning-bg);
            color: var(--warning-text);
        }

        .badge.paused {
            background-color: var(--neutral-bg);
            color: var(--neutral-text);
        }
        
        /* Code & Pre */
        code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            background-color: var(--neutral-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--primary-dark);
            border: 1px solid var(--border-color);
        }

        pre {
            background-color: #1e293b; /* Dark theme for code blocks */
            color: #f8fafc;
            padding: 1.25rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
            border: none;
            font-size: inherit;
        }

        /* Mermaid Diagrams */
        .mermaid {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--neutral-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: visible;
            display: block;
        }

        /* Section-3 detailed KG diagrams: keep natural SVG size and allow horizontal scroll */
        #section-3-4 .mermaid > svg {
            display: block;
            max-width: none !important;
            width: auto !important;
            height: auto !important;
            overflow: visible;
            margin: 0 auto;
        }

        /* Section-3 collapsible diagrams */
        .diagram-collapsible {
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .diagram-collapsible-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--neutral-bg);
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .diagram-collapsible-header:hover {
            background: var(--border-color);
        }

        .diagram-collapsible-header .toggle-icon {
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: color 0.2s ease;
            flex-shrink: 0;
            width: 1rem;
            text-align: center;
        }

        .diagram-collapsible-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .diagram-collapsible-content {
            display: none;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        .diagram-collapsible.open .diagram-collapsible-content {
            display: block;
        }

        .diagram-collapsible-content .mermaid {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .diagram-detail {
            margin-top: 0.5rem;
            padding: 0.9rem 1rem;
            background: var(--neutral-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .diagram-detail ol {
            margin: 0;
            padding-left: 1.25rem;
        }

        .diagram-detail li {
            margin-bottom: 0.45rem;
            color: var(--secondary-color);
        }

        .diagram-detail li:last-child {
            margin-bottom: 0;
        }

        /* Lists */
        ul, ol {
            padding-left: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--secondary-color);
        }

        li {
            margin-bottom: 0.5rem;
        }
        
        li::marker {
            color: var(--primary-color);
        }

        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary-color);
            background-color: var(--info-bg);
            color: var(--info-text);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }
        
        blockquote p {
            margin-bottom: 0;
            color: inherit;
        }

        /* Links */
        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        /* Utility */
        .text-sm {
            font-size: 0.875rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 240px 1fr;
                padding: 1.5rem;
                gap: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .sidebar {
                grid-column: 1;
                position: static;
                margin-bottom: 1.5rem;
                max-height: none;
            }
            
            .main-content {
                grid-column: 1;
            }
            
            section {
                padding: 1.5rem;
            }

            h1 {
                font-size: 1.75rem;
            }
            
            h2 {
                font-size: 1.35rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h3>ç›®éŒ„ (Table of Contents)</h3>
            <nav>
                <a href="#intro" class="nav-link">å°ˆæ¡ˆæ¦‚è¦½</a>
                <a href="#section-1" class="nav-link">1. ç›®å‰å•é¡Œè¿½è¹¤</a>
                <a href="#section-2" class="nav-link">2. é–‹æº LLM æ¨¡å‹ä½ˆç½²</a>
                <a href="#section-2-1" class="nav-link sub-link">(1) é¸æ“‡çš„é–‹æº LLM æ¨¡å‹</a>
                <a href="#section-2-2" class="nav-link sub-link">(2) éƒ¨ç½²æ–¹å¼</a>
                <a href="#section-2-3" class="nav-link sub-link">(3) éƒ¨ç½²é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±º</a>
                <a href="#section-3" class="nav-link">3. Domain Knowledge Graph</a>
                <a href="#section-3-step" class="nav-link sub-link">æ­¥é©Ÿèªªæ˜</a>
                <a href="#section-3-0" class="nav-link sub-link">(0) å¯¦ä½œå°æ‡‰</a>
                <a href="#section-3-1" class="nav-link sub-link">(1) åˆ©ç”¨ LLM å»ºç«‹ KG</a>
                <a href="#section-3-2" class="nav-link sub-link">(2) ä½¿ç”¨è€…å•é¡Œè½‰ Graph DB (NL2Cypher)</a>
                <a href="#section-3-3" class="nav-link sub-link">(3) é¸æ“‡ Neo4j çš„åŸå› </a>
                <a href="#section-3-4" class="nav-link sub-link">(4) è©³ç´°æµç¨‹åœ–</a>
                <a href="#section-4" class="nav-link">4. OpenClaw æ¶æ§‹èˆ‡æŠ€èƒ½å®‰å…¨åˆ†æ</a>
                <a href="#section-4-1" class="nav-link sub-link">(1) ç³»çµ±æ¶æ§‹èˆ‡ä¸»è¦çµ„ä»¶</a>
                <a href="#section-4-2" class="nav-link sub-link">(2) å®‰å…¨é¢¨éšªï¼ˆ3 å¤§é¡ 10 é …ï¼‰</a>
                <a href="#section-4-3" class="nav-link sub-link">(3) æŠ€èƒ½å®‰å…¨å¯©æŸ¥æ©Ÿåˆ¶</a>
                <a href="#section-5" class="nav-link">5. OpenClaw Skill Plugin èˆ‡ Agent</a>
                <a href="#section-5-1" class="nav-link sub-link">(1) è‡ªè¨‚ Plugin</a>
                <a href="#section-5-2" class="nav-link sub-link">(2) å¤š Skill è‡ªå‹•åŒ–æµç¨‹</a>
                <a href="#section-6" class="nav-link">6. é™„ä»¶ï¼šå¦‚ä½•å•Ÿå‹•</a>
            </nav>
        </aside>

        <main class="main-content">
            <section id="intro">
                <h1>å°ˆæ¡ˆå•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆç‹€æ…‹è¿½è¹¤ (Project Issues & Solutions Status)</h1>
                <p>æœ¬æ–‡ä»¶æ—¨åœ¨è¨˜éŒ„ OpenClaw å°ˆæ¡ˆé–‹ç™¼éç¨‹ä¸­çš„é—œéµå•é¡Œã€è§£æ±ºæ–¹æ¡ˆã€æ¶æ§‹æ±ºç­–ä»¥åŠæœªä¾†è¦åŠƒã€‚</p>
            </section>

            <section id="section-1">
                <h2>1. ç›®å‰å•é¡Œè¿½è¹¤ (Current Issues Tracking)</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%">å•é¡Œ (Problem)</th>
                                <th style="width: 50%">è§£æ³• (Solution)</th>
                                <th style="width: 20%">ç‹€æ…‹ (Status)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>æŠ½å–å¸¸å‡ºç¾ JSON ç ´æ/<think> å°è‡´ parse fail</strong></td>
                                <td>æŠ½å–åŠ  5 æ¬¡é‡è©¦ã€JSON ä¿®å¾© promptã€æé«˜è¼¸å‡º token ä¸Šé™ã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/llm_kg/kg_builder.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>å‰ç«¯é•·æ™‚é–“åªé¡¯ç¤º Processing...</strong></td>
                                <td>Text/File/URL æ”¹ async job + pollingï¼Œé¡¯ç¤º chunk é€²åº¦èˆ‡ç‹€æ…‹ã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/main.py</code>, <code class="text-sm">frontend/src/components/BuildKG.tsx</code></td>
                            </tr>
                            <tr>
                                <td><strong>é•·æ–‡æœ¬å°è‡´è¨˜æ†¶é«”å£“åŠ›ï¼ˆOOM é¢¨éšªï¼‰</strong></td>
                                <td>Ingest ç«¯æ”¹ç‚ºå…ˆåˆ‡ chunk å†é€å¡ŠæŠ½å–ï¼ˆprovider-aware token/char budgetï¼‰ï¼Œä¸¦æ”¯æ´ <code>chunk_limit</code> é™æµã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/logic.py</code>, <code class="text-sm">backend/main.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>KG å›ç­”å¤ªç”Ÿç¡¬ã€å¸¸å¸¶ã€Œæ ¹æ“šçŸ¥è­˜åœ–è­œã€å‰ç¶´</strong></td>
                                <td>/api/query æ”¹æˆå…ˆæŸ¥ rowsï¼Œå†ç”¨ QA LLM é‡å¯«ç­”æ¡ˆï¼Œå¤±æ•—æ‰ fallbackã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/logic.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>UNION/UNION ALL åˆ†æ”¯ RETURN æ¬„ä½åˆ¥åä¸ä¸€è‡´ï¼Œè§¸ç™¼ Neo4j syntax errorï¼ˆ500ï¼‰</strong></td>
                                <td>ç›®å‰åƒ…åœ¨ <code>Agentic Async (Manual)</code> è·¯å¾‘æœ‰ UNION åˆ¥åä¸€è‡´æ€§ä¿®æ­£èˆ‡ repair loopï¼›<code>GraphCypherQAChain (Sync)</code> å°šæœªå¥—ç”¨åŒç­‰ guardï¼Œå› æ­¤ä»å¯èƒ½å¤±æ•—ã€‚</td>
                                <td><span class="badge pending">ğŸš§ éƒ¨åˆ†å®Œæˆ</span><br>Manualï¼šâœ… å·²è™•ç†ï¼ˆ<code class="text-sm">backend/llm_kg/nl2cypher.py</code>ï¼‰<br>GraphCypherQAChainï¼šå¾…è£œå¼·</td>
                            </tr>
                            <tr>
                                <td><strong>ä¸€å¥å¤šå•ï¼ˆä¾‹å¦‚ã€Œè‘£äº‹é•· + å‰µè¾¦äººã€ï¼‰</strong></td>
                                <td>å·²å¯ç›´æ¥è™•ç†åŒå¥å¤šæ„åœ–å•ç­”ï¼ˆä¾‹å¦‚åŒæ™‚è©¢å•å‰µè¾¦äººèˆ‡è‘£äº‹é•·ï¼‰ï¼Œç”± agentic æµç¨‹ç”Ÿæˆèˆ‡ä¿®æ­£æŸ¥è©¢å¾Œå›è¦†ã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/llm_kg/nl2cypher.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>å¯¦é«”æ¼æŠ½å•é¡Œ</strong></td>
                                <td>Gemini èµ°å…©éšæ®µæŠ½å–ï¼šå…ˆç›¤é» entity æ¯”å° KG è£œé½Šï¼Œå†ç¬¬äºŒè¼ªæŠ½ relationã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/llm_kg/kg_builder.py</code>, <code class="text-sm">GEMINI_TWO_PASS_EXTRACTION=1</code></td>
                            </tr>
                            <tr>
                                <td><strong>OpenClaw Skill å®‰å…¨å¯©æŸ¥è¦†è“‹ä¸è¶³</strong></td>
                                <td>ç›®å‰åƒ…æœ‰ Regex éœæ…‹æª¢æŸ¥ï¼ˆ<code>skill_audit.ts</code>ï¼‰ï¼›éœ€è£œ AST åˆ†æã€æ²™ç®±å‹•æ…‹æ¸¬è©¦ã€ä¾†æºç°½ç« èˆ‡æ¬Šé™å¯©æ‰¹ã€‚</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span></td>
                            </tr>
                            <tr>
                                <td><strong>OpenClaw æ¬Šé™æ¨¡å‹ç²’åº¦ä¸è¶³</strong></td>
                                <td>å°å…¥ capability-based æ¬Šé™ï¼ˆæª”æ¡ˆ/ç¶²è·¯/å‘½ä»¤/å¤–éƒ¨ API åˆ†é›¢æˆæ¬Šï¼‰ï¼Œé«˜é¢¨éšªæ¬Šé™éœ€é›™é‡ç¢ºèªã€‚</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span></td>
                            </tr>
                            <tr>
                                <td><strong>OpenClaw æ©Ÿæ•æ†‘è­‰æ²»ç†ä¸è¶³</strong></td>
                                <td>ç¬¬ä¸‰æ–¹ API Token æ”¹ç”±å¯†é‘°ç®¡ç†èˆ‡éœæ…‹åŠ å¯†ä¿å­˜ï¼Œè£œ token è¼ªæ›¿ã€å¯©è¨ˆèˆ‡å¤–æ´©å‘Šè­¦ã€‚</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span></td>
                            </tr>
                            <tr>
                                <td><strong>OpenClaw Prompt Injection é¢¨éšª</strong></td>
                                <td>å° Skill å›å‚³å…§å®¹åŠ  trusted/untrusted æ¨™è¨˜ã€æ¨¡æ¿åŒ–åŒ…è£èˆ‡æŒ‡ä»¤éš”é›¢ï¼Œé˜»æ–·ã€Œå·¥å…·è¼¸å‡ºè¦†è“‹ç³»çµ±æŒ‡ä»¤ã€ã€‚</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-2">
                <h2>2. é–‹æº LLM æ¨¡å‹ä½ˆç½²è©³ç´°èªªæ˜</h2>

                <div id="section-2-1">
                    <h3>(1) é¸æ“‡çš„é–‹æº LLM æ¨¡å‹</h3>
                    <p>æœ¬å°ˆæ¡ˆæ¡ç”¨ <strong>Hybrid æ¨¡å¼</strong>ï¼Œä¸»è¦ä½¿ç”¨ <strong>Ollama (DeepSeek R1 / Qwen 3 / Ministral 3)</strong> ä½œç‚ºæœ¬åœ°é–‹æºæ¨¡å‹ï¼Œä¸¦æ”¯æ´åˆ‡æ›è‡³ <strong>Gemini 3 Pro (Preview)</strong>ï¼ˆæˆ–ç›¸å®¹æ–°ç‰ˆæœ¬ï¼‰ä»¥ç²å¾—æ›´é«˜å“è³ªçš„çŸ¥è­˜æŠ½å–ã€‚</p>
                    
                    <ul>
                        <li><strong>é¸æ“‡æ¨¡å‹</strong>: <code>deepseek-r1:8b</code> / <code>qwen3</code> / <code>ministral-3:14b</code> (é€é Ollama) æˆ– <code>gemini-3-pro-preview</code>ã€‚</li>
                        <li><strong>å„ªé» (Pros)</strong>:
                            <ul>
                                <li><strong>DeepSeek R1 / Qwen 3</strong>: æ”¯æ´ <strong>Chain of Thought (CoT)</strong> æ€ç¶­éˆï¼Œé‚è¼¯æ¨ç†èƒ½åŠ›é¡¯è‘—å¢å¼·ï¼Œé©åˆè™•ç†è¤‡é›œæŒ‡ä»¤ï¼ŒåŒæ™‚ä¿æœ‰æœ¬åœ°éƒ¨ç½²çš„éš±ç§å„ªå‹¢èˆ‡ç„¡ API æˆæœ¬ã€‚</li>
                                <li><strong>Ministral 3 (14B)</strong>: åœ¨ <strong>æŒ‡ä»¤éµå®ˆ</strong> èˆ‡ <strong>çµæ§‹åŒ–è¼¸å‡º</strong> è¡¨ç¾ç©©å®šï¼Œç‰¹åˆ¥é©åˆ <strong>NL2Cypher</strong> ä»»å‹™ï¼ˆå¯é™ä½ Cypher ç”Ÿæˆåé¡Œèˆ‡æ ¼å¼æ¼‚ç§»ï¼‰ã€‚</li>
                                <li><strong>Gemini 3 Pro</strong>: æ“æœ‰è¶…é•· Context Window (<strong>1,048,576 input tokens</strong>) èˆ‡å¼·å¤§çš„é‚è¼¯æ¨ç†èƒ½åŠ›ï¼Œå°æ–¼è¤‡é›œçš„å¯¦é«”é—œä¿‚æŠ½å– (NER/RE) æº–ç¢ºç‡é€šå¸¸å„ªæ–¼å°åƒæ•¸æ¨¡å‹ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>ç¼ºé» (Cons)</strong>:
                            <ul>
                                <li><strong>DeepSeek R1 / Qwen 3</strong>: åœ¨å•Ÿç”¨ thinking æˆ–è¼¸å‡ºç´„æŸä¸è¶³æ™‚ï¼Œå¯èƒ½æ··å…¥æ€è€ƒå…§å®¹/è¨»é‡‹è€Œå°è‡´ JSON è§£æå¤±æ•— (Parse Fail)ï¼›ä¸” CoT å¯èƒ½å¢åŠ æ¨è«–æ™‚é–“ã€‚éœ€æ­é… <code>think=false</code>/<code>hidethinking</code> èˆ‡å¾Œè™•ç†ä¿è­·ã€‚</li>
                                <li><strong>Gemini 3 Pro</strong>: ä¾è³´ç¶²è·¯ï¼Œæœ‰ API Rate Limit é™åˆ¶èˆ‡æˆæœ¬ï¼Œä¸”å­˜åœ¨æ•¸æ“šå‚³è¼¸éš±ç§è€ƒé‡ã€‚</li>
                            </ul>
                        </li>
                    </ul>

                    <h4>å®˜æ–¹ Benchmark åƒè€ƒï¼ˆæˆªè‡³ 2026-02-15ï¼‰</h4>
                    <blockquote>è¨»ï¼šä»¥ä¸‹ç‚ºå®˜æ–¹æ¨¡å‹å¡/å®˜æ–¹é é¢å…¬å¸ƒçš„æˆç¸¾ï¼Œä¸åŒæ¨è«–æ¡†æ¶ã€é‡åŒ–ç‰ˆæœ¬ã€sampling è¨­å®šä¸‹ï¼Œå¯¦æ¸¬çµæœå¯èƒ½æµ®å‹•ã€‚</blockquote>

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ¨¡å‹</th>
                                    <th>å®˜æ–¹æ¸¬è©¦æŒ‡æ¨™</th>
                                    <th>åˆ†æ•¸</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>deepseek-r1:8b</code>ï¼ˆOllama å°æ‡‰ <code>DeepSeek-R1-0528-Qwen3-8B</code>ï¼‰</td>
                                    <td>AIME24 / AIME25 / GPQA-Diamond / LiveCodeBench</td>
                                    <td><strong>86.0 / 76.3 / 61.1 / 60.5</strong></td>
                                </tr>
                                <tr>
                                    <td><code>qwen3:8b</code>ï¼ˆThinking, bf16ï¼‰</td>
                                    <td>LiveBench / GPQA / MMLU-Redux / AIME24</td>
                                    <td><strong>67.1 / 62.0 / 87.5 / 76.0</strong></td>
                                </tr>
                                <tr>
                                    <td><code>qwen3:8b</code>ï¼ˆNon-Thinking, bf16ï¼‰</td>
                                    <td>LiveBench / GPQA / MMLU-Redux</td>
                                    <td><strong>53.5 / 39.3 / 79.5</strong></td>
                                </tr>
                                <tr>
                                    <td><code>ministral-3:14b</code>ï¼ˆReasoningï¼‰</td>
                                    <td>AIME25 / AIME24 / GPQA-Diamond / LiveCodeBench</td>
                                    <td><strong>85.0 / 89.8 / 71.2 / 64.6</strong></td>
                                </tr>
                                <tr>
                                    <td><code>ministral-3:14b</code>ï¼ˆInstructï¼‰</td>
                                    <td>Arena Hard / WildBench / MATH Maj@1 / MM MTBench</td>
                                    <td><strong>55.1 / 68.5 / 90.4 / 8.49</strong></td>
                                </tr>
                                <tr>
                                    <td><code>gemini-3-pro-preview</code></td>
                                    <td>Humanity's Last Exam / GPQA-Diamond / AIME 2025 / MMMU-Pro</td>
                                    <td><strong>37.5 / 91.9 / 95.0 / 81.0</strong></td>
                                </tr>
                                <tr>
                                    <td><code>gemini-3-pro-preview</code></td>
                                    <td>Token limits</td>
                                    <td><strong>Input 1,048,576 / Output 65,536</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p><strong>è³‡æ–™ä¾†æºï¼ˆå®˜æ–¹ï¼‰</strong></p>
                    <ol>
                        <li>DeepSeek æ¨¡å‹å¡ï¼š<a href="https://huggingface.co/deepseek-ai/DeepSeek-R1-0528" target="_blank">https://huggingface.co/deepseek-ai/DeepSeek-R1-0528</a></li>
                        <li>Qwen3 8B æ¨¡å‹å¡ï¼š<a href="https://huggingface.co/Qwen/Qwen3-8B-AWQ" target="_blank">https://huggingface.co/Qwen/Qwen3-8B-AWQ</a></li>
                        <li>Ministral 3 14B æ¨¡å‹å¡ï¼š<a href="https://huggingface.co/mistralai/Ministral-3-14B-Instruct-2512" target="_blank">https://huggingface.co/mistralai/Ministral-3-14B-Instruct-2512</a></li>
                        <li>Gemini 3 Pro benchmark: <a href="https://deepmind.google/technologies/gemini/pro/" target="_blank">https://deepmind.google/technologies/gemini/pro/</a></li>
                        <li>Gemini 3 Pro token limits: <a href="https://ai.google.dev/gemini-api/docs/models/gemini" target="_blank">https://ai.google.dev/gemini-api/docs/models/gemini</a></li>
                    </ol>

                    <p><strong>è§£è®€æ–¹å¼ï¼ˆå°æ‡‰ä½ çš„ä»»å‹™ï¼‰</strong></p>
                    <ul>
                        <li>NER/REï¼šå¯å„ªå…ˆåƒè€ƒ GPQAã€AIMEã€HLE é€™é¡æ¨ç†/çŸ¥è­˜å¯†é›†æŒ‡æ¨™ï¼Œä½œç‚ºã€Œè¤‡é›œé—œä¿‚æŠ½å–èƒ½åŠ›ã€çš„è¿‘ä¼¼ä»£ç†ã€‚</li>
                        <li>NL2Cypherï¼šå¯å„ªå…ˆåƒè€ƒ Arena Hardã€WildBenchã€MM MTBench èˆ‡æ¨¡å‹æ˜¯å¦åŸç”Ÿæ”¯æ´ function calling / JSON outputsï¼Œä½œç‚ºã€ŒæŒ‡ä»¤éµå®ˆ + çµæ§‹åŒ–è¼¸å‡ºã€çš„è¿‘ä¼¼ä»£ç†ã€‚</li>
                        <li>ç›®å‰æ²’æœ‰å–®ä¸€å®˜æ–¹ benchmark å¯ä»¥ç›´æ¥ç­‰åŒ NER/RE æˆ– NL2Cypherï¼Œä»å»ºè­°ä¿ç•™å°ˆæ¡ˆå…§éƒ¨å›æ­¸æ¸¬è©¦é›†ä½œæœ€çµ‚ä¾æ“šã€‚</li>
                    </ul>
                </div>

                <div id="section-2-2">
                    <h3>(2) éƒ¨ç½²æ–¹å¼</h3>
                    <p>ä½¿ç”¨ <strong>Docker Container</strong> é€²è¡Œå¾®æœå‹™åŒ–éƒ¨ç½²ï¼š</p>
                    <ol>
                        <li><strong>Ollama Service</strong>: ä½¿ç”¨å®˜æ–¹ <code>ollama/ollama</code> Docker æ˜ åƒæª”ï¼Œæ›è¼‰ GPU (å¦‚æ”¯æ´) é€²è¡Œæœ¬åœ°æ¨è«–ã€‚</li>
                        <li><strong>API Wrapper</strong>: é–‹ç™¼ <code>backend/llm_kg/llm_deploy.py</code> (åŸºæ–¼ FastAPI)ï¼Œä½œç‚ºçµ±ä¸€äººå·¥æ™ºæ…§ä»‹é¢å±¤ (<code>backend/llm_kg/llm_client.py</code>)ã€‚
                            <ul>
                                <li>æ­¤å±¤è² è²¬è™•ç†ä¸åŒ Provider (Ollama/OpenAI/Gemini) çš„ API å·®ç•°ã€‚</li>
                                <li>é€éç’°å¢ƒè®Šæ•¸ (<code>LLM_PROVIDER</code>) å‹•æ…‹åˆ‡æ›å¾Œç«¯æ¨¡å‹ï¼Œç„¡éœ€ä¿®æ”¹ç¨‹å¼ç¢¼ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Orchestration</strong>: ä½¿ç”¨ <code>backend/llm_kg/docker-compose.llmkg.yml</code> å®šç¾©æœå‹™ä¾è³´èˆ‡ç¶²çµ¡ã€‚</li>
                    </ol>
                </div>

                <div id="section-2-3">
                    <h3>(3) éƒ¨ç½²é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±º</h3>
                    <ul>
                        <li><strong>å•é¡Œ 1: JSON æ ¼å¼ç ´æ (Malformed JSON)</strong>
                            <ul>
                                <li><strong>ç‹€æ³</strong>: é–‹æºæ¨¡å‹ (DeepSeek R1 / Qwen 3) åœ¨ç‰¹å®šè¨­å®šä¸‹å¯èƒ½è¼¸å‡ºæ€è€ƒå…§å®¹ã€ä¸å®Œæ•´ JSON æˆ– Markdown è¨»é‡‹ï¼Œå°è‡´ <code>json.loads</code> å¤±æ•—ã€‚</li>
                                <li><strong>è§£æ±º</strong>: åœ¨ <code>backend/llm_kg/kg_builder.py</code> å¯¦ä½œ <strong>Retry & Repair Loop</strong>ã€‚å„ªå…ˆé€éæ¨¡å‹åƒæ•¸é—œé–‰/éš±è— thinkingï¼Œå†æ–¼è§£æå¤±æ•—æ™‚å›å‚³éŒ¯èª¤çµ¦ LLM è¦æ±‚ä¿®æ­£ JSONï¼Œæœ€å¤šé‡è©¦ 5 æ¬¡ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>å•é¡Œ 2: å›æ‡‰è¶…æ™‚ (Timeout)</strong>
                            <ul>
                                <li><strong>ç‹€æ³</strong>: è™•ç†é•·æ–‡æœ¬è¼¸å…¥æ™‚ï¼ŒLLM ç”Ÿæˆæ™‚é–“éé•·å°è‡´ HTTP 504 Gateway Timeoutã€‚</li>
                                <li><strong>è§£æ±º</strong>: å‰ç«¯æ”¹ç‚º <strong>Async Job + Polling</strong> æ©Ÿåˆ¶ã€‚ä¸Šå‚³æ–‡ä»¶å¾Œå›å‚³ Job IDï¼Œå‰ç«¯æ¯éš”å¹¾ç§’æŸ¥è©¢é€²åº¦ï¼Œé¿å…é•·é€£æ¥æ–·é–‹ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>å•é¡Œ 3: æ€ç¶­éˆ (Chain of Thought) å¹²æ“¾</strong>
                            <ul>
                                <li><strong>ç‹€æ³</strong>: éƒ¨åˆ†æ¨¡å‹åœ¨ thinking æ¨¡å¼ä¸‹å¯èƒ½è¼¸å‡ºé¡å¤–æ¨ç†å…§å®¹ï¼Œå¹²æ“¾ JSON çµæ§‹ã€‚</li>
                                <li><strong>è§£æ±º</strong>: å…ˆç”¨æ¨¡å‹åƒæ•¸é—œé–‰/éš±è— thinkingï¼ˆ<code>think=false</code> æˆ– <code>hidethinking</code>ï¼‰ï¼Œä¸¦åœ¨ Prompt ç¦æ­¢è¼¸å‡ºæ€è€ƒéç¨‹ï¼›å¾Œè™•ç† Regex æ¸…æ´—ä½œç‚ºæœ€å¾Œä¿éšªã€‚</li>
                            </ul>
                        </li>
                        <li><strong>å•é¡Œ 4: é•·æ–‡ä»¶é€ æˆè¨˜æ†¶é«”å£“åŠ›ï¼ˆOOM é¢¨éšªï¼‰</strong>
                            <ul>
                                <li><strong>ç‹€æ³</strong>: å–®æ¬¡æŠŠæ•´ä»½é•·æ–‡ä»¶ä¸Ÿå…¥æŠ½å–æµç¨‹ï¼Œæœƒæ”¾å¤§ token/è¨˜æ†¶é«”è² è¼‰ï¼Œåœ¨æœ¬åœ°æ©Ÿæˆ–å®¹å™¨è³‡æºæœ‰é™æ™‚å®¹æ˜“ä¸ç©©å®šã€‚</li>
                                <li><strong>è§£æ±º</strong>: åœ¨ <code>backend/logic.py</code> å°‡ Text/File/URL ingest æ”¹ç‚º <strong>chunk-first pipeline</strong>ï¼š
                                    <ul>
                                        <li>å…ˆä¾ provider åšåˆ‡å¡Šï¼šGemini é è¨­ token budgetï¼Œå…¶ä»– provider é è¨­ char budgetï¼ˆå¯ç”± <code>CHUNK_SIZE_MODE</code> å¼·åˆ¶åˆ‡æ›ï¼‰ã€‚</li>
                                        <li>å°è¶…é•·æ®µè½åšäºŒæ¬¡åˆ‡åˆ†ï¼ˆtoken overflow segment splitï¼‰ï¼Œé¿å…å–®å¡Šè¶…éä¸Šé™ã€‚</li>
                                        <li>é€ chunk æŠ½å–ä¸¦å¯«å…¥ KGï¼Œæ­é… <code>chunk_limit</code>/<code>INGEST_CHUNK_LIMIT</code> æ§åˆ¶å–®æ¬¡è™•ç†é‡ï¼Œé™ä½ OOM èˆ‡é•·è«‹æ±‚å¤±æ•—ç‡ã€‚</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </section>

            <section id="section-3">
                <h2>3. Domain Knowledge Graph å»ºç«‹è©³ç´°èªªæ˜</h2>

                <div id="section-3-step">
                    <h3>æ­¥é©Ÿèªªæ˜</h3>
                    <ul>
                        <li><strong>æ•¸æ“šä¾†æº</strong>: ä»¥ä¼æ¥­è²¡å‹™å ±å‘Š (Financial Reports) èˆ‡æ–°èç¨¿ç‚ºä¸»è¦ç¤ºä¾‹ï¼ˆç¯„ä¾‹ï¼šé´»æµ·ã€å°ç©é›»ï¼‰ï¼›å¯¦ä½œä¸Šå¯è™•ç†ä¸€èˆ¬ text/url/keyword ä¾†æºã€‚</li>
                        <li><strong>Graph DB</strong>: é¸æ“‡ <strong>Neo4j (Community Edition v5)</strong>ã€‚</li>
                        <li><strong>å»ºç½®æµç¨‹</strong>: ä½¿ç”¨ <code>backend/llm_kg/kg_builder.py</code> é€²è¡Œè‡ªå‹•åŒ–å»ºç½®ã€‚</li>
                        <li><strong>å¤§æª”è™•ç†ç­–ç•¥</strong>: ç”± <code>backend/logic.py</code> ä½œ facade è½‰ç™¼ï¼Œå¯¦éš›åœ¨ <code>backend/services/ingest/service.py</code> å…ˆåš chunkingï¼ˆtoken/char budgetï¼‰ï¼Œå†é€å¡Šå‘¼å« <code>backend/llm_kg/kg_builder.py</code> æŠ½å–èˆ‡ upsertï¼Œé¿å…å–®æ¬¡å¤§ä¸Šä¸‹æ–‡é€ æˆ OOMã€‚</li>
                    </ul>
                </div>

                <div id="section-3-0">
                    <h3>(0) å¯¦ä½œå°æ‡‰ï¼šå¯¦é«”/é—œä¿‚æŠ½å–èˆ‡ Neo4j å¯«å…¥</h3>
                    <ul>
                        <li><strong>æŠ½å–æ¡†æ¶</strong>: æœ¬å°ˆæ¡ˆä¸æ˜¯ä½¿ç”¨å‚³çµ± NER/RE å¥—ä»¶ï¼ˆå¦‚ spaCy stanzaï¼‰åšè¦å‰‡å¼æŠ½å–ï¼Œè€Œæ˜¯æ¡ç”¨ <code>backend/llm_kg/kg_builder.py</code> çš„ <strong>LLM JSON æŠ½å–æµç¨‹</strong>ã€‚</li>
                        <li><strong>LLM å‘¼å«å±¤</strong>: ä½¿ç”¨è‡ªå»º <code>backend/llm_kg/llm_client.py</code>ï¼ˆåº•å±¤å¥—ä»¶ç‚º <code>requests</code>ï¼‰çµ±ä¸€å‘¼å« <code>openai-compatible / ollama / gemini</code>ï¼Œå†ç”± Prompt ç´„æŸè¼¸å‡ºå›ºå®š JSON çµæ§‹ã€‚</li>
                        <li><strong>æŠ½å–ç­–ç•¥</strong>:
                            <ul>
                                <li>é è¨­ Single-passï¼šä¸€æ¬¡è¼¸å‡º <code>entities + relations</code>ã€‚</li>
                                <li>Gemini å¯å•Ÿç”¨ Two-passï¼ˆ<code>GEMINI_TWO_PASS_EXTRACTION=1</code>ï¼‰ï¼šå…ˆå¯¦é«”ç›¤é»ï¼Œå†ä»¥ seed entities æŠ½é—œä¿‚ï¼Œä¸¦å…ˆè£œé½Š KG ç¼ºæ¼å¯¦é«”å¾Œå†åšç¬¬äºŒéšæ®µé—œä¿‚æŠ½å–ã€‚</li>
                                <li>è§£æå¤±æ•—æ™‚æœ‰ Retry & Repairï¼ˆé è¨­ç¸½å˜—è©¦ 5 æ¬¡ï¼Œå¯ç”± <code>EXTRACTION_MAX_JSON_RETRIES</code> èª¿æ•´ï¼‰ä»¥ä¿®å¾© JSONã€‚</li>
                            </ul>
                        </li>
                        <li><strong>æŠ½å–å¾Œæ¸…æ´— (Post-processing)</strong>:
                            <ul>
                                <li>ä¾ç™½åå–®é™åˆ¶ entity/relation typeï¼ˆschema constraintsï¼‰ã€‚</li>
                                <li>åš alias/canonical name åˆä½µèˆ‡æ¨¡ç³Šæ¯”å°ï¼Œé™ä½åŒå¯¦é«”å¤šå¯«æ³•å•é¡Œã€‚</li>
                                <li>æª¢æŸ¥é—œä¿‚æ–¹å‘èˆ‡å‹åˆ¥æ˜¯å¦ç¬¦åˆ ontology è¦å‰‡ï¼›ä¸ç¬¦åˆè€…ç›´æ¥ä¸Ÿæ£„ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Neo4j å¯«å…¥æ–¹å¼</strong>ï¼ˆ<code>neo4j</code> Python driverï¼‰:
                            <ol>
                                <li><code>_ensure_constraints()</code>ï¼šå»ºç«‹å”¯ä¸€éµèˆ‡ç´¢å¼•ï¼ˆ<code>Entity.name</code> uniqueã€<code>normalizedName</code> indexï¼‰ã€‚</li>
                                <li><code>_create_entity()</code>ï¼šä½¿ç”¨ <code>MERGE</code> upsert ç¯€é»ï¼Œç¯€é»åŒæ™‚å¸¶æœ‰å…·é«” labelï¼ˆå¦‚ <code>:Organization</code>ï¼‰èˆ‡å…±é€š <code>:Entity</code>ã€‚</li>
                                <li><code>_create_relation()</code>ï¼šä½¿ç”¨ <code>MERGE (a)-[:REL]->(b)</code> upsert é—œä¿‚ã€‚</li>
                                <li><code>populate_graph()</code>ï¼šé€ç­†å¯«å…¥ entities/relationsï¼Œå›å‚³çµ±è¨ˆï¼ˆupsert æ•¸ã€drop æ•¸ã€json retriesï¼‰ã€‚</li>
                            </ol>
                            <ul>
                                <li><strong>ç‚ºä½•ä½¿ç”¨ <code>MERGE</code></strong>ï¼šç¢ºä¿å»ºåœ–æµç¨‹å…·å‚™ idempotentï¼ˆå¯é‡å…¥ï¼‰ç‰¹æ€§ã€‚ç›¸åŒè³‡æ–™åœ¨é‡è·‘ã€é‡è©¦æˆ– chunk é‡ç–Šæ™‚ï¼Œä¸æœƒé‡è¤‡å»ºç«‹åŒåå¯¦é«”èˆ‡åŒå‘é—œä¿‚ï¼›åªæœƒæ›´æ–°æ—¢æœ‰ç¯€é»/é—œä¿‚å±¬æ€§ï¼ˆå¦‚ <code>updatedAt</code>ã€<code>aliases</code>ï¼‰ï¼Œç¶­æŒåœ–è­œä¸€è‡´æ€§ã€‚</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div id="section-3-1">
                    <h3>(1) åˆ©ç”¨ LLM å»ºç«‹ Knowledge Graph</h3>
                    <ul>
                        <li><strong>æ–¹æ³•</strong>: æŠ½å–ç­–ç•¥ç‚ºã€Œé è¨­ <strong>Single-pass</strong>ï¼›åœ¨ <code>provider=gemini</code> ä¸” <code>GEMINI_TWO_PASS_EXTRACTION=1</code> æ™‚æ¡ç”¨ <strong>Two-Pass</strong>ã€ã€‚
                            <ul>
                                <li><strong>Two-Pass / Phase 1 (Entity Inventory)</strong>: å…ˆè®“ LLM æƒæå…¨æ–‡ï¼Œåˆ—å‡ºæ‰€æœ‰å¯¦é«” (Entities)ï¼Œé€²è¡Œæ¨™æº–åŒ– (Canonicalization)ã€‚</li>
                                <li><strong>Two-Pass / Phase 2 (Relation Extraction)</strong>: å°‡ç¬¬ä¸€éšæ®µçš„å¯¦é«”æ¸…å–®ä½œç‚º Context é¤µçµ¦ LLMï¼Œè¦æ±‚å…¶æ‰¾å‡ºå¯¦é«”é–“çš„é—œä¿‚ (Relations)ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±º</strong>:
                            <ul>
                                <li><strong>å¯¦é«”æ­§ç¾© (Entity Ambiguity)</strong>: åŒä¸€å…¬å¸æœ‰å¤šç¨®å¯«æ³• (e.g., "é´»æµ·", "Hon Hai", "Foxconn")ã€‚
                                    <ul>
                                        <li><strong>è§£æ±º</strong>: å¯¦ä½œ <code>_resolve_entity_reference</code> èˆ‡ <code>SequenceMatcher</code> æ¨¡ç³Šæ¯”å°ï¼Œå°‡åˆ¥åæ˜ å°„åˆ°å–®ä¸€æ¨™æº–åç¨± (Canonical Name)ã€‚</li>
                                    </ul>
                                </li>
                                <li><strong>å¹»è¦ºé—œä¿‚ (Hallucinated Relations)</strong>: LLM å‰µé€ ä¸å­˜åœ¨çš„é—œä¿‚é¡å‹ã€‚
                                    <ul>
                                        <li><strong>è§£æ±º</strong>: è¨­å®š <strong>Schema Constraints (Ontology)</strong>ï¼Œåƒ…å…è¨±ç‰¹å®šçš„ Node Labels (e.g., <code>Organization</code>, <code>Person</code>) èˆ‡ Relation Types (e.g., <code>FOUNDED_BY</code>, <code>SUPPLIES_TO</code>)ï¼Œéæ¿¾æ‰ä¸ç¬¦åˆ Schema çš„è¼¸å‡ºã€‚</li>
                                    </ul>
                                </li>
                                <li><strong>é—œä¿‚ç™½åå–®ï¼ˆSchema Constraintsï¼‰ç­–ç•¥è©•ä¼°</strong>:
                                    <ul>
                                        <li><strong>å¥½è™• (Pros)</strong>:
                                            <ul>
                                                <li><strong>æé«˜æº–ç¢ºç‡ (Precision)</strong>ï¼šå¯ç›´æ¥éæ¿¾ä¸åœ¨æœ¬é«”ä¸­çš„é—œä¿‚é¡å‹ï¼Œé™ä½ LLM å¹»è¦ºé—œä¿‚é€²å…¥ KG çš„æ©Ÿç‡ã€‚</li>
                                                <li><strong>æŸ¥è©¢ç©©å®šæ€§æ›´é«˜</strong>ï¼šNL2Cypher åƒ…éœ€é¢å°æœ‰é™ä¸”å·²å®šç¾©çš„é—œä¿‚é›†åˆï¼Œè¼ƒä¸æ˜“å‡ºç¾èªæ„æ¼‚ç§»èˆ‡éŒ¯æŸ¥ã€‚</li>
                                                <li><strong>æ²»ç†èˆ‡æ¸¬è©¦æˆæœ¬å¯æ§</strong>ï¼šé—œä¿‚é›†åˆå›ºå®šå¾Œï¼Œå›æ­¸æ¸¬è©¦ã€ç›£æ§æŒ‡æ¨™ï¼ˆå¦‚ <code>dropped_relations</code>ï¼‰èˆ‡ç¨½æ ¸æµç¨‹æ›´å®¹æ˜“è½åœ°ã€‚</li>
                                            </ul>
                                        </li>
                                        <li><strong>ç¼ºé» (Cons)</strong>:
                                            <ul>
                                                <li><strong>å¬å›ç‡ (Recall) ä¸‹é™</strong>ï¼šæ–°å‡ºç¾æˆ–é•·å°¾é—œä¿‚å¯èƒ½è¢«ç›´æ¥ä¸Ÿæ£„ï¼Œé€ æˆçŸ¥è­˜è¦†è“‹ä¸è¶³ã€‚</li>
                                                <li><strong>ç¶­è­·æˆæœ¬ä¸Šå‡</strong>ï¼šæ¯æ¬¡æ–°å¢æ¥­å‹™èªæ„éƒ½éœ€åŒæ­¥èª¿æ•´ ontology/prompt/æ¸¬è©¦ï¼Œç‰ˆæœ¬æ¼”é€²é€Ÿåº¦è¼ƒæ…¢ã€‚</li>
                                                <li><strong>æ¢ç´¢èƒ½åŠ›å—é™</strong>ï¼šç³»çµ±åå‘æ—¢æœ‰é—œä¿‚ï¼Œè¼ƒä¸åˆ©æ–¼æ—©æœŸç™¼æ˜æ–°é—œè¯ï¼›å»ºè­°æ­é…å€™é¸é—œä¿‚æš«å­˜æ± ä½œè£œå¼·ã€‚</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div id="section-3-2">
                    <h3>(2) ä½¿ç”¨è€…å•é¡Œè½‰ Graph DB æŸ¥è©¢ (NL2Cypher)</h3>
                    <ul>
                        <li><strong>æ–¹æ³•</strong>: <code>backend/llm_kg/nl2cypher.py</code> æä¾›å…©ç¨®å¼•æ“ï¼Œä¸¦ç”± <code>query_engine</code> æ§åˆ¶åŸ·è¡Œè·¯å¾‘ï¼š
                            <ul>
                                <li><strong>Path A (GraphCypherQAChain / Sync)</strong>: ä½¿ç”¨ <code>GraphCypherQAChain + Neo4jGraph</code> å®Œæˆ NL -> Cypher -> Query -> Answerï¼›å·²æ¥å…¥ <code>POST /api/query</code>ï¼ˆ<code>query_engine=graph_chain</code>ï¼‰ï¼Œæ”¯æ´ <code>ollama</code> èˆ‡ <code>gemini</code> providerï¼ˆ<code>backend/llm_kg/nl2cypher.py:1041</code>ã€<code>backend/llm_kg/nl2cypher.py:1062</code>ã€<code>backend/llm_kg/nl2cypher.py:1070</code>ï¼‰ã€‚</li>
                                <li><strong>Path B (Manual/Agentic)</strong>: ä½¿ç”¨å¯é…ç½®æ¨¡å‹æ­é… Schema-aware prompt èˆ‡å¤šè¼ª agentic loopï¼›ç¶­æŒé è¨­æ¨¡å¼ï¼ˆ<code>query_engine=manual</code>ï¼‰ã€‚</li>
                                <li><strong>Path B å¯¦éš›åŸ·è¡Œéˆ</strong>: <code>planner -> reactor -> link_entity_literals -> execute (å«å¿…è¦æ™‚æ”¾å¯¬çµ„ç¹”åç¨± exact match) -> critic</code>ï¼›è‹¥ verdict ç‚º <code>replan</code> å‰‡é€² <code>replanner</code> é€²å…¥ä¸‹ä¸€è¼ªã€‚å¦ä¿ç•™ repeated-cypher é˜²å‘†èˆ‡ <code>max rounds</code> ä¸Šé™ã€‚</li>
                                <li><strong>ç‚ºä½•é è¨­ <code>manual</code></strong>: æ­¤è·¯å¾‘æ”¯æ´ async é€²åº¦äº‹ä»¶ï¼ˆ<code>agentic_progress</code>ï¼‰ã€å¤±æ•—éˆè¿½è¹¤ï¼ˆ<code>failure_chain</code>ï¼‰ã€ä»¥åŠé‡è©¦è€—ç›¡å¾Œçš„å¤±æ•—å¿«ç…§ä¿ç•™èˆ‡é™¤éŒ¯è³‡è¨Šï¼Œè¼ƒé©åˆé•·ä»»å‹™èˆ‡é™¤éŒ¯ï¼ˆ<code>backend/api/routers/qa.py:142</code>ã€<code>backend/llm_kg/nl2cypher.py:1777</code>ã€<code>backend/llm_kg/nl2cypher.py:2006</code>ï¼‰ã€‚</li>
                                <li><strong>åŒæ­¥/éåŒæ­¥é‚Šç•Œ</strong>: <code>GraphCypherQAChain</code> åƒ…æ”¯æ´åŒæ­¥ <code>/api/query</code>ï¼›è‹¥é€åˆ° <code>/api/query_async/start</code> æœƒç›´æ¥å› <code>400</code>ï¼ˆ<code>backend/api/routers/qa.py:116</code>ï¼‰ã€‚</li>
                                <li><strong>é‚Šç•Œè¨­è¨ˆåŸå› </strong>: async è·¯å¾‘ä¾è³´å¯å›å‚³éšæ®µäº‹ä»¶çš„ callbackï¼›<code>graph_chain</code> åˆ†æ”¯åœ¨ service å±¤æ˜ç¢ºä¸æ¥å— async callbackï¼Œå› æ­¤åœ¨ router æå‰é˜»æ“‹ï¼Œé¿å…å»ºç«‹å¾Œå¿…å®šå¤±æ•—çš„ jobï¼ˆ<code>backend/services/qa/service.py:355</code>ã€<code>backend/services/qa/service.py:356</code>ï¼‰ã€‚</li>
                                <li><strong>é¸æ“‡å»ºè­°</strong>: éœ€è¦å–®æ¬¡å¿«é€Ÿå•ç­”å¯ç”¨ <code>graph_chain</code>ï¼ˆsync onlyï¼‰ï¼›éœ€è¦å¯è§€æ¸¬çš„å¤šè¼ªä¿®å¾©ã€é•·æŸ¥è©¢é€²åº¦èˆ‡é‡è©¦æ§åˆ¶æ™‚ç”¨ <code>manual</code>ï¼ˆsync/async çš†å¯ï¼‰ã€‚</li>
                                <li><strong>å‰ç«¯æ¨¡å¼å°æ‡‰</strong>: KG Chat å·²æ–°å¢ Execution Mode ä¸‹æ‹‰ï¼Œæä¾› <code>Agentic Async (Manual)</code> èˆ‡ <code>GraphCypherQAChain (Sync)</code> å…©ç¨®é¸æ“‡ï¼ˆ<code>frontend/src/components/Chat.tsx:261</code>ã€<code>frontend/src/components/Chat.tsx:269</code>ï¼‰ã€‚</li>
                                <li><strong>å›æ‡‰ç›¸å®¹æ€§</strong>: GraphChain è·¯å¾‘ç¶­æŒ <code>question/cypher/rows/answer</code>ï¼Œä¸¦é™„åŠ  <code>query_engine</code>ã€<code>graph_chain_raw</code>ã€<code>engine_provider</code>ã€<code>engine_model</code>ï¼ˆ<code>backend/services/qa/service.py:370</code>-<code>backend/services/qa/service.py:390</code>ï¼‰ã€‚</li>
                            </ul>
                        </li>
                    </ul>

                    <h4>ç›®å‰ <code>GraphCypherQAChain</code> åˆå§‹åŒ–åƒæ•¸ï¼ˆç¾æ³ï¼‰</h4>
                    <ul>
                        <li><strong>Chain å»ºç«‹</strong>: <code>GraphCypherQAChain.from_llm(llm=..., graph=..., verbose=True, return_intermediate_steps=True, allow_dangerous_requests=True)</code>ï¼ˆ<code>backend/llm_kg/nl2cypher.py:1085</code>-<code>backend/llm_kg/nl2cypher.py:1091</code>ï¼‰ã€‚</li>
                        <li><strong>Ollama LLM</strong>: <code>Ollama(model=resolved_model, temperature=0, base_url=cfg.ollama_base_url)</code>ï¼ˆ<code>backend/llm_kg/nl2cypher.py:1065</code>-<code>backend/llm_kg/nl2cypher.py:1069</code>ï¼‰ã€‚</li>
                        <li><strong>Gemini LLM</strong>: <code>ChatGoogleGenerativeAI(model=resolved_model, temperature=0, google_api_key=cfg.gemini_api_key)</code>ï¼ˆ<code>backend/llm_kg/nl2cypher.py:1077</code>-<code>backend/llm_kg/nl2cypher.py:1081</code>ï¼‰ã€‚</li>
                        <li><strong>ç›®å‰æœªè¨­å®š</strong>: <code>top_k</code>ã€<code>return_direct</code>ã€<code>validate_cypher</code>ã€<code>include_types</code>ã€<code>exclude_types</code>ã€<code>use_function_response</code>ã€‚</li>
                    </ul>

                    <h4>ç‚ºä½•ç›®å‰æœªé–‹å•Ÿ <code>validate_cypher=True</code></h4>
                    <ul>
                        <li><strong>ç­–ç•¥é¸æ“‡</strong>: GraphChain è·¯å¾‘ç›®å‰æ¡ã€Œå¤±æ•—ç›´æ¥å›éŒ¯ï¼Œä¸è‡ªå‹• fallbackã€ï¼›ä¿ç•™åŸå§‹éŒ¯èª¤å°é™¤éŒ¯æ›´ç›´æ¥ã€‚</li>
                        <li><strong>Manual ç¾æ³</strong>: Manual/Agentic ä¸»è·¯å¾‘ä»¥ <code>critic/replanner</code> è¿´åœˆé©…å‹•ä¿®æ­£ï¼Œä¸¦æ­é… repeated-cypher é˜²å‘†èˆ‡ <code>max rounds</code>ï¼Œä¸ä¾è³´ deterministic relation gateã€‚</li>
                        <li><strong>å¾ŒçºŒæ“´å……</strong>: è‹¥è¦å•Ÿç”¨ <code>validate_cypher</code>ï¼Œå»ºè­°æ”¹æˆå¯é…ç½®æ——æ¨™ï¼Œä¸¦ä»¥ A/B æ¸¬è©¦è©•ä¼°å°æˆåŠŸç‡èˆ‡å»¶é²çš„å½±éŸ¿å¾Œå†é è¨­æ‰“é–‹ã€‚</li>
                    </ul>

                    <h4>ä½¿ç”¨ <code>GraphCypherQAChain</code> çš„å¥½è™•ï¼ˆå®˜æ–¹æ–‡ä»¶å°æ‡‰ï¼‰</h4>
                    <ul>
                        <li><strong>[ç¾æ³å·²ç”¨] ç«¯åˆ°ç«¯æµç¨‹å…§å»º</strong>ï¼š<code>GraphCypherQAChain</code> å¯ç›´æ¥å®Œæˆã€Œè‡ªç„¶èªè¨€å•é¡Œ -> ç”¢ç”Ÿ Cypher -> æŸ¥ Neo4j -> ç”Ÿæˆç­”æ¡ˆã€ï¼Œç›®å‰å·²æ¥å…¥åŒæ­¥ API è·¯å¾‘ã€‚</li>
                        <li><strong>[ç¾æ³å·²ç”¨] Provider å¯åˆ‡æ›</strong>ï¼šç›®å‰åŒä¸€æ¢ GraphChain è·¯å¾‘å¯åˆ‡æ› <code>ollama</code> / <code>gemini</code>ï¼Œä¸¦æ”¯æ´ model overrideã€‚</li>
                        <li><strong>[ç¾æ³å·²ç”¨] å¯è§€æ¸¬æ€§é«˜ï¼Œä¾¿æ–¼é™¤éŒ¯</strong>ï¼šå·²è¨­å®š <code>return_intermediate_steps=True</code>ï¼Œå¯å–å¾—ä¸­é–“ç”¢ç‰©ï¼ˆç”Ÿæˆ Cypher èˆ‡æŸ¥è©¢ contextï¼‰ä¾›é™¤éŒ¯èˆ‡ç¨½æ ¸ï¼ˆ<code>backend/llm_kg/nl2cypher.py:1089</code>ï¼‰ã€‚</li>
                        <li><strong>[å®˜æ–¹å¯ç”¨ï¼Œæœ¬å°ˆæ¡ˆæœªå•Ÿç”¨] Schema å°å‘ç”Ÿæˆ Cypher</strong>ï¼šå¯é…åˆ <code>Neo4jGraph.refresh_schema()</code> èˆ‡ <code>enhanced_schema=True</code>ï¼Œé™ä½ä¸å­˜åœ¨ label/property/relationship çš„ç”Ÿæˆé¢¨éšªï¼›ç›®å‰æœªå•Ÿç”¨ã€‚</li>
                        <li><strong>[å®˜æ–¹å¯ç”¨ï¼Œæœ¬å°ˆæ¡ˆæœªå•Ÿç”¨] çµæœå¯æ§</strong>ï¼š<code>top_k</code>ã€<code>return_direct=True</code> å¯é™åˆ¶è³‡æ–™é‡èˆ‡è¼¸å‡ºå‹æ…‹ï¼›ç›®å‰æœªè¨­å®šã€‚</li>
                        <li><strong>[å®˜æ–¹å¯ç”¨ï¼Œæœ¬å°ˆæ¡ˆæœªå•Ÿç”¨] å¯å®¢è£½ Cypher ç”Ÿæˆå“è³ª</strong>ï¼šå¯é€é <code>cypher_prompt</code> æ³¨å…¥ few-shotï¼Œæˆ–åˆ†é›¢ <code>cypher_llm</code> / <code>qa_llm</code> åšä»»å‹™åˆ†å·¥ï¼›ç›®å‰æœªé…ç½®ã€‚</li>
                        <li><strong>[æœ¬å°ˆæ¡ˆåˆ»æ„æœªå•Ÿç”¨] é—œä¿‚æ–¹å‘é©—è­‰/ä¿®æ­£</strong>ï¼šå®˜æ–¹å¯ç”¨ <code>validate_cypher=True</code>ï¼Œç›®å‰ä¿ç•™ fail-fast è¡Œç‚ºï¼Œé¿å…éš±æ€§ä¿®æ­£å°è‡´å¯è§€æ¸¬æ€§ä¸‹é™ã€‚</li>
                        <li><strong>[å®˜æ–¹å¯ç”¨ï¼Œæœ¬å°ˆæ¡ˆæœªå•Ÿç”¨] function/tool response</strong>ï¼š<code>use_function_response=True</code> å¯æå‡ç­”æ¡ˆèˆ‡è³‡æ–™åˆ—ä¸€è‡´æ€§ï¼›ç›®å‰æœªå•Ÿç”¨ã€‚</li>
                        <li><strong>[ç¾æ³å·²ç”¨] é¢¨éšªæ˜ç¤ºåŒæ„</strong>ï¼šç›®å‰ <code>query_with_graph_chain</code> å·²é¡¯å¼è¨­å®š <code>allow_dangerous_requests=True</code>ï¼ˆ<code>backend/llm_kg/nl2cypher.py:1090</code>ï¼‰ã€‚</li>
                    </ul>

                    <h4>å¸¸è¦‹èª¤è§£æ¾„æ¸…ï¼ˆæ–°ç‰ˆç”¨èªï¼‰</h4>
                    <ul>
                        <li><strong><code>GraphCypherQAChain</code> èˆ‡ <code>Neo4jGraph</code> åŠŸèƒ½åˆ†å±¤ä¸åŒ</strong>ï¼šå‰è€…è² è²¬ NL -> Cypher -> Query -> QA ç·¨æ’ï¼›å¾Œè€…è² è²¬åœ–é€£ç·šèˆ‡ schema æä¾›ã€‚</li>
                        <li><strong><code>refresh_schema()</code> / <code>enhanced_schema</code> å±¬æ–¼ <code>Neo4jGraph</code></strong>ï¼šä¸æ˜¯ <code>GraphCypherQAChain</code> æœ¬èº«çš„æ–¹æ³•ã€‚</li>
                        <li><strong>æœ¬å°ˆæ¡ˆç¾æ³</strong>ï¼šGraphChain å·²æ¥ <code>/api/query</code> åŒæ­¥æ¨¡å¼ï¼›<code>/api/query_async/*</code> åƒ…æ”¯æ´ Manual/Agenticã€‚</li>
                    </ul>

                    <p><strong>å®˜æ–¹ä¾†æºï¼ˆLangChainï¼Œæœ€æ–°ç‰ˆï¼‰</strong></p>
                    <ol>
                        <li>Neo4j provider integrationï¼š<a href="https://docs.langchain.com/oss/python/integrations/providers/neo4j" target="_blank">https://docs.langchain.com/oss/python/integrations/providers/neo4j</a></li>
                        <li>Neo4j graph/cypher integrationï¼š<a href="https://docs.langchain.com/oss/python/integrations/graphs/neo4j_cypher" target="_blank">https://docs.langchain.com/oss/python/integrations/graphs/neo4j_cypher</a></li>
                        <li>LangChain Securityï¼š<a href="https://docs.langchain.com/oss/python/security-policy" target="_blank">https://docs.langchain.com/oss/python/security-policy</a></li>
                    </ol>

                    <p><strong>Legacy åƒè€ƒï¼ˆå°ç…§ç›®å‰ <code>langchain_community</code> åŒ¯å…¥è·¯å¾‘ï¼‰</strong></p>
                    <ol>
                        <li>GraphCypherQAChain API Referenceï¼ˆcommunityï¼‰ï¼š<a href="https://api.python.langchain.com/en/latest/community/chains/langchain_community.chains.graph_qa.cypher.GraphCypherQAChain.html" target="_blank">https://api.python.langchain.com/en/latest/community/chains/langchain_community.chains.graph_qa.cypher.GraphCypherQAChain.html</a></li>
                    </ol>

                    <blockquote>å®‰å…¨è¨»è¨˜ï¼ˆå®˜æ–¹ + ç¾æ³ï¼‰ï¼š<code>GraphCypherQAChain</code> éœ€æ˜ç¢º <code>allow_dangerous_requests=True</code> æ‰å¯åŸ·è¡Œï¼Œä¸”å®˜æ–¹è¦æ±‚è³‡æ–™åº«å¸³è™Ÿå¿…é ˆä½¿ç”¨æœ€å°æ¬Šé™ï¼ˆnarrowly-scoped credentialsï¼‰ã€‚æœ¬å°ˆæ¡ˆç›®å‰åœ¨ <code>query_with_graph_chain</code> å·²é¡¯å¼è¨­å®šæ­¤åƒæ•¸ï¼ˆ<code>backend/llm_kg/nl2cypher.py:1090</code>ï¼‰ã€‚</blockquote>

                </div>

                <div id="section-3-3">
                    <h3>(3) é¸æ“‡ Neo4j çš„åŸå› èˆ‡æ¯”è¼ƒ</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>åœ–è³‡æ–™åº« (Graph DB)</th>
                                    <th>ç‰¹é»èˆ‡å„ªå‹¢ (Pros)</th>
                                    <th>åŠ£å‹¢èˆ‡é™åˆ¶ (Cons)</th>
                                    <th>æœ¬å°ˆæ¡ˆé©ç”¨æ€§åˆ†æ (Verdict)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Neo4j</strong> (æœ¬å°ˆæ¡ˆæ¡ç”¨)</td>
                                    <td>1. <strong>æˆç†Ÿåº¦é«˜</strong>ï¼šå¸‚å ´ä½”æœ‰ç‡æœ€é«˜ï¼Œç¤¾ç¾¤è³‡æºæœ€è±å¯Œã€‚<br>2. <strong>æŸ¥è©¢èªè¨€</strong>ï¼šCypher ç›´è§€ä¸”é¡ä¼¼ SQLï¼Œæ˜“æ–¼ LLM å­¸ç¿’èˆ‡ç”Ÿæˆã€‚<br>3. <strong>è¦–è¦ºåŒ–å¼·</strong>ï¼šå…§å»º Neo4j Browser èˆ‡ Bloomï¼Œæ–¹ä¾¿é™¤éŒ¯ã€‚</td>
                                    <td>å¤§è¦æ¨¡åˆ†æ•£å¼é‹ç®—éœ€ä¼æ¥­ç‰ˆæ”¯æ´ï¼›å¯«å…¥ååé‡åœ¨æ¥µç«¯å ´æ™¯ä¸‹å¯èƒ½ä¸å¦‚å°ˆé–€çš„åˆ†æ•£å¼åœ–è³‡æ–™åº«ã€‚</td>
                                    <td><strong>æœ€ä½³é¸æ“‡</strong><br>é©åˆæœ¬å°ˆæ¡ˆçš„ä¸­å°å‹è¦æ¨¡ï¼ŒDocker éƒ¨ç½²ç°¡å–®ï¼Œä¸” Cypher å° LLM æœ€å‹å–„ã€‚</td>
                                </tr>
                                <tr>
                                    <td><strong>TigerGraph</strong></td>
                                    <td><strong>åˆ†æ•£å¼é‹ç®—å¼·</strong>ï¼šé©åˆè¶…å¤§è¦æ¨¡ (TBç´š) æ•¸æ“šåˆ†æã€‚</td>
                                    <td><strong>å­¸ç¿’æ›²ç·šé™¡</strong>ï¼šGSQL è¼ƒè¤‡é›œã€‚<br><strong>ç¤¾ç¾¤ç‰ˆé™åˆ¶</strong>ï¼šåŠŸèƒ½èˆ‡é™åˆ¶è¼ƒå¤šã€‚</td>
                                    <td><strong>ä¸é©åˆ</strong><br>æœ¬å°ˆæ¡ˆè¦æ¨¡æœªé” TB ç´šï¼Œä¸” Neo4j å°æ–¼ä¸­å°å‹è¦æ¨¡æ›´æ˜“æ–¼ä¸Šæ‰‹èˆ‡éƒ¨ç½²ã€‚</td>
                                </tr>
                                <tr>
                                    <td><strong>ArangoDB</strong></td>
                                    <td><strong>å¤šæ¨¡è³‡æ–™åº« (Multi-model)</strong>ï¼šåŒæ™‚æ”¯æ´ Document, Key-Value, Graphï¼Œéˆæ´»æ€§é«˜ã€‚</td>
                                    <td><strong>éåŸç”Ÿåœ–è³‡æ–™åº«</strong>ï¼šåœ¨ç´”åœ–æ¼”ç®—æ³•èˆ‡æ·±åº¦éæ­·æ•ˆèƒ½ä¸Šé€šå¸¸ä¸å¦‚åŸç”Ÿçš„ Neo4jã€‚</td>
                                    <td><strong>ä¸é©åˆ</strong><br>æœ¬å°ˆæ¡ˆå°ˆæ³¨æ–¼è¤‡é›œé—œä¿‚éˆæŸ¥è©¢ï¼ŒåŸç”Ÿåœ–è³‡æ–™åº« (Native Graph DB) è¼ƒç‚ºåˆé©ã€‚</td>
                                </tr>
                                <tr>
                                    <td><strong>NebulaGraph</strong></td>
                                    <td><strong>å¯«å…¥ååé‡é«˜</strong>ï¼šé‡å°æµ·é‡æ•¸æ“šè¨­è¨ˆçš„é–‹æºåˆ†ä½ˆå¼åœ–è³‡æ–™åº«ã€‚</td>
                                    <td><strong>éƒ¨ç½²è¤‡é›œ</strong>ï¼šåœ¨å–®æ©Ÿé–‹ç™¼ç’°å¢ƒçš„è¼•é‡ç´šéƒ¨ç½²ä¸Šï¼Œé…ç½®è¼ƒ Neo4j ç¹ç‘£ã€‚</td>
                                    <td><strong>å‚™é¸</strong><br>Docker ç‰ˆçš„ Neo4j é…ç½®è¼ƒç‚ºç°¡å–®ï¼Œç¬¦åˆç›®å‰å¿«é€Ÿé–‹ç™¼éœ€æ±‚ã€‚</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p><em>è¨»</em>ï¼šæœ¬ç¯€æ¯”è¼ƒå±¬æŠ€è¡“é¸å‹è©•ä¼°ï¼Œå¸‚å ´èˆ‡æ•ˆèƒ½æŒ‡æ¨™ç‚ºå¤–éƒ¨è³‡è¨Šï¼Œéæœ¬ repo å…§å¯ç›´æ¥é©—è­‰é …ç›®ã€‚</p>
                </div>

                <div id="section-3-4">
                    <h3>(4) è©³ç´°æµç¨‹åœ–ï¼ˆå»ºåœ– + æŸ¥è©¢å…¨æµç¨‹ï¼‰</h3>
                    <p>ä»¥ä¸‹é‡æ§‹ç‚ºå…­å¼µåˆ†å±¤æµç¨‹åœ–ï¼šå®Œæ•´è¦†è“‹ ingest çš„åŒæ­¥/éåŒæ­¥è·¯å¾‘ï¼›æŸ¥è©¢é¢åŒæ™‚æ¶µè“‹ <code>Agentic Async (Manual)</code> èˆ‡ <code>GraphCypherQAChain (Sync)</code>ï¼Œä¸¦è£œä¸Š manual è·¯å¾‘å…±ç”¨å›ç­”å¾Œè™•ç†ï¼ˆé»æ“Šæ¨™é¡Œå±•é–‹æŸ¥çœ‹ï¼Œå…§å«è©³ç´°æµç¨‹èªªæ˜ï¼‰ã€‚</p>

                    <!-- åœ– Aï¼šIngest API èˆ‡ä»»å‹™å”èª¿ç¸½è¦½ -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Aï¼šIngest API èˆ‡åŒæ­¥/éåŒæ­¥ä»»å‹™å”èª¿ç¸½è¦½</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    subgraph API["APIï½œå…¥å£èˆ‡æŸ¥è©¢"]
        A1[POST api process textï½œåŒæ­¥æ–‡å­—å»ºåœ–è«‹æ±‚å…¥å£]
        A2[POST api process urlï½œåŒæ­¥ç¶²å€å»ºåœ–è«‹æ±‚å…¥å£]
        A3[POST api process keywordï½œåŒæ­¥é—œéµå­—å»ºåœ–è«‹æ±‚å…¥å£]
        A4[POST api process text async startï½œéåŒæ­¥æ–‡å­—å»ºåœ–å•Ÿå‹•å…¥å£]
        A5[POST api process url async startï½œéåŒæ­¥ç¶²å€å»ºåœ–å•Ÿå‹•å…¥å£]
        A6[POST api process keyword async startï½œéåŒæ­¥é—œéµå­—å»ºåœ–å•Ÿå‹•å…¥å£]
        A7[GET api process text async by job idï½œéåŒæ­¥æ–‡å­—å»ºåœ–ç‹€æ…‹æŸ¥è©¢]
        A8[GET api process url async by job idï½œéåŒæ­¥ç¶²å€å»ºåœ–ç‹€æ…‹æŸ¥è©¢]
        A9[GET api process keyword async by job idï½œéåŒæ­¥é—œéµå­—å»ºåœ–ç‹€æ…‹æŸ¥è©¢]
    end

    subgraph JOB["JOBï½œå»ºç«‹èˆ‡å›å¯«"]
        B1[create job in ingest or keyword storeï½œå»ºç«‹ ingest æˆ– keyword job ç´€éŒ„]
        B2[run worker threadï½œèƒŒæ™¯åŸ·è¡Œç·’è™•ç†ä½œæ¥­]
        B3[update progress result errorï½œæ›´æ–°é€²åº¦èˆ‡çµæœéŒ¯èª¤]
        B4[get job by idï½œä¾ job id è®€å–ç‹€æ…‹]
    end

    subgraph PIPE["PIPEï½œå»ºåœ–ä¸»éˆ"]
        C1[logic process to kg facadeï½œlogic facade è½‰ç™¼å»ºåœ–]
        C2[ingest service process to kgï½œingest service ä¸»æµç¨‹]
        C3[build kg from chunksï½œé€ chunk å»ºåœ–è™•ç†]
        C4[chunk update callbackï½œchunk é€²åº¦å›å‘¼ä¸Šå ±]
        C5[result stats summary chunk progressï½œçµ±è¨ˆèˆ‡é€²åº¦æ‘˜è¦è¼¸å‡º]
    end

    A1 --> C1
    A2 --> C1
    A3 --> C1
    A4 --> B1
    A5 --> B1
    A6 --> B1
    B1 --> B2
    B2 --> C1
    C1 --> C2
    C2 --> C3
    C3 --> C5
    C3 --> C4
    C4 --> B3
    B3 --> A7
    B3 --> A8
    B3 --> A9
    A7 -.-> B4
    A8 -.-> B4
    A9 -.-> B4
    B4 --> A7
    B4 --> A8
    B4 --> A9
</div>
                            <div class="diagram-detail">
                                <ol>
                                    <li>åŒæ­¥å…¥å£ï¼ˆtext/url/keywordï¼‰æœƒç›´æ¥é€²å…¥ <code>logic facade</code>ï¼Œç«‹åˆ»åŸ·è¡Œå»ºåœ–æµç¨‹ã€‚</li>
                                    <li>éåŒæ­¥å…¥å£æœƒå…ˆå»ºç«‹ jobï¼ˆ<code>ingest_job_store</code> / <code>keyword_job_store</code>ï¼‰ä¸¦ç«‹å³å›å‚³ <code>job_id</code>ï¼Œè®“å‰ç«¯å¯å…ˆå–å¾—è¿½è¹¤è­˜åˆ¥ã€‚</li>
                                    <li>èƒŒæ™¯ worker å–å‡º job å¾Œï¼Œé–‹å§‹å‘¼å«å»ºåœ–ä¸»éˆåŸ·è¡Œå¯¦éš›è³‡æ–™è™•ç†ã€‚</li>
                                    <li><code>logic facade</code> è½‰ç™¼åˆ° ingest serviceï¼Œæ¥è‘—é€²å…¥ chunk åŒ–èˆ‡é€å¡Šå»ºåœ–ã€‚</li>
                                    <li>æ¯å€‹ chunk çš„è™•ç†çµæœæœƒé€é callback å›å¯«é€²åº¦ï¼ŒåŒ…å«ç›®å‰ç‹€æ…‹èˆ‡éŒ¯èª¤è³‡è¨Šã€‚</li>
                                    <li>å‰ç«¯ä½¿ç”¨ polling API ä¾ <code>job_id</code> æŒçºŒæŸ¥è©¢ï¼Œå–å¾—æœ€æ–°é€²åº¦èˆ‡ä¸­é–“ç‹€æ…‹ã€‚</li>
                                    <li>ä»»å‹™å®Œæˆå¾Œå›å‚³ <code>stats/summary/chunk_progress</code>ï¼Œä¾›ç•«é¢é¡¯ç¤ºæœ€çµ‚çµæœã€‚</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- åœ– Bï¼šå»ºåœ–ä¸»ç·š -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Bï¼šå»ºåœ–ä¸»ç·šï¼ˆChunk -> Extract -> Sanitize -> Upsertï¼‰</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    B0[logic process text url keyword to kgï½œå»ºåœ– facade å…¥å£]
    B1[service chunk text by token or charï½œä¾ token æˆ– char åˆ‡å¡Š]
    B2[resolve chunk limitï½œå¥—ç”¨ chunk_limit æ±ºç­–]
    B3[build kg from chunksï½œé€å¡Šå»ºåœ–ä¸»è¿´åœˆ]
    B4{more chunksï½œæ˜¯å¦ä»æœ‰æœªè™•ç†å¡Š}
    B5[extract entities and relationsï½œæŠ½å–å¯¦é«”èˆ‡é—œä¿‚]
    B6[sanitize extractionï½œæŠ½å–çµæœæ¸…æ´—å®ˆé–€]
    B7[populate graph ensure entity relationï½œupsert ç¯€é»èˆ‡é—œä¿‚]
    B8[aggregate stats and chunk statusï½œèšåˆçµ±è¨ˆèˆ‡ç‹€æ…‹]
    B9[emit chunk update callbackï½œé€å‡º chunk_update äº‹ä»¶]
    B10[return stats summary chunk progressï½œå›å‚³æœ€çµ‚çµ±è¨ˆé€²åº¦]

    B0 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> B4
    B4 -- yes/æ˜¯ --> B5
    B5 --> B6
    B6 --> B7
    B7 --> B8
    B8 --> B9
    B9 --> B4
    B4 -- no/å¦ --> B10
</div>
                            <div class="diagram-detail">
                                <ol>
                                    <li>æµç¨‹å…¥å£å¯æ¥æ”¶ text/url/keyword ä¸‰é¡ä¾†æºï¼Œçµ±ä¸€é€²å…¥å»ºåœ–ä¸»éˆã€‚</li>
                                    <li>ç³»çµ±å…ˆä¾ token æˆ– char ç­–ç•¥åˆ‡ chunkï¼Œç¢ºä¿é•·æ–‡èƒ½è¢«ç©©å®šåˆ†æ®µè™•ç†ã€‚</li>
                                    <li>åˆ‡å¡Šå¾Œå¥—ç”¨ request èˆ‡å…¨åŸŸ <code>chunk_limit</code>ï¼Œæ±ºå®šå¯è™•ç†çš„æœ€å¤§ chunk æ•¸é‡ã€‚</li>
                                    <li>é€²å…¥é€ chunk è¿´åœˆï¼Œé€ä¸€è™•ç†æ¯å€‹æœªå®Œæˆçš„æ–‡æœ¬å€å¡Šã€‚</li>
                                    <li>æ¯å€‹ chunk å…ˆåŸ·è¡Œ entities/relations æŠ½å–ï¼Œç”¢å‡ºå€™é¸çŸ¥è­˜è³‡æ–™ã€‚</li>
                                    <li>æŠ½å–çµæœé€²å…¥ sanitize å®ˆé–€ï¼Œéæ¿¾ä¸åˆæ³•æˆ–ä¸ä¸€è‡´çš„ç¯€é»èˆ‡é—œä¿‚ã€‚</li>
                                    <li>é€šéå®ˆé–€å¾ŒåŸ·è¡Œ upsertï¼Œå°‡ç¯€é»èˆ‡é—œä¿‚å¯«å…¥åœ–è³‡æ–™åº«ã€‚</li>
                                    <li>æ¯è¼ªæ›´æ–°éƒ½æœƒç´¯ç©çµ±è¨ˆè³‡æ–™ä¸¦é€å‡º <code>chunk_update</code> é€²åº¦äº‹ä»¶ã€‚</li>
                                    <li>ç•¶æ²’æœ‰å‰©é¤˜ chunk æ™‚ï¼Œè¼¸å‡ºæœ€çµ‚æ‘˜è¦èˆ‡å®Œæ•´é€²åº¦çµ±è¨ˆã€‚</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- åœ– Cï¼šæŠ½å–å…§æ ¸èˆ‡ Retry/Repair -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Cï¼šæŠ½å–å…§æ ¸ Retry/Repair èˆ‡ Two-pass åˆ†æ”¯</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    C0[extract entities relations entryï½œæŠ½å–æµç¨‹å…¥å£]
    C1{gemini two pass enabledï½œæ˜¯å¦å•Ÿç”¨ Gemini two-pass}
    C2[phase1 entity promptï½œç¬¬ä¸€éšæ®µå¯¦é«”ç›¤é»æç¤º]
    C3[retry json phase1ï½œç¬¬ä¸€éšæ®µ JSON é‡è©¦æŠ½å–]
    C4[fetch existing and prefill missingï½œè£œé½Šæ—¢æœ‰å¯¦é«”èˆ‡é å¡«]
    C5[phase2 relation promptï½œç¬¬äºŒéšæ®µé—œä¿‚æŠ½å–æç¤º]
    C6[retry json phase2ï½œç¬¬äºŒéšæ®µ JSON é‡è©¦æŠ½å–]
    C7[single pass promptï½œå–®éšæ®µæŠ½å–æç¤º]
    C8[retry json singleï½œå–®éšæ®µ JSON é‡è©¦æŠ½å–]
    C9[sanitize extractionï½œå¥—ç”¨ schema æ¸…æ´—å®ˆé–€]
    C10[output entities relations metaï½œè¼¸å‡º entities relations meta]

    subgraph RETRY["RETRYï½œJSONé‡è©¦"]
        R1[attempt loopï½œé‡è©¦å˜—è©¦è¿´åœˆ]
        R2{json modeï½œJSON æ¨¡å¼åˆ¤æ–·}
        R3[call chat json or textï½œå‘¼å« chat_json chat_text]
        R4{payload validï½œå…§å®¹æ˜¯å¦æœ‰æ•ˆ}
        R5[build repair promptï½œå»ºç«‹ repair prompt]
        R6[return payload with retriesï½œå›å‚³æœ‰æ•ˆ payload èˆ‡é‡è©¦è³‡è¨Š]
        R7[raise error at max retryï½œé”ä¸Šé™æ‹‹å‡ºéŒ¯èª¤]
        R1 --> R2
        R2 --> R3
        R3 --> R4
        R4 -- yes/æ˜¯ --> R6
        R4 -- no/å¦ --> R5
        R5 --> R1
        R1 -- max reached/é”é‡è©¦ä¸Šé™ --> R7
    end

    C0 --> C1
    C1 -- yes/æ˜¯ --> C2
    C2 --> C3
    C3 --> C4
    C4 --> C5
    C5 --> C6
    C1 -- no/å¦ --> C7
    C7 --> C8
    C6 --> C9
    C8 --> C9
    C9 --> C10
    C3 -.-> R1
    C6 -.-> R1
    C8 -.-> R1
</div>
                            <div class="diagram-detail">
                                <ol>
                                    <li>æŠ½å–æµç¨‹ç”±çµ±ä¸€å…¥å£é–‹å§‹ï¼Œå…ˆå»ºç«‹ç•¶å‰ provider èˆ‡æŠ½å–è¨­å®šä¸Šä¸‹æ–‡ã€‚</li>
                                    <li>ç³»çµ±åˆ¤æ–·æ˜¯å¦èµ° Gemini two-passï¼ˆéœ€æ»¿è¶³ provider èˆ‡ env æ¢ä»¶ï¼‰ã€‚</li>
                                    <li>two-pass ç¬¬ä¸€éšæ®µå…ˆåšå¯¦é«”ç›¤é»ï¼Œä¸¦èµ° JSON é‡è©¦/ä¿®å¾©å›åœˆç¢ºä¿æ ¼å¼å¯è§£æã€‚</li>
                                    <li>ç¬¬ä¸€éšæ®µå®Œæˆå¾Œæœƒè£œé½Šæ—¢æœ‰å¯¦é«”ï¼Œå†é€²å…¥ç¬¬äºŒéšæ®µé—œä¿‚æŠ½å–ã€‚</li>
                                    <li>è‹¥ä¸ç¬¦åˆ two-pass æ¢ä»¶ï¼Œç›´æ¥èµ° single-pass æŠ½å–èˆ‡ JSON é‡è©¦ã€‚</li>
                                    <li>é‡è©¦å›åœˆçµ±ä¸€åŸ·è¡Œã€Œå‘¼å«æ¨¡å‹ -> é©—è­‰ payload -> repair prompt -> å†é‡è©¦ã€ã€‚</li>
                                    <li>è‹¥é”é‡è©¦ä¸Šé™å‰‡æ‹‹éŒ¯ï¼›è‹¥æˆåŠŸå–å¾—æœ‰æ•ˆ payload å‰‡é€²å…¥ sanitizeã€‚</li>
                                    <li>æœ€çµ‚è¼¸å‡º <code>entities/relations/meta(retries)</code>ï¼Œä¾›å¾ŒçºŒå¯«åœ–èˆ‡çµ±è¨ˆä½¿ç”¨ã€‚</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- åœ– Dï¼šåŒæ­¥æŸ¥è©¢åˆ†æµï¼ˆManual vs GraphChainï¼‰ -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Dï¼šåŒæ­¥æŸ¥è©¢åˆ†æµï¼ˆ/api/queryï¼šManual vs GraphCypherQAChainï¼‰</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    S1[post api queryï½œåŒæ­¥æŸ¥è©¢å…¥å£]
    S2[query_sync routerï½œqa router åŒæ­¥å…¥å£]
    S3[_query_with_overrides to logic query kgï½œå¸¶ provider model query_engine è½‰å‘¼å«]
    S4{query_engineï½œmanual æˆ– graph_chain}

    subgraph MPATH["Manualï½œé è¨­åŒæ­¥è·¯å¾‘"]
        M1[answer_with_manual_promptï½œagentic manual æŸ¥è©¢]
        M2[_generate_kg_answer_with_llmï½œQA LLM å›ç­”æ”¹å¯«]
        M3[_summarize_query_rowsï½œæ¨¡æ¿æ‘˜è¦ fallback]
        M4[return answer cypher rows answer_source query_engine manualï½œå›å‚³ manual çµæœ]
    end

    subgraph GPATH["GraphChainï½œåŒæ­¥å°ˆç”¨è·¯å¾‘"]
        G1[query_with_graph_chainï½œé€²å…¥ GraphCypherQAChain]
        G2{providerï½œollama æˆ– gemini}
        G3[build graphcypherqachain from_llmï½œreturn_intermediate_steps true]
        G4[invoke query on chainï½œåŸ·è¡Œ query]
        G5[normalize question cypher rows answerï½œæ¨™æº–åŒ–ç›¸å®¹æ¬„ä½]
        G5A{answer emptyï½œanswer æ˜¯å¦ç‚ºç©º}
        G5B[_summarize_query_rowsï½œä»¥ rows ç”¢ç”Ÿæ‘˜è¦è£œå€¼]
        G6[attach graph_chain_raw engine_provider engine_model query_engine graph_chainï½œé™„åŠ æ¬„ä½]
        G7[error return directly no auto fallbackï½œéŒ¯èª¤ç›´æ¥å›å‚³]
    end

    S1 --> S2
    S2 --> S3
    S3 --> S4
    S4 -- manual or empty/é è¨­ --> M1
    M1 --> M2
    M2 --> M4
    M2 -. llm unavailable or invalid .-> M3
    M3 --> M4
    S4 -- graph_chain --> G1
    G1 --> G2
    G2 --> G3
    G3 --> G4
    G4 --> G5
    G5 --> G5A
    G5A -- no/å¦ --> G6
    G5A -- yes/æ˜¯ --> G5B
    G5B --> G6
    G4 -. exception .-> G7
</div>
                            <div class="diagram-detail">
                                <ol>
                                    <li><code>POST /api/query</code> æœƒå¸¶ <code>query_engine</code> é€²å…¥ service å±¤åˆ†æµï¼›æœªæŒ‡å®šæ™‚é è¨­ <code>manual</code>ã€‚</li>
                                    <li>manual è·¯å¾‘å…ˆåš <code>answer_with_manual_prompt</code> å–å¾— <code>cypher/rows</code>ï¼Œå†åš QA LLM å›ç­”æ”¹å¯«ã€‚</li>
                                    <li>manual è·¯å¾‘è‹¥ QA LLM ä¸å¯ç”¨æˆ–çµæœä¸åˆæ ¼ï¼Œæœƒæ”¹èµ°æ¨¡æ¿æ‘˜è¦ fallbackã€‚</li>
                                    <li><code>graph_chain</code> è·¯å¾‘æœƒå‘¼å« <code>query_with_graph_chain</code>ï¼Œä¾ provider å»ºç«‹ LangChain chain ä¸¦åŸ·è¡ŒåŒæ­¥æŸ¥è©¢ã€‚</li>
                                    <li>GraphChain æˆåŠŸæ™‚ä»å›å‚³ç›¸å®¹æ¬„ä½ <code>question/cypher/rows/answer</code>ï¼Œä¸¦é™„åŠ  <code>graph_chain_raw/engine_provider/engine_model/query_engine</code>ã€‚</li>
                                    <li>è‹¥ GraphChain çš„ <code>answer</code> ç‚ºç©ºï¼Œæœƒåœ¨åŒä¸€è·¯å¾‘ç”¨ <code>_summarize_query_rows</code> ä»¥ rows ç”Ÿæˆæ‘˜è¦è£œå€¼ï¼Œä¸æœƒåˆ‡åˆ° manualã€‚</li>
                                    <li>GraphChain ç™¼ç”ŸéŒ¯èª¤æ™‚ç›´æ¥å›éŒ¯èª¤ï¼Œä¸è‡ªå‹• fallback åˆ° manualã€‚</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- åœ– Eï¼šéåŒæ­¥æŸ¥è©¢ + Agentic Loopï¼ˆManual å°ˆç”¨ï¼‰ -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Eï¼šéåŒæ­¥æŸ¥è©¢èˆ‡ Agentic Loopï¼ˆ/api/query_async/*ï¼ŒManual å°ˆç”¨ï¼‰</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    subgraph API["APIï½œéåŒæ­¥æŸ¥è©¢"]
        E1[post api query async startï½œéåŒæ­¥æŸ¥è©¢å•Ÿå‹•å…¥å£]
        E1A{query_engine is graph_chainï½œæ˜¯å¦èª¤ç”¨ graph_chain}
        E1B[return 400 only supported by api query syncï½œgraph_chain åƒ…æ”¯æ´åŒæ­¥]
        E2[create query job with planner stageï½œå»ºç«‹ query job èˆ‡åˆå§‹éšæ®µ]
        E3[run worker threadï½œèƒŒæ™¯åŸ·è¡ŒæŸ¥è©¢å·¥ä½œ]
        E4[get api query async by job idï½œä¾ job id æŸ¥è©¢ç‹€æ…‹]
        E5[return progress result errorï½œå›å‚³é€²åº¦çµæœéŒ¯èª¤]
    end

    subgraph LOOP["LOOPï½œagenticè¿´åœˆ"]
        F1[load schema and entity namesï½œè¼‰å…¥ schema èˆ‡å¯¦é«”åç¨±]
        F2[emit agentic progress callbackï½œç™¼é€ agentic progress äº‹ä»¶èˆ‡ trace å¿«ç…§]
        F3[plannerï½œplanner è¦åŠƒæŸ¥è©¢ç­–ç•¥]
        F4[reactorï½œreactor ç”ŸæˆæŸ¥è©¢å‹•ä½œ]
        F5[link entity literalsï½œlink_entity_literals å¯¦é«”å­—é¢å€¼é€£çµ]
        F6[execute cypher and optional relax exact org matchï½œåŸ·è¡Œ cypher èˆ‡å¿…è¦æ”¾å¯¬çµ„ç¹”åç¨±ç²¾ç¢ºæ¯”å°]
        F7[criticï½œcritic è©•ä¼°çµæœå“è³ª]
        F8{verdictï½œåˆ¤å®šçµæœåˆ†æ”¯}
        F9[replanner and merge planï½œreplanner ç”¢ç”Ÿä¸¦åˆä½µæ–°è¨ˆç•«]
        F10[next roundï½œé€²å…¥ä¸‹ä¸€è¼ª]
        F11[accept rows doneï½œæ¥å—çµæœä¸¦å®Œæˆ]
        F12[fail fastï½œæ”¶åˆ° fail_fast æå‰åœæ­¢]
        F13[exhausted raise runtime errorï½œè¼ªæ¬¡è€—ç›¡æˆ–æå‰åœæ­¢å¾Œæ‹‹éŒ¯]
    end

    E1 --> E1A
    E1A -- yes/æ˜¯ --> E1B
    E1A -- no/å¦ --> E2
    E2 --> E3
    E3 --> F1
    F1 --> F2
    F2 --> F3
    F3 --> F4
    F4 --> F5
    F5 --> F6
    F6 --> F7
    F7 --> F8
    F8 -- accept/æ¥å— --> F11
    F8 -- replan/é‡è¦åŠƒ --> F9
    F9 --> F10
    F10 --> F4
    F10 -. max rounds/é”ä¸Šé™ .-> F13
    F8 -- fail_fast --> F12
    F12 --> F13
    F2 -.-> E2
    F11 --> E5
    F13 --> E5
    E4 --> E5
</div>
                            <div class="diagram-detail">
                                <ol>
                                    <li><code>/api/query_async/start</code> æœƒå…ˆæª¢æŸ¥ <code>query_engine</code>ï¼›è‹¥ç‚º <code>graph_chain</code> ç›´æ¥å› <code>400</code>ã€‚</li>
                                    <li>é€šéæª¢æŸ¥å¾Œæ‰å»ºç«‹ query jobï¼Œåˆå§‹åŒ–æŸ¥è©¢ä»»å‹™èˆ‡éšæ®µç‹€æ…‹ã€‚</li>
                                    <li>worker å•Ÿå‹•å¾Œå…ˆè¼‰å…¥ schema èˆ‡ entity namesï¼Œä½œç‚ºå¾ŒçºŒ Cypher ç”Ÿæˆä¾æ“šã€‚</li>
                                    <li>planner å…ˆç”¢ç”ŸæŸ¥è©¢ç­–ç•¥ï¼Œå†ç”± reactor ç”¢ç”Ÿå…·é«” action/cypherã€‚</li>
                                    <li>reactor è¼¸å‡ºæœƒå…ˆç¶“é <code>link_entity_literals</code>ï¼Œå†é€²å…¥ Cypher åŸ·è¡Œã€‚</li>
                                    <li>åŸ·è¡Œå¾Œè‹¥ rows ç‚ºç©ºï¼Œæœƒå˜—è©¦æ”¾å¯¬çµ„ç¹”åç¨±ç²¾ç¢ºæ¯”å°ï¼ˆoptional relaxï¼‰ä»¥æå‡å‘½ä¸­ç‡ã€‚</li>
                                    <li>critic æœƒè©•ä¼°æŸ¥è©¢çµæœå“è³ªï¼Œä¸¦è¼¸å‡º accept/replan/fail verdictã€‚</li>
                                    <li>accept ç›´æ¥å®Œæˆï¼›replan å‰‡å›åˆ°ä¸‹ä¸€è¼ªç¹¼çºŒè¿­ä»£æŸ¥è©¢ç­–ç•¥ã€‚</li>
                                    <li>ç³»çµ±ä¿ç•™ repeated-cypher é˜²å‘†èˆ‡ <code>max rounds</code>ï¼Œé¿å…ç„¡é€²å±•è¿´åœˆã€‚</li>
                                    <li><code>fail_fast</code> æˆ–è¼ªæ¬¡è€—ç›¡æœƒæ‹‹å‡ºéŒ¯èª¤ä¸¦è®“ async job é€²å…¥ failedï¼Œä½†é€²åº¦ä»ä¿ç•™æœ€å¾Œ <code>agentic_trace</code> å¿«ç…§ã€‚</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- åœ– Fï¼šManual è·¯å¾‘å…±ç”¨å›ç­”å¾Œè™•ç† -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Fï¼šManual è·¯å¾‘å…±ç”¨å›ç­”å¾Œè™•ç†ï¼ˆsync + asyncï¼‰</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    D0[query route or async worker calls logic query kgï½œsync router æˆ– async worker å‘¼å« query_kg]
    D1[qa service query kgï½œqa service ä¸»æµç¨‹]
    D2[answer with manual promptï½œmanual è·¯å¾‘åŸ·è¡Œ answer_with_manual_prompt]
    D3[raw result with cypher rows traceï½œå–å¾— cypher rows trace]
    D4{use qa llmï½œæ˜¯å¦å•Ÿç”¨ QA LLM}
    D5[generate answer with llmï½œLLM ç”Ÿæˆè‡ªç„¶èªå¥ç­”æ¡ˆ]
    D6{answer validï½œQA LLM ç­”æ¡ˆæ˜¯å¦å¯ç”¨}
    D7[answer source qa llmï½œanswer_source è¨­ç‚º qa_llm]
    D8[summarize rows fallbackï½œrows æ¨¡æ¿æ‘˜è¦ fallback]
    D9[answer source template fallbackï½œanswer_source è¨­ç‚º template_fallback]
    D10[return answer rows cypher query_engine manualï½œå›å‚³çµæœ async å¦å›å¯« job]

    D0 --> D1
    D1 --> D2
    D2 --> D3
    D3 --> D4
    D4 -- yes/æ˜¯ --> D5
    D5 --> D6
    D6 -- yes/æ˜¯ --> D7
    D6 -- no/å¦ --> D8
    D4 -- no/å¦ --> D8
    D8 --> D9
    D7 --> D10
    D9 --> D10
</div>
                            <div class="diagram-detail">
                                <ol>
                                    <li>æ­¤åœ–æè¿° <code>query_engine=manual</code> çš„å…±ç”¨å¾Œè™•ç†ï¼›åŒæ­¥ <code>/api/query</code> èˆ‡éåŒæ­¥ worker éƒ½æœƒèµ°åˆ°ã€‚</li>
                                    <li>QA service å…ˆåŸ·è¡Œ <code>answer_with_manual_prompt</code> å–å¾—æŸ¥è©¢åŸºç¤çµæœã€‚</li>
                                    <li>æ‹¿åˆ° <code>cypher/rows/trace</code> å¾Œï¼Œåˆ¤æ–·æ˜¯å¦å•Ÿç”¨ QA LLM ç”Ÿæˆè‡ªç„¶èªå¥ç­”æ¡ˆã€‚</li>
                                    <li>è‹¥å•Ÿç”¨ QA LLMï¼Œæœƒå…ˆå˜—è©¦ç”Ÿæˆå°ä½¿ç”¨è€…å¯è®€çš„æœ€çµ‚å›ç­”ã€‚</li>
                                    <li>ç•¶ QA LLM ç­”æ¡ˆå¯ç”¨æ™‚ï¼Œè¨­å®š <code>answer_source=qa_llm</code>ã€‚</li>
                                    <li>è‹¥ç­”æ¡ˆä¸å¯ç”¨æˆ–æœªå•Ÿç”¨ QA LLMï¼Œå‰‡æ”¹èµ° rows template æ‘˜è¦ fallbackã€‚</li>
                                    <li>fallback è·¯å¾‘æœƒè¨­å®š <code>answer_source=template_fallback</code>ã€‚</li>
                                    <li>æœ€å¾Œå›å‚³ <code>answer/rows/cypher/query_engine=manual</code>ï¼›è‹¥ç‚º async æœƒå†å›å¯«åˆ° job resultã€‚</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <h4>æœ¬ç¯€æµç¨‹åœ–æ¶‰åŠçš„ Env è®Šæ•¸ä½œç”¨è¡¨</h4>
                    <p>ä»¥ä¸‹åƒ…åˆ—å‡ºåœ– A-F çš„ç›´æ¥æ§åˆ¶åƒæ•¸ï¼Œä¸¦æ¨™è¨»å¯¦ä½œä¸­ä¸»è¦è®€å–ä½ç½®èˆ‡å½±éŸ¿è·¯å¾‘ã€‚</p>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Env è®Šæ•¸</th>
                                    <th>ä¸»è¦è®€å–ä½ç½®</th>
                                    <th>ä½œç”¨èªªæ˜</th>
                                    <th>æµç¨‹å½±éŸ¿é»</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>CHUNK_SIZE_MODE</code></td>
                                    <td><code>backend/config/settings.py</code> -> <code>backend/services/ingest/service.py</code></td>
                                    <td>æ§åˆ¶åˆ‡å¡Šç­–ç•¥ï¼š<code>provider|token|char</code>ã€‚</td>
                                    <td>åœ– A/Bï¼š<code>chunk_text</code></td>
                                </tr>
                                <tr>
                                    <td><code>CHUNK_SIZE_TOKENS</code> / <code>CHUNK_MIN_TOKENS</code></td>
                                    <td><code>backend/config/settings.py</code> -> <code>backend/services/ingest/service.py</code></td>
                                    <td>token åˆ‡å¡Šä¸Šé™èˆ‡æœ€å°é–€æª»ï¼Œå½±éŸ¿è¶…é•·æ®µè½äºŒæ¬¡åˆ‡åˆ†èˆ‡å™ªéŸ³éæ¿¾ã€‚</td>
                                    <td>åœ– Bï¼štoken chunk budget</td>
                                </tr>
                                <tr>
                                    <td><code>CHUNK_SIZE_CHARS</code> / <code>CHUNK_MIN_CHARS</code></td>
                                    <td><code>backend/config/settings.py</code> -> <code>backend/services/ingest/service.py</code></td>
                                    <td>char åˆ‡å¡Šä¸Šé™èˆ‡æœ€å°é–€æª»ã€‚</td>
                                    <td>åœ– Bï¼šchar chunk budget</td>
                                </tr>
                                <tr>
                                    <td><code>INGEST_CHUNK_LIMIT</code></td>
                                    <td><code>backend/config/settings.py</code> -> <code>backend/services/ingest/service.py</code></td>
                                    <td>å…¨åŸŸ chunk è™•ç†ä¸Šé™ï¼Œèˆ‡ request <code>chunk_limit</code> åˆä½µç”Ÿæ•ˆã€‚</td>
                                    <td>åœ– A/Bï¼š<code>_resolve_chunk_limit</code></td>
                                </tr>
                                <tr>
                                    <td><code>KEYWORD_SEARCH_MODE</code></td>
                                    <td><code>backend/config/settings.py</code> -> <code>backend/services/ingest/service.py</code></td>
                                    <td>æ§åˆ¶ keyword crawl æœå°‹ç­–ç•¥ï¼ˆhtml_only/html_first ç­‰ï¼‰ã€‚</td>
                                    <td>åœ– Aï¼škeyword ingest åˆ†æ”¯</td>
                                </tr>
                                <tr>
                                    <td><code>EXTRACTION_JSON_MODE</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æŠ½å– JSON æ¨¡å¼ï¼š<code>auto/strict_json/text</code>ã€‚</td>
                                    <td>åœ– Cï¼šRetry/Repair loop</td>
                                </tr>
                                <tr>
                                    <td><code>EXTRACTION_MAX_JSON_RETRIES</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>JSON ä¿®å¾©é‡è©¦ä¸Šé™ï¼ˆç¸½å˜—è©¦æ¬¡æ•¸ = retries + 1ï¼‰ã€‚</td>
                                    <td>åœ– Cï¼šçµ‚æ­¢æ¢ä»¶</td>
                                </tr>
                                <tr>
                                    <td><code>EXTRACTION_NUM_PREDICT</code></td>
                                    <td><code>backend/config/settings.py</code> -> <code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æŠ½å–éšæ®µè¼¸å‡º token é ç®—ã€‚</td>
                                    <td>åœ– Cï¼š<code>chat_json/chat_text</code></td>
                                </tr>
                                <tr>
                                    <td><code>GEMINI_TWO_PASS_EXTRACTION</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æ±ºå®šæ˜¯å¦å•Ÿç”¨ Gemini two-pass æŠ½å–ã€‚</td>
                                    <td>åœ– Cï¼štwo-pass åˆ†æµ</td>
                                </tr>
                                <tr>
                                    <td><code>KG_QA_USE_LLM</code></td>
                                    <td><code>backend/services/qa/service.py</code></td>
                                    <td>æ§åˆ¶æ˜¯å¦å•Ÿç”¨ QA æ”¹å¯«ï¼›é—œé–‰æ™‚ç›´æ¥èµ°æ¨¡æ¿æ‘˜è¦ã€‚</td>
                                    <td>åœ– Fï¼ˆmanual è·¯å¾‘ï¼‰ï¼š<code>qa_llm</code> vs <code>template_fallback</code></td>
                                </tr>
                                <tr>
                                    <td><code>KG_QA_MODEL</code> / <code>KG_QA_TEMPERATURE</code> / <code>KG_QA_MAX_TOKENS</code> / <code>KG_QA_MAX_ROWS_FOR_PROMPT</code></td>
                                    <td><code>backend/services/qa/service.py</code></td>
                                    <td>æ§åˆ¶ QA æ”¹å¯«æ¨¡å‹ã€æ¡æ¨£èˆ‡è¼¸å‡ºé™åˆ¶ã€‚</td>
                                    <td>åœ– Fï¼ˆmanual è·¯å¾‘ï¼‰ï¼š<code>_generate_kg_answer_with_llm</code></td>
                                </tr>
                                <tr>
                                    <td><code>NL2CYPHER_TIMEOUT_SECONDS</code> / <code>NL2CYPHER_NUM_PREDICT</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>æ§åˆ¶ NL2Cypher æ¨¡å‹å‘¼å«çš„ timeout èˆ‡ token é ç®—ã€‚</td>
                                    <td>åœ– Eï¼šplanner/reactor/critic å‘¼å«</td>
                                </tr>
                                <tr>
                                    <td><code>NL2CYPHER_PROVIDER</code> / <code>NL2CYPHER_MODEL</code></td>
                                    <td><code>backend/config/settings.py</code> -> <code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>æŒ‡å®šæŸ¥è©¢éšæ®µ provider/modelï¼Œäº¦å¯ç”± QueryRequest è¦†å¯«ã€‚</td>
                                    <td>åœ– Dï¼šsync manual/graph_chain åˆ†æµï¼›åœ– Eï¼šasync manual agentic loopï¼›åœ– Fï¼šmanual å…±ç”¨å›ç­”å¾Œè™•ç†</td>
                                </tr>
                                <tr>
                                    <td><code>OLLAMA_BASE_URL</code> / <code>GEMINI_API_KEY</code></td>
                                    <td><code>backend/llm_kg/llm_client.py</code> -> <code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>GraphChain è·¯å¾‘å»ºç«‹ LLM clientï¼ˆOllama endpoint / Gemini API keyï¼‰æ‰€éœ€ï¼›ç¼ºå€¼æ™‚ç›´æ¥æ‹‹éŒ¯ã€‚</td>
                                    <td>åœ– Dï¼š<code>query_with_graph_chain</code> provider å»ºéˆèˆ‡åŸ·è¡Œ</td>
                                </tr>
                                <tr>
                                    <td><code>NL2CYPHER_AGENTIC_MAX_ROUNDS</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>agentic loop æœ€å¤§è¼ªæ•¸ã€‚</td>
                                    <td>åœ– Eï¼šround è¿´åœˆä¸Šé™</td>
                                </tr>
                                <tr>
                                    <td><code>NL2CYPHER_AGENTIC_PLAN_TOKENS</code> / <code>NL2CYPHER_AGENTIC_REACT_TOKENS</code> / <code>NL2CYPHER_AGENTIC_CRITIC_TOKENS</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>planner/reactor/critic ä¸‰é¡ agent çš„è¼¸å‡º token é ç®—ã€‚</td>
                                    <td>åœ– Eï¼šagentic å­ä»£ç†å“è³ªèˆ‡ç©©å®šåº¦</td>
                                </tr>
                                <tr>
                                    <td><code>CYPHER_REPAIR_RETRIES</code>ï¼ˆlegacy æ¬¡è¦è·¯å¾‘ï¼‰</td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>ç›®å‰ä¸»è¦ä¾›èˆŠå¼ `natural_language_to_cypher` ä¿®å¾©èªå¢ƒï¼›é agentic ä¸»è¿´åœˆæ§åˆ¶éˆ•ã€‚</td>
                                    <td>åœ– Eï¼šreactor fallbackï¼ˆæ¬¡è¦ï¼‰</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4>æœ¬ç¯€æµç¨‹åœ–æ¶‰åŠçš„æ ¸å¿ƒå‡½å¼ä½œç”¨è¡¨</h4>
                    <p>ä¸‹è¡¨ä»¥å¯¦éš›åŸ·è¡Œè²¬ä»»åˆ†å±¤ï¼šRouter å”èª¿ã€Service åˆ†æµã€Logic facadeã€NL2Cypher agentic èˆ‡ GraphChain æ ¸å¿ƒã€‚</p>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>å‡½å¼</th>
                                    <th>æª”æ¡ˆ</th>
                                    <th>ä½œç”¨</th>
                                    <th>è¼¸å…¥ / è¼¸å‡ºé‡é»</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>process_text_sync</code> / <code>process_url_sync</code> / <code>process_keyword_sync</code></td>
                                    <td><code>backend/api/routers/ingest.py</code></td>
                                    <td>Ingest åŒæ­¥ API å…¥å£ï¼Œæ•´ç† request å¾Œå‘¼å« logic facadeã€‚</td>
                                    <td>Out: build result payload</td>
                                </tr>
                                <tr>
                                    <td><code>process_text_async_start</code> / <code>process_url_async_start</code> / <code>process_keyword_async_start</code></td>
                                    <td><code>backend/api/routers/ingest.py</code></td>
                                    <td>Ingest éåŒæ­¥å…¥å£ï¼Œå»ºç«‹ jobã€å•Ÿå‹• worker èˆ‡é€²åº¦æ›´æ–°ã€‚</td>
                                    <td>Out: <code>{job_id, status}</code></td>
                                </tr>
                                <tr>
                                    <td><code>logic.process_*_to_kg</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>Facade wrapperï¼Œè½‰å‘¼å« <code>backend/services/ingest/service.py</code>ã€‚</td>
                                    <td>ä¿ç•™å‘å¾Œç›¸å®¹ä»‹é¢</td>
                                </tr>
                                <tr>
                                    <td><code>chunk_text</code> / <code>_resolve_chunk_limit</code></td>
                                    <td><code>backend/services/ingest/service.py</code></td>
                                    <td>åˆ‡å¡Šèˆ‡é™æµæ ¸å¿ƒï¼Œæ±ºå®š token/char èˆ‡å¯¦éš›è™•ç†ä¸Šé™ã€‚</td>
                                    <td>Out: <code>List[Chunk]</code> + effective limit</td>
                                </tr>
                                <tr>
                                    <td><code>build_kg_from_chunks</code></td>
                                    <td><code>backend/services/ingest/service.py</code></td>
                                    <td>é€ chunk æŠ½å–/å¯«å…¥ä¸¦èšåˆ <code>stats/summary/chunk_progress</code>ã€‚</td>
                                    <td>Out: ingest çµæœèˆ‡ chunk_update è³‡æ–™</td>
                                </tr>
                                <tr>
                                    <td><code>extract_entities_relations</code> / <code>_extract_entities_relations_two_pass</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æŠ½å–ä¸»æ§åˆ¶å™¨ï¼Œè™•ç† single-pass èˆ‡ two-pass åˆ†æµã€‚</td>
                                    <td>Out: sanitized entities/relations + meta</td>
                                </tr>
                                <tr>
                                    <td><code>_extract_json_with_retry</code> / <code>_sanitize_extraction</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æŠ½å–å¯é æ€§èˆ‡ schema æ¸…æ´—å®ˆé–€å±¤ã€‚</td>
                                    <td>Out: valid payload, retry stats, dropped_relations</td>
                                </tr>
                                <tr>
                                    <td><code>populate_graph</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>Neo4j upsert å”èª¿ï¼ˆconstraints/entity/relationï¼‰ã€‚</td>
                                    <td>Out: <code>GraphBuildStats</code></td>
                                </tr>
                                <tr>
                                    <td><code>query_sync</code> / <code>query_async_start</code> / <code>query_async_status</code></td>
                                    <td><code>backend/api/routers/qa.py</code></td>
                                    <td>Query API åŒæ­¥èˆ‡éåŒæ­¥å…¥å£ï¼Œå”èª¿ query_job_store èˆ‡é€²åº¦æµï¼›async å…¥å£æ‹’çµ• <code>query_engine=graph_chain</code>ã€‚</td>
                                    <td>Out: sync result æˆ– async job ç‹€æ…‹</td>
                                </tr>
                                <tr>
                                    <td><code>logic.query_kg</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>QA facade wrapperï¼Œè½‰å‘¼å« service å±¤ã€‚</td>
                                    <td>ç¶­æŒèˆŠæ¸¬è©¦èˆ‡ä»‹é¢ç›¸å®¹</td>
                                </tr>
                                <tr>
                                    <td><code>backend/services/qa/service.py::query_kg</code></td>
                                    <td><code>backend/services/qa/service.py</code></td>
                                    <td>æŸ¥è©¢æœå‹™ä¸»é«”ï¼šä¾ <code>query_engine</code> åˆ†æµè‡³ manual æˆ– graph_chainï¼Œä¸¦åšå›å‚³æ¬„ä½æ¨™æº–åŒ–ã€‚</td>
                                    <td>Out: <code>question/answer/cypher/rows/query_engine</code>ï¼ˆmanual å¦å« <code>answer_source</code>ï¼›graph_chain å¯å« <code>graph_chain_raw</code>ï¼‰</td>
                                </tr>
                                <tr>
                                    <td><code>answer_with_manual_prompt</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>NL2Cypher ä¸»å…¥å£ï¼Œè¼‰å…¥ schema/entity å¾Œé€²å…¥ agentic loopã€‚</td>
                                    <td>Out: <code>rows + cypher + agentic_trace</code></td>
                                </tr>
                                <tr>
                                    <td><code>query_with_graph_chain</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>GraphCypherQAChain åŒæ­¥è·¯å¾‘ï¼šä¾ provider å»ºç«‹ chainï¼ŒåŸ·è¡ŒæŸ¥è©¢ä¸¦è§£æ intermediate stepsã€‚</td>
                                    <td>Out: <code>answer/cypher/rows/raw/engine_provider/engine_model</code></td>
                                </tr>
                                <tr>
                                    <td><code>_run_agentic_query_loop</code> / <code>_emit_progress</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>åŸ·è¡Œ planner/reactor/critic/replanner è¿´åœˆï¼Œä¸¦ç™¼é€ <code>agentic_progress</code>ã€‚</td>
                                    <td>Out: accepted rows æˆ– raiseï¼ˆå¤±æ•—æ™‚ä¿ç•™ progress traceï¼‰</td>
                                </tr>
                                <tr>
                                    <td><code>_run_planner_agent</code> / <code>_run_reactor_agent</code> / <code>_run_critic_agent</code> / <code>_run_replanner_agent</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>agentic å­ä»£ç†ï¼šè¦åŠƒã€ç”Ÿæˆã€è©•å¯©ã€é‡è¦åŠƒã€‚</td>
                                    <td>ç”± JSON contract ä¸²æ¥æ±ºç­–</td>
                                </tr>
                                <tr>
                                    <td><code>link_entity_literals</code> / <code>_relax_exact_organization_name_match</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>åŸ·è¡Œå‰å¯¦é«”å­—é¢å€¼é€£çµèˆ‡ zero-row æ™‚çš„çµ„ç¹”åç¨±æ”¾å¯¬ç­–ç•¥ã€‚</td>
                                    <td>Out: linked cypher / optional relaxed cypher</td>
                                </tr>
                                <tr>
                                    <td><code>_generate_kg_answer_with_llm</code> / <code>_summarize_query_rows</code></td>
                                    <td><code>backend/services/qa/service.py</code></td>
                                    <td>Manual è·¯å¾‘æœ€çµ‚å›ç­”å±¤ï¼šLLM æ”¹å¯«èˆ‡æ¨¡æ¿å›é€€ï¼ˆgraph_chain åƒ…åœ¨ answer ç‚ºç©ºæ™‚ç”¨æ‘˜è¦è£œå€¼ï¼‰ã€‚</td>
                                    <td><code>answer_source=qa_llm|template_fallback</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="section-4">
                <h2>4. OpenClaw ç³»çµ±æ¶æ§‹èˆ‡æŠ€èƒ½å®‰å…¨åˆ†æ</h2>

                <div id="section-4-1">
                    <h3>(1) ç³»çµ±æ¶æ§‹èˆ‡ä¸»è¦çµ„ä»¶</h3>
                    <p>ä»¥ä¸‹ä¾ <code>ARCHITECTURE.md</code> å½™æ•´ï¼š</p>
                    <ul>
                        <li><strong>Gateway Server (<code>src/gateway</code>)</strong>ï¼š
                            <ul>
                                <li>ä»¥å¾®æ ¸å¿ƒæ¶æ§‹ç‚ºä¸­æ¨ï¼Œè² è²¬é…ç½®è¼‰å…¥ã€Plugin æ›è¼‰ã€HTTP/WebSocket æœå‹™ã€äº‹ä»¶å»£æ’­èˆ‡å­æœå‹™ç”Ÿå‘½é€±æœŸã€‚</li>
                                <li>å…§å« Discoveryã€Tailscaleã€Exec Approval Manager ç­‰é—œéµèƒ½åŠ›ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Channel System (<code>src/channels</code>)</strong>ï¼š
                            <ul>
                                <li>å°‡ WhatsApp / Telegram / Discord / Slack ç­‰ç•°è³ªè¨Šæ¯æ¨™æº–åŒ–ï¼Œçµ±ä¸€è¼¸å…¥äº‹ä»¶æ ¼å¼ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Auto-reply Engine (<code>src/auto-reply</code>)</strong>ï¼š
                            <ul>
                                <li>è² è²¬è¨Šæ¯è·¯ç”±ã€Session ç®¡ç†ã€æ¨¡å‹é¸æ“‡ã€ReAct å·¥å…·è¿´åœˆåŸ·è¡Œèˆ‡æœ€çµ‚å›è¦†ç”Ÿæˆã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Plugin / Skill ç”Ÿæ…‹ (<code>extensions/</code>, <code>skills/</code>)</strong>ï¼š
                            <ul>
                                <li>é€éå¤–æ›æ“´å…… Channelã€Toolsã€CLI æŒ‡ä»¤èˆ‡ HTTP Routesï¼Œæ˜¯å¹³å°æ“´å±•æ€§æ ¸å¿ƒã€‚</li>
                            </ul>
                        </li>
                        <li><strong>åŸºç¤è¨­æ–½å±¤ (<code>src/cron</code>, <code>src/media</code>)</strong>ï¼š
                            <ul>
                                <li>æä¾›æ’ç¨‹ã€åª’é«”è½‰æ›ã€çŸ­æœŸæª”æ¡ˆæœå‹™èˆ‡æ¸…ç†æ©Ÿåˆ¶ã€‚</li>
                            </ul>
                        </li>
                    </ul>

                    <p><strong>è³‡æ–™æµï¼ˆData Flowï¼Œå¼•ç”¨ <code>ARCHITECTURE.md</code>ï¼‰</strong></p>

                    <h4>4.1 è¨Šæ¯è™•ç†æµç¨‹</h4>
                    <div class="mermaid">sequenceDiagram
    participant User
    participant ChannelPlugin as Channel Plugin
    participant Gateway
    participant Dispatcher
    participant AgentRunner
    participant LLM

    User->>ChannelPlugin: ç™¼é€è¨Šæ¯
    ChannelPlugin->>Gateway: æ¨™æº–åŒ–è¨Šæ¯ (Normalized Event)
    Gateway->>Dispatcher: dispatchInboundMessage()

    note over Dispatcher: Security Check (Command Gating)

    Dispatcher->>Dispatcher: å»ºç«‹ MsgContext
    Dispatcher->>AgentRunner: è§¸ç™¼ Agent åŸ·è¡Œ

    loop Thinking Process
        AgentRunner->>LLM: ç™¼é€ Prompt + Context
        LLM-->>AgentRunner: å›å‚³ Thought / Tool Call
        opt Tool Execution
            AgentRunner->>Gateway: åŸ·è¡Œå·¥å…· (e.g., search, query)
            Gateway-->>AgentRunner: å›å‚³ Tool Result
        end
    end

    AgentRunner-->>Dispatcher: ç”Ÿæˆæœ€çµ‚å›è¦† (Payload)
    Dispatcher->>ChannelPlugin: ç™¼é€å›è¦†
    ChannelPlugin->>User: é¡¯ç¤ºè¨Šæ¯
</div>

                    <h4>4.2 Agent æ€è€ƒéç¨‹è©³è§£ (Agent Execution Loop)</h4>
                    <p>Agent çš„åŸ·è¡Œé‚è¼¯ä½æ–¼ <code>src/auto-reply/reply/agent-runner.ts</code> èˆ‡ <code>agent-runner-execution.ts</code>ï¼Œå…¶æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š</p>
                    <ol>
                        <li><strong>ä¸Šä¸‹æ–‡æº–å‚™ (Context Prep)</strong>ï¼š
                            <ul>
                                <li>å¾ Session Store è¼‰å…¥å°è©±æ­·å²ã€‚</li>
                                <li>æ³¨å…¥ç³»çµ±æç¤ºè© (System Prompt) èˆ‡ç•¶å‰å¯ç”¨å·¥å…· (Tools)ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>æ¬Šé™æª¢æŸ¥ (Security)</strong>ï¼š
                            <ul>
                                <li><strong>Command Gating</strong>ï¼šæª¢æŸ¥ç™¼é€è€…æ˜¯å¦åœ¨å…è¨±æ¸…å–® (Allowlist) ä¸­ï¼Œä»¥æ±ºå®šæ˜¯å¦åŸ·è¡Œæ•æ„ŸæŒ‡ä»¤ã€‚</li>
                                <li><strong>Access Groups</strong>ï¼šæ”¯æ´ç¾¤çµ„å±¤ç´šçš„æ¬Šé™ç®¡ç†ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>æ¨¡å‹èª¿ç”¨ (Model Invocation)</strong>ï¼š
                            <ul>
                                <li>å°‡ä¸Šä¸‹æ–‡ç™¼é€è‡³é…ç½®çš„ LLM (OpenAI, Anthropic ç­‰)ã€‚</li>
                                <li>è‹¥é…ç½®äº† Fallbackï¼Œç•¶ä¸»è¦æ¨¡å‹å¤±æ•—æ™‚æœƒè‡ªå‹•åˆ‡æ›è‡³å‚™æ´æ¨¡å‹ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>æ¨ç†èˆ‡å·¥å…· (Reasoning & Tools)</strong>ï¼š
                            <ul>
                                <li><strong>Thinking</strong>ï¼šAgent ç”¢ç”Ÿæ€è€ƒéç¨‹ (CoT)ã€‚</li>
                                <li><strong>Action</strong>ï¼šè‹¥ Agent æ±ºå®šä½¿ç”¨å·¥å…·ï¼Œç³»çµ±æœƒæ””æˆª Tool Callï¼ŒåŸ·è¡Œå°æ‡‰çš„ TypeScript å‡½æ•¸ï¼Œä¸¦å°‡çµæœ (Observation) é™„åŠ å›å°è©±æ­·å²ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>ä¸²æµå›æ‡‰ (Streaming)</strong>ï¼š
                            <ul>
                                <li>æ”¯æ´ <strong>Block Streaming</strong>ï¼Œå³æ™‚å°‡ Agent çš„éƒ¨åˆ†æ€è€ƒæˆ–å›æ‡‰æ¨é€çµ¦ä½¿ç”¨è€…ï¼Œæ¸›å°‘ç­‰å¾…æ„Ÿã€‚</li>
                                <li>è™•ç† <strong>Typing Indicators</strong>ï¼Œåœ¨ Agent æ€è€ƒæˆ–åŸ·è¡Œå·¥å…·æ™‚é¡¯ç¤ºã€Œæ­£åœ¨è¼¸å…¥...ã€ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>è¨˜æ†¶é«”ç®¡ç† (Memory Management)</strong>ï¼š
                            <ul>
                                <li>åŸ·è¡Œå¾Œè‡ªå‹•æª¢æŸ¥ Context Windowï¼Œå¿…è¦æ™‚è§¸ç™¼ <strong>Compaction</strong>ï¼ˆæ‘˜è¦/å£“ç¸®æ­·å²ç´€éŒ„ï¼‰ã€‚</li>
                            </ul>
                        </li>
                    </ol>

                    <h4>4.3 åª’é«”è™•ç†ç®¡é“ (Media Pipeline)</h4>
                    <p>ä½æ–¼ <code>src/media/</code>ï¼Œè² è²¬è™•ç†åœ–ç‰‡ã€éŸ³è¨Šèˆ‡å½±ç‰‡æª”æ¡ˆã€‚</p>
                    <ul>
                        <li><strong>æš«å­˜ä¼ºæœå™¨ (Ephemeral Server)</strong>ï¼šå•Ÿå‹•ä¸€å€‹ Express Server æä¾›æœ¬åœ°åª’é«”æª”æ¡ˆçš„ HTTP å­˜å–ã€‚</li>
                        <li><strong>ç”Ÿå‘½é€±æœŸç®¡ç†</strong>ï¼šä¸Šå‚³çš„åª’é«”æª”æ¡ˆé è¨­æœ‰ TTL (Time-To-Liveï¼Œä¾‹å¦‚ 2 åˆ†é˜)ï¼ŒéæœŸå¾Œæœƒç”± <code>cleanOldMedia</code> å®šæœŸæ¸…ç†ï¼Œç¢ºä¿ç£ç¢Ÿç©ºé–“ä¸è¢«ä½”ç”¨ã€‚</li>
                        <li><strong>MIME åµæ¸¬</strong>ï¼šä½¿ç”¨ <code>detectMime</code> è‡ªå‹•è­˜åˆ¥æª”æ¡ˆé¡å‹ã€‚</li>
                    </ul>
                </div>

                <div id="section-4-2">
                    <h3>(2) OpenClaw å®‰å…¨é¢¨éšªï¼ˆ3 å¤§é¡ 10 é …ï¼‰</h3>

                    <h4>A. Skill ç”Ÿæ…‹ç³»é¢¨éšªï¼ˆ5 é …ï¼Œæœ€é«˜å„ªå…ˆï¼‰</h4>
                    <ol>
                        <li><strong>ä»»æ„ç¨‹å¼ç¢¼åŸ·è¡Œ (RCE)</strong>ï¼šSkill é€é <code>eval</code> / shell pipe / <code>child_process</code> åŸ·è¡Œæƒ¡æ„æŒ‡ä»¤ã€‚</li>
                        <li><strong>è·¯å¾‘éæ­· (Path Traversal)</strong>ï¼šæƒ¡æ„è·¯å¾‘ï¼ˆå¦‚ <code>../../etc/passwd</code>ï¼‰è®€å–è¶…å‡ºæˆæ¬Šç¯„åœæª”æ¡ˆã€‚</li>
                        <li><strong>è³‡æ–™å¤–æ´© (Exfiltration)</strong>ï¼šSkill è®€å–æœ¬æ©Ÿæ•æ„Ÿæª”å¾Œé€éç¶²è·¯ä¸Šå‚³åˆ°å¤–éƒ¨ç«¯é»ã€‚</li>
                        <li><strong>ä¾›æ‡‰éˆæ”»æ“Š (Supply Chain Poisoning)</strong>ï¼šæƒ¡æ„ Skill å½è£å¯¦ç”¨å·¥å…·æ··å…¥ç”Ÿæ…‹ã€‚</li>
                        <li><strong>Prompt Injection via Skill Output</strong>ï¼šSkill è¼¸å‡ºå¤¾å¸¶æƒ¡æ„æŒ‡ä»¤ï¼Œèª˜å° Agent è¦†å¯«å®‰å…¨é‚Šç•Œã€‚</li>
                    </ol>

                    <h4>B. åŸ·è¡Œç’°å¢ƒé¢¨éšªï¼ˆ3 é …ï¼‰</h4>
                    <ol start="6">
                        <li><strong>æ²™ç®±é€ƒé€¸ (Sandbox Escape)</strong>ï¼švm/å®¹å™¨éš”é›¢ä¸è¶³æ™‚ï¼Œæƒ¡æ„ç¨‹å¼çªç ´åŸ·è¡Œé‚Šç•Œã€‚</li>
                        <li><strong>éåº¦é«˜æ¬Šé™åŸ·è¡Œ</strong>ï¼šSkill ç›´æ¥å–å¾—éå¤§ç³»çµ±æ¬Šé™ï¼ˆæª”æ¡ˆã€ç¶²è·¯ã€å‘½ä»¤åŒæ™‚é–‹æ”¾ï¼‰ã€‚</li>
                        <li><strong>èŠå¤©è¨Šæ¯æ³¨å…¥å‘é‡</strong>ï¼šå¤–éƒ¨è¨Šæ¯ç›´æ¥æ‹¼æ¥åˆ°é«˜æ¬Šé™å·¥å…· prompt/å‘½ä»¤ï¼Œé€ æˆé–“æ¥æ³¨å…¥ã€‚</li>
                    </ol>

                    <h4>C. ç³»çµ±æ•´åˆèˆ‡æ²»ç†é¢¨éšªï¼ˆ2 é …ï¼‰</h4>
                    <ol start="9">
                        <li><strong>æ¬Šé™ç²’åº¦ä¸è¶³</strong>ï¼šç¼ºå°‘ capability ç´šåˆ¥æˆæ¬Šï¼Œç„¡æ³•æœ€å°æ¬Šé™åŒ–ã€‚</li>
                        <li><strong>Token/Secrets ç®¡ç†ä¸è¶³</strong>ï¼šç¬¬ä¸‰æ–¹ API Token è‹¥æœªåŠ å¯†ã€æœªè¼ªæ›¿ã€ç¼ºç¨½æ ¸ï¼Œå¤–æ´©é¢¨éšªé«˜ã€‚</li>
                    </ol>

                    <p><strong>ç¾æ³è§€å¯Ÿï¼ˆæœ¬ repoï¼‰</strong>ï¼š</p>
                    <ul>
                        <li>å·²æœ‰ <code>genai_project/openclaw/security/skill_audit.ts</code>ï¼Œå¯æŠ“åˆ° <code>curl|bash</code>ã€<code>eval</code>ã€<code>sudo</code>ã€<code>elevated:true</code> ç­‰é«˜é¢¨éšªæ¨¡å¼ã€‚</li>
                        <li>ç›®å‰å±¬æ–¼ <strong>éœæ…‹ Regex åŸºç·šæª¢æŸ¥</strong>ï¼Œå°šæœªè¦†è“‹ AST è¡Œç‚ºåˆ†æã€æ²™ç®±å‹•æ…‹é©—è­‰ã€ä¾†æºç°½ç« èˆ‡å®Œæ•´æ¬Šé™æ”¿ç­–ã€‚</li>
                    </ul>
                </div>

                <div id="section-4-3">
                    <h3>(3) æŠ€èƒ½å®‰å…¨å¯©æŸ¥æ©Ÿåˆ¶è¨­è¨ˆï¼ˆå»ºè­°è½åœ°ç‰ˆï¼‰</h3>

                    <h4>3.1 å››éšæ®µå¯©æŸ¥ç¸½è¦½ï¼ˆä¸Šæ¶å‰ï¼‰</h4>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th>åç¨±</th>
                                    <th>æ ¸å¿ƒæ–¹æ³•</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><strong>Manifest Audit</strong></td>
                                    <td>å¿…è¦æ¬„ä½é©—è­‰ã€æ¬Šé™ç™½åå–®æ¯”å°ã€sandbox å¼·åˆ¶é™åˆ¶</td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td><strong>Static Analysis</strong></td>
                                    <td>å±éšª API Regex/è¦å‰‡æƒæ + æ··æ·†åµæ¸¬ï¼ˆé•·è¡Œã€Hex/Unicode è·³è„«ï¼‰</td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td><strong>Sandbox Trial</strong></td>
                                    <td>å—æ§åŸ·è¡Œã€ç¶²è·¯æ””æˆªã€ç³»çµ±å‘¼å«ç›£æ§ã€è³‡æºä¸Šé™</td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td><strong>Signature Verification</strong></td>
                                    <td><code>SHA-256(manifest + entrypoint)</code> + ç™¼å¸ƒè€…å…¬é‘°ï¼ˆRSA/ç­‰æ•ˆï¼‰é©—è­‰</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p><strong>æ±ºç­–é‚è¼¯</strong></p>
                    <ul>
                        <li>æœ‰ <code>CRITICAL/ERROR</code>ï¼šè‡ªå‹•æ‹’çµ•ã€‚</li>
                        <li>æœ‰ <code>HIGH/WARN</code>ï¼šè½‰äººå·¥è¤‡å¯©ã€‚</li>
                        <li>å…¨é€šéä¸”ç°½ç« æœ‰æ•ˆï¼šå…è¨±ä¸Šæ¶ã€‚</li>
                    </ul>

                    <h4>3.2 Phase 1ï¼šManifest Auditï¼ˆæ¸…å–®å¯©æŸ¥ï¼‰</h4>
                    <p>å…ˆå¯©æŸ¥ Skill çš„ <code>skill.json</code>ï¼ˆè‡ªæˆ‘è²æ˜ï¼‰ï¼Œä¸åˆè¦ç›´æ¥æ“‹ä¸‹ï¼Œä¸é€²ä¸‹ä¸€é—œã€‚</p>

                    <p><strong>å¿…è¦æ¬„ä½é©—è­‰</strong></p>
                    <pre><code class="language-json">{
  "name": "file_summarizer",
  "version": "1.0.0",
  "author": "demo-author",
  "permissions": ["fs.read.whitelist"],
  "entrypoint": "index.js",
  "sandbox": {
    "exec": false,
    "network": false,
    "fs_read": ["/home/user/documents"],
    "fs_write": []
  }
}</code></pre>

                    <p><strong>æ¬Šé™ç™½åå–®æ¯”å°</strong></p>
                    <ul>
                        <li>å…è¨±ï¼š<code>system.time</code>ã€<code>fs.read.whitelist</code>ã€<code>network.outbound.allowlist</code></li>
                        <li>æ‹’çµ•ï¼š<code>system.root</code>ã€<code>fs.read.*</code>ã€<code>exec.shell</code></li>
                    </ul>

                    <p><strong>Sandbox å¼·åˆ¶è¦å‰‡</strong></p>
                    <ul>
                        <li><code>sandbox.exec=true</code>ï¼šç›´æ¥ <code>CRITICAL</code>ï¼ˆæ‹’çµ•ï¼‰ã€‚</li>
                        <li><code>sandbox.network=true</code> ä½†æœªå®£å‘Šå°æ‡‰ç¶²è·¯æ¬Šé™ï¼š<code>ERROR</code>ï¼ˆæ‹’çµ•ï¼‰ã€‚</li>
                        <li><code>fs_read/fs_write</code> å¿…é ˆæ˜¯æ˜ç¢ºç™½åå–®è·¯å¾‘ã€‚</li>
                    </ul>

                    <h4>3.3 Phase 2ï¼šStatic Analysisï¼ˆéœæ…‹æƒæï¼‰</h4>
                    <p>ä¸åŸ·è¡Œç¨‹å¼ï¼Œç›´æ¥æƒæåŸå§‹ç¢¼æ¨¡å¼ã€‚</p>

                    <p><strong>å±éšª API é¢¨éšªåˆ†ç´š</strong></p>
                    <ul>
                        <li><code>CRITICAL</code>ï¼š<code>child_process</code>ã€<code>exec()</code>ã€<code>execSync</code>ã€<code>spawn()</code>ã€<code>eval()</code>ã€<code>new Function()</code></li>
                        <li><code>HIGH</code>ï¼šæœªæˆæ¬Šç¶²è·¯å‘¼å«ï¼ˆ<code>http/https/fetch</code>ï¼‰ã€æª”æ¡ˆç ´å£æ“ä½œï¼ˆ<code>fs.writeFile/fs.unlink/fs.rmdir</code>ï¼‰</li>
                        <li><code>MEDIUM</code>ï¼š<code>process.env</code>ã€<code>process.exit()</code>ã€å¯ç–‘è§£ç¢¼ï¼ˆ<code>Buffer.from(base64)</code>ï¼‰</li>
                        <li><code>LOW</code>ï¼šHex/Unicode è·³è„«å­—ä¸²ã€éåº¦æ··æ·†ç—•è·¡</li>
                    </ul>

                    <p><strong>æ··æ·†åµæ¸¬</strong></p>
                    <ul>
                        <li>å–®è¡Œè¶…é 500 å­—å…ƒè§¸ç™¼è­¦ç¤ºï¼ˆå¸¸è¦‹æ–¼æ··æ·†æˆ–æƒ¡æ„ payloadï¼‰ã€‚</li>
                        <li>åµæ¸¬ <code>\xNN</code>ã€<code>\uNNNN</code> å¤§é‡è·³è„«å­—å…ƒã€‚</li>
                    </ul>

                    <p><strong>é™åˆ¶èªªæ˜ï¼ˆéœ€æ­é… Phase 3ï¼‰</strong></p>
                    <pre><code class="language-javascript">const mod = "child" + "_" + "process";
require(mod).exec("rm -rf /");</code></pre>
                    <p>ä¸Šè¿°å‹•æ…‹çµ„å­—å¯èƒ½ç¹éç´”å­—ä¸²è¦å‰‡ï¼Œå› æ­¤éœ€é€²å…¥æ²™ç®±å‹•æ…‹é©—è­‰ã€‚</p>

                    <h4>3.4 Phase 3ï¼šSandbox Trialï¼ˆæ²™ç®±è©¦è·‘ï¼‰</h4>
                    <p>åœ¨éš”é›¢ç’°å¢ƒå¯¦éš›åŸ·è¡Œ Skillï¼Œé©—è­‰è¡Œç‚ºæ˜¯å¦èˆ‡å®£å‘Šä¸€è‡´ã€‚</p>

                    <p><strong>éš”é›¢å±¤ç´šï¼ˆç”±å¼±åˆ°å¼·ï¼‰</strong></p>
                    <ul>
                        <li>Node.js <code>vm</code>ï¼ˆä¸å»ºè­°å–®ç¨ä¾è³´ï¼Œæ­·å²ä¸Šæœ‰é€ƒé€¸é¢¨éšªï¼‰</li>
                        <li>gVisorï¼ˆsyscall å±¤æ””æˆªï¼‰</li>
                        <li>Firecracker microVMï¼ˆé«˜éš”é›¢ï¼‰</li>
                    </ul>

                    <p><strong>è©¦è·‘ç›£æ§</strong></p>
                    <ul>
                        <li>ç¶²è·¯ï¼šDNS/TCP é€£ç·šç´€éŒ„ï¼Œæœªæˆæ¬Šå¤–è¯ç«‹å³æ¨™è¨˜ã€‚</li>
                        <li>æª”æ¡ˆï¼š<code>open/read/write</code> å­˜å–æ˜¯å¦è¶…å‡ºç™½åå–®ã€‚</li>
                        <li>ç¨‹åºï¼šç¦æ­¢ <code>fork/exec</code>ï¼›CPU > 5 ç§’æˆ–è¨˜æ†¶é«” > 128 MB å³çµ‚æ­¢ã€‚</li>
                        <li>è¡Œç‚ºä¸€è‡´æ€§ï¼šä»¥ mock è¼¸å…¥åŸ·è¡Œï¼Œæª¢æŸ¥è¼¸å‡ºæ˜¯å¦ç¬¦åˆ manifest schemaã€‚</li>
                    </ul>

                    <pre><code class="language-javascript">const result = await skill.run(
  { filepath: "/home/user/documents/test.txt" },
  { permissions: mockPermissions, logger: mockLogger }
);
validateAgainstSchema(result, skill.manifest.schema.output);</code></pre>

                    <h4>3.5 Phase 4ï¼šSignature Verificationï¼ˆæ•¸ä½ç°½ç« é©—è­‰ï¼‰</h4>
                    <p>ç¢ºä¿ã€Œé€šéå¯©æŸ¥çš„å…§å®¹ã€åœ¨ç™¼å¸ƒèˆ‡å®‰è£éç¨‹ä¸­æœªè¢«ç«„æ”¹ã€‚</p>

                    <p><strong>ç™¼å¸ƒç«¯</strong></p>
                    <ol>
                        <li>å° <code>manifest + entrypoint</code> åš SHA-256ã€‚</li>
                        <li>ç”¨ç™¼å¸ƒè€…ç§é‘°ç°½ç« ï¼Œç”¢ç”Ÿ <code>skill.sig</code>ã€‚</li>
                    </ol>

                    <p><strong>å¹³å°é©—è­‰ç«¯</strong></p>
                    <ol>
                        <li>å°æ”¶åˆ°çš„ <code>manifest + entrypoint</code> é‡æ–°è¨ˆç®— SHA-256ã€‚</li>
                        <li>ç”¨è¨»å†Šå…¬é‘°é©—è­‰ç°½ç« ã€‚</li>
                        <li>ä¸ä¸€è‡´å³æ‹’çµ•ä¸Šæ¶/å®‰è£ã€‚</li>
                    </ol>

                    <h4>3.6 å…©å€‹ Skill Pluginï¼ˆè½åœ°ç¤ºä¾‹ï¼‰</h4>
                    <ol>
                        <li><strong><code>system_info</code></strong>ï¼šæŸ¥è©¢ç³»çµ±æ™‚é–“ã€æ™‚å€ã€hostnameï¼›<code>network=false</code>ã€<code>exec=false</code>ï¼Œä¸¦åœ¨åŸ·è¡Œæ™‚ä»¥ <code>context.permissions.require()</code> å†åš runtime gateã€‚</li>
                        <li><strong><code>file_summarizer</code></strong>ï¼šè®€å–ç™½åå–®ç›®éŒ„æ–‡å­—æª”ï¼ŒåŒ…å«äº”å±¤é˜²è­·ï¼ˆnull byte é˜²è­·ã€<code>path.resolve()</code> æ­£è¦åŒ–ã€ç™½åå–®ç›®éŒ„æ¯”å°ã€å‰¯æª”åç™½åå–®ã€1MB å¤§å°é™åˆ¶ï¼‰ã€‚</li>
                    </ol>

                    <h4>3.7 ç¸±æ·±é˜²ç¦¦ç¸½çµ</h4>
                    <p><code>Phase 1 -> Phase 2 -> Phase 3 -> Phase 4</code> åˆ†åˆ¥è™•ç†å®£å‘Šåˆè¦ã€éœæ…‹é¢¨éšªã€å‹•æ…‹è¡Œç‚ºèˆ‡å®Œæ•´æ€§é©—è­‰ã€‚ä»»ä¸€éšæ®µå‘½ä¸­ <code>CRITICAL/ERROR</code> å³ä¸­æ­¢æµç¨‹ï¼Œé™ä½æƒ¡æ„ Skill é€²å…¥ç”Ÿæ…‹ç³»æ©Ÿç‡ã€‚</p>
                </div>
            </section>

            <section id="section-5">
                <h2>5. OpenClaw è‡ªè¨‚ Skill Plugin èˆ‡è‡ªå‹•åŒ– Agent å¯¦ä½œèªªæ˜</h2>

                <div id="section-5-1">
                    <h3>(1) è‡ªè¨‚ OpenClaw Skill Pluginï¼ˆ<code>todo-helper</code>ï¼‰</h3>
                    <p>å·²å¯¦ä½œå…¨æ–° pluginï¼š<code>extensions/todo-helper/</code>ï¼Œæä¾›ä¸‰å€‹å·¥å…·èƒ½åŠ›ï¼š</p>
                    <ol>
                        <li><code>local_time({ timezone? })</code>ï¼šå›å‚³æœ¬åœ°æˆ–æŒ‡å®šæ™‚å€æ™‚é–“ï¼ˆISOã€local stringã€epochï¼‰ã€‚</li>
                        <li><code>read_and_summarize({ path, maxBytes?, maxSentences? })</code>ï¼šåœ¨ allowlist è·¯å¾‘å…§è®€å–æª”æ¡ˆä¸¦å›å‚³æ‘˜è¦ã€‚</li>
                        <li><code>read_todo_snapshot({ path?, includeCompleted?, lookaheadHours? })</code>ï¼šè®€å– To-do å¿«ç…§ JSONï¼Œåˆ†é¡é€¾æœŸ / ä»Šæ—¥ / å³å°‡åˆ°æœŸ / æœªè¨­å®šåˆ°æœŸï¼Œä¸¦åš stale æª¢æŸ¥ã€‚</li>
                    </ol>
                    <p><strong>ç›¸é—œæª”æ¡ˆ</strong></p>
                    <ul>
                        <li><code>extensions/todo-helper/index.ts</code></li>
                        <li><code>extensions/todo-helper/openclaw.plugin.json</code></li>
                        <li><code>extensions/todo-helper/skills/todo-sync/SKILL.md</code></li>
                        <li><code>extensions/todo-helper/skills/todo-notify/SKILL.md</code></li>
                    </ul>
                </div>

                <div id="section-5-2">
                    <h3>(2) è‡ªå‹•åŒ– Agent å·¥ä½œæµç¨‹ï¼ˆè‡³å°‘å…©å€‹ skillï¼‰</h3>
                    <p>æœ¬å¯¦ä½œä½¿ç”¨ <strong>3 å€‹ skill</strong>ï¼ˆç¬¦åˆã€Œå…©å€‹ä»¥ä¸Š skillã€è¦æ±‚ï¼‰ï¼š</p>
                    <ol>
                        <li><code>todo-sync</code></li>
                        <li><code>organize-files</code></li>
                        <li><code>todo-notify</code></li>
                    </ol>

                    <p>æ’ç¨‹ï¼šæ¯æ—¥ <code>09:00</code>ï¼ˆæœ¬åœ°æ™‚å€ï¼‰å•Ÿå‹•ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
                    <ol>
                        <li><strong>todo-sync</strong>ï¼šå…ˆå‘¼å« <code>local_time</code>ï¼Œå†å‘¼å« <code>read_todo_snapshot</code>ï¼Œå®Œæˆé€¾æœŸ/ä»Šæ—¥/å³å°‡åˆ°æœŸåˆ†é¡èˆ‡ stale æª¢æŸ¥ã€‚</li>
                        <li><strong>organize-files</strong>ï¼šæ•´ç†æŒ‡å®šè³‡æ–™å¤¾ï¼ˆå¦‚ <code>~/Downloads</code>ï¼‰ï¼Œè¼¸å‡ºæ•´ç†çµæœã€‚</li>
                        <li><strong>todo-notify</strong>ï¼šç”Ÿæˆæé†’æ‘˜è¦ï¼ˆå«ä¸‹ä¸€æ­¥è¡Œå‹•ï¼‰ä¸¦ç™¼é€åˆ° <code>last route</code>ã€‚</li>
                    </ol>

                    <h4>è‡ªå‹•åŒ– Agent å·¥ä½œæµç¨‹åœ–</h4>
                    <div class="mermaid">flowchart TB
                        subgraph SCHEDULE["æ’ç¨‹è§¸ç™¼ (æ¯æ—¥ 09:00)"]
                            S1["Cron Job è§¸ç™¼"]
                        end

                        subgraph SYNC["Skill 1: todo-sync"]
                            S2["è®€å– SKILL.md"]
                            S3["å‘¼å« local_time å·¥å…·"]
                            S4["å‘¼å« read_todo_snapshot å·¥å…·"]
                            S5{"åˆ†æçµæœ"}
                            S6["åˆ†é¡: é€¾æœŸ/ä»Šæ—¥/å³å°‡åˆ°æœŸ/ç„¡åˆ°æœŸæ—¥"]
                            S7["Stale æª¢æŸ¥"]
                        end

                        subgraph ORGANIZE["Skill 2: organize-files"]
                            O1["è®€å– SKILL.md"]
                            O2["è®€å– inbox è³‡æ–™å¤¾"]
                            O3{"æª”æ¡ˆé¡å‹"}
                            O4["ç§»å‹•: documents (.pdf, .docx)"]
                            O5["ç§»å‹•: images (.jpg, .png)"]
                            O6["è¼¸å‡ºæ•´ç†çµæœ"]
                        end

                        subgraph NOTIFY["Skill 3: todo-notify"]
                            N1["è®€å– SKILL.md"]
                            N2["ç”Ÿæˆæ‘˜è¦å ±å‘Š"]
                            N3["åŒ…å«: Time / Snapshot Health / Priority Focus / Upcoming / File Organization / Next Step"]
                            N4["ç™¼é€åˆ° last route"]
                            N5["å®Œæˆ"]
                        end

                        SCHEDULE --> SYNC
                        S2 --> S3
                        S3 --> S4
                        S4 --> S5
                        S5 --> S6
                        S6 --> S7
                        S7 --> ORGANIZE

                        O1 --> O2
                        O2 --> O3
                        O3 -->|*.pdf, *.docx| O4
                        O3 -->|*.jpg, *.png| O5
                        O4 --> O6
                        O5 --> O6
                        O6 --> NOTIFY

                        N1 --> N2
                        N2 --> N3
                        N3 --> N4
                        N4 --> N5

                        style SCHEDULE fill:#e0f2fe,stroke:#075985
                        style SYNC fill:#dcfce7,stroke:#166534
                        style ORGANIZE fill:#fef9c3,stroke:#854d0e
                        style NOTIFY fill:#fee2e2,stroke:#991b1b
                    </div>

                    <h4>è©³ç´°è¨­å®šæ­¥é©Ÿï¼ˆå¯¦éš›å¯åŸ·è¡Œï¼‰</h4>

                    <p><strong>1) æº–å‚™ To-do snapshot æª”æ¡ˆï¼ˆè³‡æ–™ä¾†æºï¼‰</strong></p>
                    <ul>
                        <li>åœ¨ To-do å‰ç«¯é€£æ¥ snapshot æª”ï¼Œå»ºè­°ä½¿ç”¨ Host è·¯å¾‘ï¼š<code>/Users/silver/.openclaw/workspace/openclaw-data/todo-snapshot.json</code></li>
                        <li>Gateway å®¹å™¨å…§å°æ‡‰è·¯å¾‘ï¼š<code>/home/node/.openclaw/workspace/openclaw-data/todo-snapshot.json</code></li>
                    </ul>

                    <p><strong>2) è¨­å®š <code>todo-helper</code> plugin config</strong></p>
                    <p>åœ¨ <code>~/.openclaw/openclaw.json</code> ç¢ºèª <code>allowedRoots</code> èˆ‡ <code>defaultSnapshotPath</code>ï¼š</p>
                    <pre><code class="language-json">{
  "plugins": {
    "entries": {
      "todo-helper": {
        "enabled": true,
        "config": {
          "allowedRoots": [
            "/home/node/.openclaw/workspace/openclaw-data",
            "/home/node/.openclaw/workspace/automation-demo"
          ],
          "defaultSnapshotPath": "/home/node/.openclaw/workspace/openclaw-data/todo-snapshot.json",
          "maxReadBytes": 262144,
          "staleMinutes": 180,
          "enableReadSummary": true
        }
      }
    }
  }
}</code></pre>

                    <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose restart openclaw-gateway</code></pre>

                    <p><strong>3) å»ºç«‹/æ›´æ–° cron jobï¼ˆå›ºå®š skill é †åºï¼‰</strong></p>
                    <pre><code class="language-bash">AUTOMATION_MESSAGE=$(cat <<'PROMPT'
You are executing a cron automation verification run.

Mandatory requirements (do not skip):
1) Read /app/extensions/todo-helper/skills/todo-sync/SKILL.md.
2) Call local_time exactly once.
3) Call read_todo_snapshot exactly once with:
   /home/node/.openclaw/workspace/openclaw-data/todo-snapshot.json
4) Read /app/extensions/todo-helper/skills/organize-files/SKILL.md.
5) Use exec to organize /home/node/.openclaw/workspace/automation-demo/inbox:
   - documents: *.pdf, *.docx
   - images: *.jpg, *.png
   - top-level files only (maxdepth 1)
6) Read /app/extensions/todo-helper/skills/todo-notify/SKILL.md.

Final output headings:
Time
Snapshot Health
Priority Focus
Upcoming
File Organization
Next Step
PROMPT
)

cd /Users/silver/Documents/openclaw-main
docker compose run --rm openclaw-cli cron add \
  --name "verify-todo-workflow" \
  --cron "0 9 * * *" \
  --session isolated \
  --message "$AUTOMATION_MESSAGE" \
  --deliver \
  --channel last \
  --best-effort-deliver</code></pre>

                    <p>è‹¥ job å·²å­˜åœ¨ï¼Œæ”¹ç”¨ï¼š</p>
                    <pre><code class="language-bash">docker compose run --rm openclaw-cli cron edit &lt;jobId&gt; \
  --message "$AUTOMATION_MESSAGE" \
  --deliver \
  --channel last \
  --best-effort-deliver</code></pre>

                    <p><strong>4) æ‰‹å‹•è§¸ç™¼èˆ‡é©—è­‰ï¼ˆå« log å–è­‰ï¼‰</strong></p>
                    <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose run --rm openclaw-cli cron list
docker compose run --rm openclaw-cli cron run &lt;jobId&gt; --force --timeout 180000
docker compose run --rm openclaw-cli cron runs --id &lt;jobId&gt; --limit 5</code></pre>

                    <pre><code class="language-bash">docker compose exec openclaw-gateway sh -lc '
S=$(ls -t /home/node/.openclaw/agents/main/sessions/*.jsonl | head -n 1)
echo "$S"
grep -n "todo-sync\|organize-files\|todo-notify\|local_time\|read_todo_snapshot\|\"name\":\"exec\"" "$S" | sed -n "1,120p"
'</code></pre>

                    <p><strong>5) é©—æ”¶é‡é»</strong></p>
                    <ul>
                        <li>session log å¯çœ‹åˆ° <code>todo-sync -&gt; organize-files -&gt; todo-notify</code> å°æ‡‰è®€å–/å·¥å…·å‘¼å«ã€‚</li>
                        <li><code>read_todo_snapshot</code> ä½¿ç”¨ <code>openclaw-data/todo-snapshot.json</code> è·¯å¾‘ã€‚</li>
                        <li><code>organize-files</code> åªæ•´ç† top-level çš„ç›®æ¨™å‰¯æª”åæª”æ¡ˆã€‚</li>
                        <li>é‡è·‘å¾Œæª”æ¡ˆçµæ§‹ç¶­æŒä¸è®Šï¼ˆidempotentï¼‰ã€‚</li>
                        <li>è‹¥æœªè¨­å®š <code>--to</code> recipientï¼Œ<code>cron runs</code> å¯èƒ½é¡¯ç¤º <code>Delivery skipped</code>ï¼Œæ­¤æ™‚ä»¥ session log é©—è­‰æµç¨‹æ˜¯å¦å®Œæ•´åŸ·è¡Œã€‚</li>
                    </ul>

                    <p><strong>éŒ¯èª¤åˆ†æ”¯</strong></p>
                    <ul>
                        <li>è‹¥ snapshot è®€å–å¤±æ•—æˆ– staleï¼Œå›è¦†å¿…å«å¤±æ•—åŸå› èˆ‡ä¿®å¾©å»ºè­°ã€‚</li>
                    </ul>

                    <p><strong>å®Œæ•´æµç¨‹èˆ‡å‘½ä»¤å±•ç¤ºæ–‡ä»¶</strong></p>
                    <ul>
                        <li><code>docs/automation/todo-web-agent-workflow.md</code></li>
                    </ul>
                </div>
            </section>

            <section id="section-6">
                <h2>6. é™„ä»¶ï¼šå¦‚ä½•å•Ÿå‹•ï¼ˆFrontend + OpenClaw + Dockerï¼‰</h2>

                <h3>(1) å•Ÿå‹• OpenClaw Gatewayï¼ˆDockerï¼‰</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose up -d openclaw-gateway
docker compose ps openclaw-gateway</code></pre>

                <h3>(2) é–‹å•Ÿ Control UIï¼ˆå¸¶ Tokenï¼‰</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
source .env
open "http://127.0.0.1:18789/?token=$OPENCLAW_GATEWAY_TOKEN"</code></pre>

                <p>è‹¥å‡ºç¾ <code>pairing required</code>ï¼š</p>
                <pre><code class="language-bash">docker compose exec openclaw-gateway node dist/index.mjs devices list --json
docker compose exec openclaw-gateway node dist/index.mjs devices approve <requestId> --json</code></pre>

                <h3>(3) å•Ÿå‹• To-do å‰ç«¯</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/To-do
docker compose up -d --build todo-app
docker compose ps todo-app</code></pre>
                <p>ç€è¦½å™¨é–‹å•Ÿï¼š<code>http://localhost:8080</code></p>
                <p>ï¼ˆTo-do å°ˆæ¡ˆ compose æœå‹™ï¼š<code>todo-app</code>ï¼Œå®šç¾©æ–¼ <code>/Users/silver/Documents/To-do/docker-compose.yml</code>ï¼‰</p>

                <h3>(4) å®‰è£èˆ‡å•Ÿç”¨ <code>todo-helper</code> plugin</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose run --rm openclaw-cli plugins install ./extensions/todo-helper
docker compose run --rm openclaw-cli plugins enable todo-helper
docker compose restart openclaw-gateway</code></pre>

                <h3>(5) é©—è­‰æ’ç¨‹æµç¨‹ï¼ˆæ‰‹å‹•è§¸ç™¼ï¼‰</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose run --rm openclaw-cli cron list
docker compose run --rm openclaw-cli cron run <jobId> --force
docker compose run --rm openclaw-cli cron runs --id <jobId> --limit 20</code></pre>
            </section>
        </main>
    </div>
<script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";

    // Preserve original mermaid source for Section-3 collapsible re-rendering.
    document.querySelectorAll("#section-3-4 .diagram-collapsible .mermaid").forEach((el) => {
        el.dataset.mermaidSource = el.textContent.trim();
    });

    mermaid.initialize({
        startOnLoad: true,
        theme: "default",
        securityLevel: "strict",
        fontFamily: "Inter, Noto Sans TC, PingFang TC, Microsoft JhengHei, sans-serif",
        flowchart: {
            useMaxWidth: false,
            htmlLabels: false,
            nodeSpacing: 40,
            rankSpacing: 55,
            padding: 32
        }
    });

    async function rerenderMermaidInContent(contentEl) {
        const nodes = Array.from(contentEl.querySelectorAll(".mermaid"));
        if (!nodes.length) return;

        if (document.fonts && document.fonts.ready) {
            try {
                await document.fonts.ready;
            } catch (err) {
                console.warn("Font readiness check failed:", err);
            }
        }

        nodes.forEach((node) => {
            const source = node.dataset.mermaidSource || node.textContent.trim();
            node.innerHTML = source;
            node.removeAttribute("data-processed");
        });

        try {
            await mermaid.run({ nodes });
        } catch (err) {
            console.error("Mermaid re-render failed:", err);
        }
    }

    function setCollapsibleState(collapsible, open) {
        const header = collapsible.querySelector(".diagram-collapsible-header");
        const icon = header ? header.querySelector(".toggle-icon") : null;
        if (open) {
            collapsible.classList.add("open");
            if (icon) icon.textContent = "â–¼";
            if (header) header.setAttribute("aria-expanded", "true");
        } else {
            collapsible.classList.remove("open");
            if (icon) icon.textContent = "â–¶";
            if (header) header.setAttribute("aria-expanded", "false");
        }
    }

    // Collapsible diagrams - default collapsed, click header to expand.
    function initCollapsibleDiagrams() {
        const collapsibles = document.querySelectorAll("#section-3-4 .diagram-collapsible");

        collapsibles.forEach((collapsible) => {
            const header = collapsible.querySelector(".diagram-collapsible-header");
            const content = collapsible.querySelector(".diagram-collapsible-content");

            if (!header || !content) return;
            header.setAttribute("role", "button");
            header.setAttribute("tabindex", "0");
            setCollapsibleState(collapsible, false);

            const toggle = async () => {
                const willOpen = !collapsible.classList.contains("open");
                setCollapsibleState(collapsible, willOpen);
                if (willOpen) {
                    // Always re-render when expanding to avoid hidden-render layout issues.
                    await rerenderMermaidInContent(content);
                }
            };

            header.addEventListener("click", toggle);
            header.addEventListener("keydown", (event) => {
                if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault();
                    toggle();
                }
            });
        });
    }

    window.addEventListener("load", async () => {
        if (document.fonts && document.fonts.ready) {
            try {
                await document.fonts.ready;
            } catch (err) {
                console.warn("Initial font readiness check failed:", err);
            }
        }
        initCollapsibleDiagrams();
    });
</script>
</body>
</html>
