<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¡ˆå•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆç‹€æ…‹è¿½è¹¤ (Project Issues & Solutions Status)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color Palette */
            --primary-color: #2563eb;       /* Modern Blue */
            --primary-dark: #1e40af;
            --secondary-color: #475569;     /* Slate Gray */
            --bg-color: #f8fafc;            /* Light Grayish Blue */
            --card-bg: #ffffff;
            --text-color: #1e293b;          /* Dark Slate */
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            
            /* Status Colors */
            --success-bg: #dcfce7;
            --success-text: #166534;
            --warning-bg: #fef9c3;
            --warning-text: #854d0e;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            --info-bg: #e0f2fe;
            --info-text: #075985;
            --neutral-bg: #f1f5f9;
            --neutral-text: #475569;

            /* Spacing & Layout */
            --container-width: 100%;
            --sidebar-width: 280px;
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            
            /* Typography */
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            --font-zh: 'Noto Sans TC', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-main);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-zh), var(--font-main);
            color: var(--text-color);
            margin-bottom: 0.75em;
            font-weight: 700;
            line-height: 1.3;
        }

        h1 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 0; /* Reset margin for card context */
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        h2::before {
            content: '';
            display: block;
            width: 6px;
            height: 24px;
            background-color: var(--primary-color);
            border-radius: 4px;
        }

        h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            color: var(--secondary-color);
        }
        
        h4 {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-top: 1.25rem;
        }

        p {
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }
        
        strong {
            color: var(--text-color);
            font-weight: 600;
        }

        /* Layout */
        .container {
            max-width: var(--container-width);
            margin: 0;
            padding: 2rem;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            gap: 2.5rem;
            align-items: start;
        }

        /* Sidebar */
        .sidebar {
            grid-column: 1;
            position: sticky;
            top: 2rem;
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .sidebar h3 {
            font-size: 1.1rem;
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
        }

        .nav-link {
            display: block;
            color: var(--secondary-color);
            text-decoration: none;
            padding: 0.6rem 0.75rem;
            margin-bottom: 0.25rem;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: var(--neutral-bg);
            color: var(--primary-color);
        }
        
        .nav-link:active, .nav-link:focus {
             background-color: var(--info-bg);
             color: var(--primary-dark);
             border-left-color: var(--primary-color);
        }

        .nav-link.sub-link {
            padding-left: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .nav-link.sub-link:hover {
            color: var(--text-color);
        }

        /* Main Content */
        .main-content {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        section {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: box-shadow 0.3s ease;
        }
        
        section:hover {
            box-shadow: var(--shadow-md);
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th, td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        th {
            background-color: var(--neutral-bg);
            color: var(--secondary-color);
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: var(--bg-color);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1;
            white-space: nowrap;
        }

        .badge.done {
            background-color: var(--success-bg);
            color: var(--success-text);
        }

        .badge.pending {
            background-color: var(--warning-bg);
            color: var(--warning-text);
        }

        .badge.paused {
            background-color: var(--neutral-bg);
            color: var(--neutral-text);
        }
        
        /* Code & Pre */
        code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            background-color: var(--neutral-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--primary-dark);
            border: 1px solid var(--border-color);
        }

        pre {
            background-color: #1e293b; /* Dark theme for code blocks */
            color: #f8fafc;
            padding: 1.25rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
            border: none;
            font-size: inherit;
        }

        /* Mermaid Diagrams */
        .mermaid {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--neutral-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            display: block;
        }

        /* Section-3 detailed KG diagrams: keep natural SVG size and allow horizontal scroll */
        #section-3-4 .mermaid > svg {
            display: block;
            max-width: none !important;
            width: auto !important;
            height: auto !important;
            margin: 0 auto;
        }

        /* Collapsible Diagram Containers */
        .diagram-collapsible {
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .diagram-collapsible-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--neutral-bg);
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .diagram-collapsible-header:hover {
            background: var(--border-color);
        }

        .diagram-collapsible-header .toggle-icon {
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: color 0.2s ease;
            flex-shrink: 0;
            width: 1rem;
            text-align: center;
        }

        .diagram-collapsible-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .diagram-collapsible-content {
            display: none;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .diagram-collapsible.open .diagram-collapsible-content {
            display: block;
        }

        .diagram-collapsible-content .mermaid {
            margin-top: 0;
        }

        .diagram-collapsible-content p {
            margin-top: 1rem;
            margin-bottom: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Lists */
        ul, ol {
            padding-left: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--secondary-color);
        }

        li {
            margin-bottom: 0.5rem;
        }
        
        li::marker {
            color: var(--primary-color);
        }

        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary-color);
            background-color: var(--info-bg);
            color: var(--info-text);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }
        
        blockquote p {
            margin-bottom: 0;
            color: inherit;
        }

        /* Links */
        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        /* Utility */
        .text-sm {
            font-size: 0.875rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 240px 1fr;
                padding: 1.5rem;
                gap: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .sidebar {
                grid-column: 1;
                position: static;
                margin-bottom: 1.5rem;
                max-height: none;
            }
            
            .main-content {
                grid-column: 1;
            }
            
            section {
                padding: 1.5rem;
            }

            h1 {
                font-size: 1.75rem;
            }
            
            h2 {
                font-size: 1.35rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h3>ç›®éŒ„ (Table of Contents)</h3>
            <nav>
                <a href="#intro" class="nav-link">å°ˆæ¡ˆæ¦‚è¦½</a>
                <a href="#section-1" class="nav-link">1. ç›®å‰å•é¡Œè¿½è¹¤</a>
                <a href="#section-2" class="nav-link">2. é–‹æº LLM æ¨¡å‹ä½ˆç½²</a>
                <a href="#section-2-1" class="nav-link sub-link">(1) é¸æ“‡çš„é–‹æº LLM æ¨¡å‹</a>
                <a href="#section-2-2" class="nav-link sub-link">(2) éƒ¨ç½²æ–¹å¼</a>
                <a href="#section-2-3" class="nav-link sub-link">(3) éƒ¨ç½²é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±º</a>
                <a href="#section-3" class="nav-link">3. Domain Knowledge Graph</a>
                <a href="#section-3-step" class="nav-link sub-link">æ­¥é©Ÿèªªæ˜</a>
                <a href="#section-3-0" class="nav-link sub-link">(0) å¯¦ä½œå°æ‡‰</a>
                <a href="#section-3-1" class="nav-link sub-link">(1) åˆ©ç”¨ LLM å»ºç«‹ KG</a>
                <a href="#section-3-2" class="nav-link sub-link">(2) ä½¿ç”¨è€…å•é¡Œè½‰ Graph DB (NL2Cypher)</a>
                <a href="#section-3-3" class="nav-link sub-link">(3) é¸æ“‡ Neo4j çš„åŸå› </a>
                <a href="#section-3-4" class="nav-link sub-link">(4) è©³ç´°æµç¨‹åœ–</a>
                <a href="#section-4" class="nav-link">4. OpenClaw æ¶æ§‹èˆ‡æŠ€èƒ½å®‰å…¨åˆ†æ</a>
                <a href="#section-4-1" class="nav-link sub-link">(1) ç³»çµ±æ¶æ§‹èˆ‡ä¸»è¦çµ„ä»¶</a>
                <a href="#section-4-2" class="nav-link sub-link">(2) å®‰å…¨é¢¨éšªï¼ˆ3 å¤§é¡ 10 é …ï¼‰</a>
                <a href="#section-4-3" class="nav-link sub-link">(3) æŠ€èƒ½å®‰å…¨å¯©æŸ¥æ©Ÿåˆ¶</a>
                <a href="#section-5" class="nav-link">5. OpenClaw Skill Plugin èˆ‡ Agent</a>
                <a href="#section-5-1" class="nav-link sub-link">(1) è‡ªè¨‚ Plugin</a>
                <a href="#section-5-2" class="nav-link sub-link">(2) å¤š Skill è‡ªå‹•åŒ–æµç¨‹</a>
                <a href="#section-6" class="nav-link">6. é™„ä»¶ï¼šå¦‚ä½•å•Ÿå‹•</a>
            </nav>
        </aside>

        <main class="main-content">
            <section id="intro">
                <h1>å°ˆæ¡ˆå•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆç‹€æ…‹è¿½è¹¤ (Project Issues & Solutions Status)</h1>
                <p>æœ¬æ–‡ä»¶æ—¨åœ¨è¨˜éŒ„ OpenClaw å°ˆæ¡ˆé–‹ç™¼éç¨‹ä¸­çš„é—œéµå•é¡Œã€è§£æ±ºæ–¹æ¡ˆã€æ¶æ§‹æ±ºç­–ä»¥åŠæœªä¾†è¦åŠƒã€‚</p>
            </section>

            <section id="section-1">
                <h2>1. ç›®å‰å•é¡Œè¿½è¹¤ (Current Issues Tracking)</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%">å•é¡Œ (Problem)</th>
                                <th style="width: 50%">è§£æ³• (Solution)</th>
                                <th style="width: 20%">ç‹€æ…‹ (Status)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>æŠ½å–å¸¸å‡ºç¾ JSON ç ´æ/<think> å°è‡´ parse fail</strong></td>
                                <td>æŠ½å–åŠ  5 æ¬¡é‡è©¦ã€JSON ä¿®å¾© promptã€æé«˜è¼¸å‡º token ä¸Šé™ã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/llm_kg/kg_builder.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>å‰ç«¯é•·æ™‚é–“åªé¡¯ç¤º Processing...</strong></td>
                                <td>Text/File/URL æ”¹ async job + pollingï¼Œé¡¯ç¤º chunk é€²åº¦èˆ‡ç‹€æ…‹ã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/main.py</code>, <code class="text-sm">frontend/src/components/BuildKG.tsx</code></td>
                            </tr>
                            <tr>
                                <td><strong>é•·æ–‡æœ¬å°è‡´è¨˜æ†¶é«”å£“åŠ›ï¼ˆOOM é¢¨éšªï¼‰</strong></td>
                                <td>Ingest ç«¯æ”¹ç‚ºå…ˆåˆ‡ chunk å†é€å¡ŠæŠ½å–ï¼ˆprovider-aware token/char budgetï¼‰ï¼Œä¸¦æ”¯æ´ <code>chunk_limit</code> é™æµã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/logic.py</code>, <code class="text-sm">backend/main.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>KG å›ç­”å¤ªç”Ÿç¡¬ã€å¸¸å¸¶ã€Œæ ¹æ“šçŸ¥è­˜åœ–è­œã€å‰ç¶´</strong></td>
                                <td>/api/query æ”¹æˆå…ˆæŸ¥ rowsï¼Œå†ç”¨ QA LLM é‡å¯«ç­”æ¡ˆï¼Œå¤±æ•—æ‰ fallbackã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/logic.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>è²¡å ±å•ç­”æŠ“ä¸åˆ°è³‡æ–™ï¼ˆæŠ½å– ontology ä¸è¶³ï¼‰</strong></td>
                                <td>æ–°å¢ FinancialMetric/FiscalPeriod èˆ‡ HAS_FINANCIAL_METRIC/FOR_PERIODï¼Œä¸¦ä¿ç•™è²¡å ±å±¬æ€§ã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/llm_kg/kg_builder.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>è²¡å ± Cypher æœƒå‡ºç¾ã€Œç¡¬ç·¨ç¢¼å‡è³‡æ–™ã€</strong></td>
                                <td>åŠ å®ˆé–€ï¼Œç¦æ­¢å¸¸å€¼å½é€ ï¼›è²¡å ±å•é¡Œå¼·åˆ¶ä½¿ç”¨è²¡å ±é—œä¿‚è·¯å¾‘ï¼Œå¿…è¦æ™‚èµ° deterministic fallbackã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/llm_kg/nl2cypher.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>è²¡å ±é—œä¿‚æ›¾ç™¼ç”Ÿè·¨å­£åº¦èª¤é€£ï¼ˆQ2 metric é€£åˆ° Q3ï¼‰</strong></td>
                                <td>FOR_PERIOD åŠ ä¸€è‡´æ€§æª¢æŸ¥ï¼Œä¸ä¸€è‡´ç›´æ¥ä¸Ÿæ£„ã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/llm_kg/kg_builder.py</code></td>
                            </tr>
                            <tr>
                                <td><strong>MoM/YoY å•é¡Œè§¸ç™¼ Cypher syntax errorï¼ˆ500ï¼‰</strong></td>
                                <td>1. æ“´å……è²¡å ±åµæ¸¬è©ï¼ˆmom/yoy/æœˆå¢/å¹´å¢ï¼‰<br>2. æ–°å¢ Cypher èªæ³•å®ˆé–€ï¼ˆæ””æˆª label {function(...)} é¡å‹ï¼‰<br>3. é‡è©¦å¤±æ•—æ™‚å›å¯è§£é‡‹ç­”æ¡ˆè€Œä¸æ˜¯ 500</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span><br>(å»ºè­°å„ªå…ˆä¿®å¾©)</td>
                            </tr>
                            <tr>
                                <td><strong>ä¸€å¥å¤šå•ï¼ˆä¾‹å¦‚ã€Œè‘£äº‹é•· + å‰µè¾¦äººã€ï¼‰</strong></td>
                                <td>å¤šæ„åœ–æ‹†è§£æˆå¤š Cypher å†åˆä½µç­”æ¡ˆã€‚</td>
                                <td><span class="badge paused">â¸ï¸ ç›®å‰åˆ»æ„ä¸è™•ç†</span><br>(æš«ç·©)</td>
                            </tr>
                            <tr>
                                <td><strong>å¯¦é«”æ¼æŠ½å•é¡Œ</strong></td>
                                <td>Gemini èµ°å…©éšæ®µæŠ½å–ï¼šå…ˆç›¤é» entity æ¯”å° KG è£œé½Šï¼Œå†ç¬¬äºŒè¼ªæŠ½ relationã€‚</td>
                                <td><span class="badge done">âœ… å·²å®Œæˆ</span><br><code class="text-sm">backend/llm_kg/kg_builder.py</code>, <code class="text-sm">GEMINI_TWO_PASS_EXTRACTION=1</code></td>
                            </tr>
                            <tr>
                                <td><strong>OpenClaw Skill å®‰å…¨å¯©æŸ¥è¦†è“‹ä¸è¶³</strong></td>
                                <td>ç›®å‰åƒ…æœ‰ Regex éœæ…‹æª¢æŸ¥ï¼ˆ<code>skill_audit.ts</code>ï¼‰ï¼›éœ€è£œ AST åˆ†æã€æ²™ç®±å‹•æ…‹æ¸¬è©¦ã€ä¾†æºç°½ç« èˆ‡æ¬Šé™å¯©æ‰¹ã€‚</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span></td>
                            </tr>
                            <tr>
                                <td><strong>OpenClaw æ¬Šé™æ¨¡å‹ç²’åº¦ä¸è¶³</strong></td>
                                <td>å°å…¥ capability-based æ¬Šé™ï¼ˆæª”æ¡ˆ/ç¶²è·¯/å‘½ä»¤/å¤–éƒ¨ API åˆ†é›¢æˆæ¬Šï¼‰ï¼Œé«˜é¢¨éšªæ¬Šé™éœ€é›™é‡ç¢ºèªã€‚</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span></td>
                            </tr>
                            <tr>
                                <td><strong>OpenClaw æ©Ÿæ•æ†‘è­‰æ²»ç†ä¸è¶³</strong></td>
                                <td>ç¬¬ä¸‰æ–¹ API Token æ”¹ç”±å¯†é‘°ç®¡ç†èˆ‡éœæ…‹åŠ å¯†ä¿å­˜ï¼Œè£œ token è¼ªæ›¿ã€å¯©è¨ˆèˆ‡å¤–æ´©å‘Šè­¦ã€‚</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span></td>
                            </tr>
                            <tr>
                                <td><strong>OpenClaw Prompt Injection é¢¨éšª</strong></td>
                                <td>å° Skill å›å‚³å…§å®¹åŠ  trusted/untrusted æ¨™è¨˜ã€æ¨¡æ¿åŒ–åŒ…è£èˆ‡æŒ‡ä»¤éš”é›¢ï¼Œé˜»æ–·ã€Œå·¥å…·è¼¸å‡ºè¦†è“‹ç³»çµ±æŒ‡ä»¤ã€ã€‚</td>
                                <td><span class="badge pending">ğŸš§ å¾…å¯¦ä½œ</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-2">
                <h2>2. é–‹æº LLM æ¨¡å‹ä½ˆç½²è©³ç´°èªªæ˜</h2>

                <div id="section-2-1">
                    <h3>(1) é¸æ“‡çš„é–‹æº LLM æ¨¡å‹</h3>
                    <p>æœ¬å°ˆæ¡ˆæ¡ç”¨ <strong>Hybrid æ¨¡å¼</strong>ï¼Œä¸»è¦ä½¿ç”¨ <strong>Ollama (DeepSeek R1 / Qwen 3 / Ministral 3)</strong> ä½œç‚ºæœ¬åœ°é–‹æºæ¨¡å‹ï¼Œä¸¦æ”¯æ´åˆ‡æ›è‡³ <strong>Gemini 3 Pro (Preview)</strong>ï¼ˆæˆ–ç›¸å®¹æ–°ç‰ˆæœ¬ï¼‰ä»¥ç²å¾—æ›´é«˜å“è³ªçš„çŸ¥è­˜æŠ½å–ã€‚</p>
                    
                    <ul>
                        <li><strong>é¸æ“‡æ¨¡å‹</strong>: <code>deepseek-r1:8b</code> / <code>qwen3</code> / <code>ministral-3:14b</code> (é€é Ollama) æˆ– <code>gemini-3-pro-preview</code>ã€‚</li>
                        <li><strong>å„ªé» (Pros)</strong>:
                            <ul>
                                <li><strong>DeepSeek R1 / Qwen 3</strong>: æ”¯æ´ <strong>Chain of Thought (CoT)</strong> æ€ç¶­éˆï¼Œé‚è¼¯æ¨ç†èƒ½åŠ›é¡¯è‘—å¢å¼·ï¼Œé©åˆè™•ç†è¤‡é›œæŒ‡ä»¤ï¼ŒåŒæ™‚ä¿æœ‰æœ¬åœ°éƒ¨ç½²çš„éš±ç§å„ªå‹¢èˆ‡ç„¡ API æˆæœ¬ã€‚</li>
                                <li><strong>Ministral 3 (14B)</strong>: åœ¨ <strong>æŒ‡ä»¤éµå®ˆ</strong> èˆ‡ <strong>çµæ§‹åŒ–è¼¸å‡º</strong> è¡¨ç¾ç©©å®šï¼Œç‰¹åˆ¥é©åˆ <strong>NL2Cypher</strong> ä»»å‹™ï¼ˆå¯é™ä½ Cypher ç”Ÿæˆåé¡Œèˆ‡æ ¼å¼æ¼‚ç§»ï¼‰ã€‚</li>
                                <li><strong>Gemini 3 Pro</strong>: æ“æœ‰è¶…é•· Context Window (<strong>1,048,576 input tokens</strong>) èˆ‡å¼·å¤§çš„é‚è¼¯æ¨ç†èƒ½åŠ›ï¼Œå°æ–¼è¤‡é›œçš„å¯¦é«”é—œä¿‚æŠ½å– (NER/RE) æº–ç¢ºç‡é€šå¸¸å„ªæ–¼å°åƒæ•¸æ¨¡å‹ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>ç¼ºé» (Cons)</strong>:
                            <ul>
                                <li><strong>DeepSeek R1 / Qwen 3</strong>: åœ¨å•Ÿç”¨ thinking æˆ–è¼¸å‡ºç´„æŸä¸è¶³æ™‚ï¼Œå¯èƒ½æ··å…¥æ€è€ƒå…§å®¹/è¨»é‡‹è€Œå°è‡´ JSON è§£æå¤±æ•— (Parse Fail)ï¼›ä¸” CoT å¯èƒ½å¢åŠ æ¨è«–æ™‚é–“ã€‚éœ€æ­é… <code>think=false</code>/<code>hidethinking</code> èˆ‡å¾Œè™•ç†ä¿è­·ã€‚</li>
                                <li><strong>Gemini 3 Pro</strong>: ä¾è³´ç¶²è·¯ï¼Œæœ‰ API Rate Limit é™åˆ¶èˆ‡æˆæœ¬ï¼Œä¸”å­˜åœ¨æ•¸æ“šå‚³è¼¸éš±ç§è€ƒé‡ã€‚</li>
                            </ul>
                        </li>
                    </ul>

                    <h4>å®˜æ–¹ Benchmark åƒè€ƒï¼ˆæˆªè‡³ 2026-02-15ï¼‰</h4>
                    <blockquote>è¨»ï¼šä»¥ä¸‹ç‚ºå®˜æ–¹æ¨¡å‹å¡/å®˜æ–¹é é¢å…¬å¸ƒçš„æˆç¸¾ï¼Œä¸åŒæ¨è«–æ¡†æ¶ã€é‡åŒ–ç‰ˆæœ¬ã€sampling è¨­å®šä¸‹ï¼Œå¯¦æ¸¬çµæœå¯èƒ½æµ®å‹•ã€‚</blockquote>

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ¨¡å‹</th>
                                    <th>å®˜æ–¹æ¸¬è©¦æŒ‡æ¨™</th>
                                    <th>åˆ†æ•¸</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>deepseek-r1:8b</code>ï¼ˆOllama å°æ‡‰ <code>DeepSeek-R1-0528-Qwen3-8B</code>ï¼‰</td>
                                    <td>AIME24 / AIME25 / GPQA-Diamond / LiveCodeBench</td>
                                    <td><strong>86.0 / 76.3 / 61.1 / 60.5</strong></td>
                                </tr>
                                <tr>
                                    <td><code>qwen3:8b</code>ï¼ˆThinking, bf16ï¼‰</td>
                                    <td>LiveBench / GPQA / MMLU-Redux / AIME24</td>
                                    <td><strong>67.1 / 62.0 / 87.5 / 76.0</strong></td>
                                </tr>
                                <tr>
                                    <td><code>qwen3:8b</code>ï¼ˆNon-Thinking, bf16ï¼‰</td>
                                    <td>LiveBench / GPQA / MMLU-Redux</td>
                                    <td><strong>53.5 / 39.3 / 79.5</strong></td>
                                </tr>
                                <tr>
                                    <td><code>ministral-3:14b</code>ï¼ˆReasoningï¼‰</td>
                                    <td>AIME25 / AIME24 / GPQA-Diamond / LiveCodeBench</td>
                                    <td><strong>85.0 / 89.8 / 71.2 / 64.6</strong></td>
                                </tr>
                                <tr>
                                    <td><code>ministral-3:14b</code>ï¼ˆInstructï¼‰</td>
                                    <td>Arena Hard / WildBench / MATH Maj@1 / MM MTBench</td>
                                    <td><strong>55.1 / 68.5 / 90.4 / 8.49</strong></td>
                                </tr>
                                <tr>
                                    <td><code>gemini-3-pro-preview</code></td>
                                    <td>Humanity's Last Exam / GPQA-Diamond / AIME 2025 / MMMU-Pro</td>
                                    <td><strong>37.5 / 91.9 / 95.0 / 81.0</strong></td>
                                </tr>
                                <tr>
                                    <td><code>gemini-3-pro-preview</code></td>
                                    <td>Token limits</td>
                                    <td><strong>Input 1,048,576 / Output 65,536</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p><strong>è³‡æ–™ä¾†æºï¼ˆå®˜æ–¹ï¼‰</strong></p>
                    <ol>
                        <li>DeepSeek æ¨¡å‹å¡ï¼š<a href="https://huggingface.co/deepseek-ai/DeepSeek-R1-0528" target="_blank">https://huggingface.co/deepseek-ai/DeepSeek-R1-0528</a></li>
                        <li>Qwen3 8B æ¨¡å‹å¡ï¼š<a href="https://huggingface.co/Qwen/Qwen3-8B-AWQ" target="_blank">https://huggingface.co/Qwen/Qwen3-8B-AWQ</a></li>
                        <li>Ministral 3 14B æ¨¡å‹å¡ï¼š<a href="https://huggingface.co/mistralai/Ministral-3-14B-Instruct-2512" target="_blank">https://huggingface.co/mistralai/Ministral-3-14B-Instruct-2512</a></li>
                        <li>Gemini 3 Pro benchmark: <a href="https://deepmind.google/technologies/gemini/pro/" target="_blank">https://deepmind.google/technologies/gemini/pro/</a></li>
                        <li>Gemini 3 Pro token limits: <a href="https://ai.google.dev/gemini-api/docs/models/gemini" target="_blank">https://ai.google.dev/gemini-api/docs/models/gemini</a></li>
                    </ol>

                    <p><strong>è§£è®€æ–¹å¼ï¼ˆå°æ‡‰ä½ çš„ä»»å‹™ï¼‰</strong></p>
                    <ul>
                        <li>NER/REï¼šå¯å„ªå…ˆåƒè€ƒ GPQAã€AIMEã€HLE é€™é¡æ¨ç†/çŸ¥è­˜å¯†é›†æŒ‡æ¨™ï¼Œä½œç‚ºã€Œè¤‡é›œé—œä¿‚æŠ½å–èƒ½åŠ›ã€çš„è¿‘ä¼¼ä»£ç†ã€‚</li>
                        <li>NL2Cypherï¼šå¯å„ªå…ˆåƒè€ƒ Arena Hardã€WildBenchã€MM MTBench èˆ‡æ¨¡å‹æ˜¯å¦åŸç”Ÿæ”¯æ´ function calling / JSON outputsï¼Œä½œç‚ºã€ŒæŒ‡ä»¤éµå®ˆ + çµæ§‹åŒ–è¼¸å‡ºã€çš„è¿‘ä¼¼ä»£ç†ã€‚</li>
                        <li>ç›®å‰æ²’æœ‰å–®ä¸€å®˜æ–¹ benchmark å¯ä»¥ç›´æ¥ç­‰åŒ NER/RE æˆ– NL2Cypherï¼Œä»å»ºè­°ä¿ç•™å°ˆæ¡ˆå…§éƒ¨å›æ­¸æ¸¬è©¦é›†ä½œæœ€çµ‚ä¾æ“šã€‚</li>
                    </ul>
                </div>

                <div id="section-2-2">
                    <h3>(2) éƒ¨ç½²æ–¹å¼</h3>
                    <p>ä½¿ç”¨ <strong>Docker Container</strong> é€²è¡Œå¾®æœå‹™åŒ–éƒ¨ç½²ï¼š</p>
                    <ol>
                        <li><strong>Ollama Service</strong>: ä½¿ç”¨å®˜æ–¹ <code>ollama/ollama</code> Docker æ˜ åƒæª”ï¼Œæ›è¼‰ GPU (å¦‚æ”¯æ´) é€²è¡Œæœ¬åœ°æ¨è«–ã€‚</li>
                        <li><strong>API Wrapper</strong>: é–‹ç™¼ <code>backend/llm_kg/llm_deploy.py</code> (åŸºæ–¼ FastAPI)ï¼Œä½œç‚ºçµ±ä¸€äººå·¥æ™ºæ…§ä»‹é¢å±¤ (<code>backend/llm_kg/llm_client.py</code>)ã€‚
                            <ul>
                                <li>æ­¤å±¤è² è²¬è™•ç†ä¸åŒ Provider (Ollama/OpenAI/Gemini) çš„ API å·®ç•°ã€‚</li>
                                <li>é€éç’°å¢ƒè®Šæ•¸ (<code>LLM_PROVIDER</code>) å‹•æ…‹åˆ‡æ›å¾Œç«¯æ¨¡å‹ï¼Œç„¡éœ€ä¿®æ”¹ç¨‹å¼ç¢¼ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Orchestration</strong>: ä½¿ç”¨ <code>backend/llm_kg/docker-compose.llmkg.yml</code> å®šç¾©æœå‹™ä¾è³´èˆ‡ç¶²çµ¡ã€‚</li>
                    </ol>
                </div>

                <div id="section-2-3">
                    <h3>(3) éƒ¨ç½²é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±º</h3>
                    <ul>
                        <li><strong>å•é¡Œ 1: JSON æ ¼å¼ç ´æ (Malformed JSON)</strong>
                            <ul>
                                <li><strong>ç‹€æ³</strong>: é–‹æºæ¨¡å‹ (DeepSeek R1 / Qwen 3) åœ¨ç‰¹å®šè¨­å®šä¸‹å¯èƒ½è¼¸å‡ºæ€è€ƒå…§å®¹ã€ä¸å®Œæ•´ JSON æˆ– Markdown è¨»é‡‹ï¼Œå°è‡´ <code>json.loads</code> å¤±æ•—ã€‚</li>
                                <li><strong>è§£æ±º</strong>: åœ¨ <code>backend/llm_kg/kg_builder.py</code> å¯¦ä½œ <strong>Retry & Repair Loop</strong>ã€‚å„ªå…ˆé€éæ¨¡å‹åƒæ•¸é—œé–‰/éš±è— thinkingï¼Œå†æ–¼è§£æå¤±æ•—æ™‚å›å‚³éŒ¯èª¤çµ¦ LLM è¦æ±‚ä¿®æ­£ JSONï¼Œæœ€å¤šé‡è©¦ 5 æ¬¡ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>å•é¡Œ 2: å›æ‡‰è¶…æ™‚ (Timeout)</strong>
                            <ul>
                                <li><strong>ç‹€æ³</strong>: è™•ç†é•·æ–‡æœ¬è²¡å ±æ™‚ï¼ŒLLM ç”Ÿæˆæ™‚é–“éé•·å°è‡´ HTTP 504 Gateway Timeoutã€‚</li>
                                <li><strong>è§£æ±º</strong>: å‰ç«¯æ”¹ç‚º <strong>Async Job + Polling</strong> æ©Ÿåˆ¶ã€‚ä¸Šå‚³æ–‡ä»¶å¾Œå›å‚³ Job IDï¼Œå‰ç«¯æ¯éš”å¹¾ç§’æŸ¥è©¢é€²åº¦ï¼Œé¿å…é•·é€£æ¥æ–·é–‹ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>å•é¡Œ 3: æ€ç¶­éˆ (Chain of Thought) å¹²æ“¾</strong>
                            <ul>
                                <li><strong>ç‹€æ³</strong>: éƒ¨åˆ†æ¨¡å‹åœ¨ thinking æ¨¡å¼ä¸‹å¯èƒ½è¼¸å‡ºé¡å¤–æ¨ç†å…§å®¹ï¼Œå¹²æ“¾ JSON çµæ§‹ã€‚</li>
                                <li><strong>è§£æ±º</strong>: å…ˆç”¨æ¨¡å‹åƒæ•¸é—œé–‰/éš±è— thinkingï¼ˆ<code>think=false</code> æˆ– <code>hidethinking</code>ï¼‰ï¼Œä¸¦åœ¨ Prompt ç¦æ­¢è¼¸å‡ºæ€è€ƒéç¨‹ï¼›å¾Œè™•ç† Regex æ¸…æ´—ä½œç‚ºæœ€å¾Œä¿éšªã€‚</li>
                            </ul>
                        </li>
                        <li><strong>å•é¡Œ 4: é•·æ–‡ä»¶é€ æˆè¨˜æ†¶é«”å£“åŠ›ï¼ˆOOM é¢¨éšªï¼‰</strong>
                            <ul>
                                <li><strong>ç‹€æ³</strong>: å–®æ¬¡æŠŠæ•´ä»½é•·æ–‡ä»¶ä¸Ÿå…¥æŠ½å–æµç¨‹ï¼Œæœƒæ”¾å¤§ token/è¨˜æ†¶é«”è² è¼‰ï¼Œåœ¨æœ¬åœ°æ©Ÿæˆ–å®¹å™¨è³‡æºæœ‰é™æ™‚å®¹æ˜“ä¸ç©©å®šã€‚</li>
                                <li><strong>è§£æ±º</strong>: åœ¨ <code>backend/logic.py</code> å°‡ Text/File/URL ingest æ”¹ç‚º <strong>chunk-first pipeline</strong>ï¼š
                                    <ul>
                                        <li>å…ˆä¾ provider åšåˆ‡å¡Šï¼šGemini é è¨­ token budgetï¼Œå…¶ä»– provider é è¨­ char budgetï¼ˆå¯ç”± <code>CHUNK_SIZE_MODE</code> å¼·åˆ¶åˆ‡æ›ï¼‰ã€‚</li>
                                        <li>å°è¶…é•·æ®µè½åšäºŒæ¬¡åˆ‡åˆ†ï¼ˆtoken overflow segment splitï¼‰ï¼Œé¿å…å–®å¡Šè¶…éä¸Šé™ã€‚</li>
                                        <li>é€ chunk æŠ½å–ä¸¦å¯«å…¥ KGï¼Œæ­é… <code>chunk_limit</code>/<code>INGEST_CHUNK_LIMIT</code> æ§åˆ¶å–®æ¬¡è™•ç†é‡ï¼Œé™ä½ OOM èˆ‡é•·è«‹æ±‚å¤±æ•—ç‡ã€‚</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </section>

            <section id="section-3">
                <h2>3. Domain Knowledge Graph å»ºç«‹è©³ç´°èªªæ˜</h2>

                <div id="section-3-step">
                    <h3>æ­¥é©Ÿèªªæ˜</h3>
                    <ul>
                        <li><strong>æ•¸æ“šä¾†æº</strong>: ä¼æ¥­è²¡å‹™å ±å‘Š (Financial Reports) èˆ‡æ–°èç¨¿ (ç¯„ä¾‹ï¼šé´»æµ·ã€å°ç©é›»)ã€‚</li>
                        <li><strong>Graph DB</strong>: é¸æ“‡ <strong>Neo4j (Community Edition v5)</strong>ã€‚</li>
                        <li><strong>å»ºç½®æµç¨‹</strong>: ä½¿ç”¨ <code>backend/llm_kg/kg_builder.py</code> é€²è¡Œè‡ªå‹•åŒ–å»ºç½®ã€‚</li>
                        <li><strong>å¤§æª”è™•ç†ç­–ç•¥</strong>: é€é <code>backend/logic.py</code> å…ˆåš chunkingï¼ˆtoken/char budgetï¼‰ï¼Œå†é€å¡Šå‘¼å« <code>backend/llm_kg/kg_builder.py</code> æŠ½å–èˆ‡ upsertï¼Œé¿å…å–®æ¬¡å¤§ä¸Šä¸‹æ–‡é€ æˆ OOMã€‚</li>
                    </ul>
                </div>

                <div id="section-3-0">
                    <h3>(0) å¯¦ä½œå°æ‡‰ï¼šå¯¦é«”/é—œä¿‚æŠ½å–èˆ‡ Neo4j å¯«å…¥</h3>
                    <ul>
                        <li><strong>æŠ½å–æ¡†æ¶</strong>: æœ¬å°ˆæ¡ˆä¸æ˜¯ä½¿ç”¨å‚³çµ± NER/RE å¥—ä»¶ï¼ˆå¦‚ spaCy stanzaï¼‰åšè¦å‰‡å¼æŠ½å–ï¼Œè€Œæ˜¯æ¡ç”¨ <code>backend/llm_kg/kg_builder.py</code> çš„ <strong>LLM JSON æŠ½å–æµç¨‹</strong>ã€‚</li>
                        <li><strong>LLM å‘¼å«å±¤</strong>: ä½¿ç”¨è‡ªå»º <code>backend/llm_kg/llm_client.py</code>ï¼ˆåº•å±¤å¥—ä»¶ç‚º <code>requests</code>ï¼‰çµ±ä¸€å‘¼å« <code>openai-compatible / ollama / gemini</code>ï¼Œå†ç”± Prompt ç´„æŸè¼¸å‡ºå›ºå®š JSON çµæ§‹ã€‚</li>
                        <li><strong>æŠ½å–ç­–ç•¥</strong>:
                            <ul>
                                <li>é è¨­ Single-passï¼šä¸€æ¬¡è¼¸å‡º <code>entities + relations</code>ã€‚</li>
                                <li>Gemini å¯å•Ÿç”¨ Two-passï¼ˆ<code>GEMINI_TWO_PASS_EXTRACTION=1</code>ï¼‰ï¼šå…ˆå¯¦é«”ç›¤é»ï¼Œå†ä»¥ seed entities æŠ½é—œä¿‚ï¼Œä¸¦å…ˆè£œé½Š KG ç¼ºæ¼å¯¦é«”å¾Œå†åšç¬¬äºŒéšæ®µé—œä¿‚æŠ½å–ã€‚</li>
                                <li>è§£æå¤±æ•—æ™‚æœ‰ Retry & Repairï¼ˆæœ€å¤š 5 æ¬¡ï¼‰ä»¥ä¿®å¾© JSONã€‚</li>
                            </ul>
                        </li>
                        <li><strong>æŠ½å–å¾Œæ¸…æ´— (Post-processing)</strong>:
                            <ul>
                                <li>ä¾ç™½åå–®é™åˆ¶ entity/relation typeï¼ˆschema constraintsï¼‰ã€‚</li>
                                <li>åš alias/canonical name åˆä½µèˆ‡æ¨¡ç³Šæ¯”å°ï¼Œé™ä½åŒå¯¦é«”å¤šå¯«æ³•å•é¡Œã€‚</li>
                                <li>æª¢æŸ¥é—œä¿‚æ–¹å‘èˆ‡è²¡å ±å­£åº¦ä¸€è‡´æ€§ï¼ˆä¾‹å¦‚ <code>FOR_PERIOD</code> ä¸å…è¨±è·¨å­£åº¦èª¤é€£ï¼‰ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Neo4j å¯«å…¥æ–¹å¼</strong>ï¼ˆ<code>neo4j</code> Python driverï¼‰:
                            <ol>
                                <li><code>_ensure_constraints()</code>ï¼šå»ºç«‹å”¯ä¸€éµèˆ‡ç´¢å¼•ï¼ˆ<code>Entity.name</code> uniqueã€<code>normalizedName</code> indexï¼‰ã€‚</li>
                                <li><code>_create_entity()</code>ï¼šä½¿ç”¨ <code>MERGE</code> upsert ç¯€é»ï¼Œç¯€é»åŒæ™‚å¸¶æœ‰å…·é«” labelï¼ˆå¦‚ <code>:Organization</code>ï¼‰èˆ‡å…±é€š <code>:Entity</code>ã€‚</li>
                                <li><code>_create_relation()</code>ï¼šä½¿ç”¨ <code>MERGE (a)-[:REL]->(b)</code> upsert é—œä¿‚ã€‚</li>
                                <li><code>populate_graph()</code>ï¼šé€ç­†å¯«å…¥ entities/relationsï¼Œå›å‚³çµ±è¨ˆï¼ˆupsert æ•¸ã€drop æ•¸ã€json retriesï¼‰ã€‚</li>
                            </ol>
                        </li>
                        <li><strong>æµç¨‹é‚Šç•Œèªªæ˜</strong>: <code>GraphCypherQAChain</code> å±¬æ–¼ <strong>NL2Cypher æŸ¥è©¢éšæ®µ</strong>ï¼ˆ<code>backend/llm_kg/nl2cypher.py</code>ï¼‰ï¼Œä¸æ˜¯å¯¦é«”/é—œä¿‚æŠ½å–éšæ®µã€‚</li>
                    </ul>
                </div>

                <div id="section-3-1">
                    <h3>(1) åˆ©ç”¨ LLM å»ºç«‹ Knowledge Graph</h3>
                    <ul>
                        <li><strong>æ–¹æ³•</strong>: æ¡ç”¨ <strong>Two-Pass Extraction (å…©éšæ®µæŠ½å–æ³•)</strong>ã€‚
                            <ul>
                                <li><strong>Phase 1 (Entity Inventory)</strong>: å…ˆè®“ LLM æƒæå…¨æ–‡ï¼Œåˆ—å‡ºæ‰€æœ‰å¯¦é«” (Entities)ï¼Œé€²è¡Œæ¨™æº–åŒ– (Canonicalization)ã€‚</li>
                                <li><strong>Phase 2 (Relation Extraction)</strong>: å°‡ç¬¬ä¸€éšæ®µçš„å¯¦é«”æ¸…å–®ä½œç‚º Context é¤µçµ¦ LLMï¼Œè¦æ±‚å…¶æ‰¾å‡ºå¯¦é«”é–“çš„é—œä¿‚ (Relations)ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±º</strong>:
                            <ul>
                                <li><strong>å¯¦é«”æ­§ç¾© (Entity Ambiguity)</strong>: åŒä¸€å…¬å¸æœ‰å¤šç¨®å¯«æ³• (e.g., "é´»æµ·", "Hon Hai", "Foxconn")ã€‚
                                    <ul>
                                        <li><strong>è§£æ±º</strong>: å¯¦ä½œ <code>_resolve_entity_reference</code> èˆ‡ <code>SequenceMatcher</code> æ¨¡ç³Šæ¯”å°ï¼Œå°‡åˆ¥åæ˜ å°„åˆ°å–®ä¸€æ¨™æº–åç¨± (Canonical Name)ã€‚</li>
                                    </ul>
                                </li>
                                <li><strong>å¹»è¦ºé—œä¿‚ (Hallucinated Relations)</strong>: LLM å‰µé€ ä¸å­˜åœ¨çš„é—œä¿‚é¡å‹ã€‚
                                    <ul>
                                        <li><strong>è§£æ±º</strong>: è¨­å®š <strong>Schema Constraints (Ontology)</strong>ï¼Œåƒ…å…è¨±ç‰¹å®šçš„ Node Labels (e.g., <code>Organization</code>, <code>Person</code>) èˆ‡ Relation Types (e.g., <code>FOUNDED_BY</code>, <code>SUPPLIES_TO</code>)ï¼Œéæ¿¾æ‰ä¸ç¬¦åˆ Schema çš„è¼¸å‡ºã€‚</li>
                                    </ul>
                                </li>
                                <li><strong>é—œä¿‚ç™½åå–®ï¼ˆSchema Constraintsï¼‰ç­–ç•¥è©•ä¼°</strong>:
                                    <ul>
                                        <li><strong>å¥½è™• (Pros)</strong>:
                                            <ul>
                                                <li><strong>æé«˜æº–ç¢ºç‡ (Precision)</strong>ï¼šå¯ç›´æ¥éæ¿¾ä¸åœ¨æœ¬é«”ä¸­çš„é—œä¿‚é¡å‹ï¼Œé™ä½ LLM å¹»è¦ºé—œä¿‚é€²å…¥ KG çš„æ©Ÿç‡ã€‚</li>
                                                <li><strong>æŸ¥è©¢ç©©å®šæ€§æ›´é«˜</strong>ï¼šNL2Cypher åƒ…éœ€é¢å°æœ‰é™ä¸”å·²å®šç¾©çš„é—œä¿‚é›†åˆï¼Œè¼ƒä¸æ˜“å‡ºç¾èªæ„æ¼‚ç§»èˆ‡éŒ¯æŸ¥ã€‚</li>
                                                <li><strong>æ²»ç†èˆ‡æ¸¬è©¦æˆæœ¬å¯æ§</strong>ï¼šé—œä¿‚é›†åˆå›ºå®šå¾Œï¼Œå›æ­¸æ¸¬è©¦ã€ç›£æ§æŒ‡æ¨™ï¼ˆå¦‚ <code>dropped_relations</code>ï¼‰èˆ‡ç¨½æ ¸æµç¨‹æ›´å®¹æ˜“è½åœ°ã€‚</li>
                                            </ul>
                                        </li>
                                        <li><strong>ç¼ºé» (Cons)</strong>:
                                            <ul>
                                                <li><strong>å¬å›ç‡ (Recall) ä¸‹é™</strong>ï¼šæ–°å‡ºç¾æˆ–é•·å°¾é—œä¿‚å¯èƒ½è¢«ç›´æ¥ä¸Ÿæ£„ï¼Œé€ æˆçŸ¥è­˜è¦†è“‹ä¸è¶³ã€‚</li>
                                                <li><strong>ç¶­è­·æˆæœ¬ä¸Šå‡</strong>ï¼šæ¯æ¬¡æ–°å¢æ¥­å‹™èªæ„éƒ½éœ€åŒæ­¥èª¿æ•´ ontology/prompt/æ¸¬è©¦ï¼Œç‰ˆæœ¬æ¼”é€²é€Ÿåº¦è¼ƒæ…¢ã€‚</li>
                                                <li><strong>æ¢ç´¢èƒ½åŠ›å—é™</strong>ï¼šç³»çµ±åå‘æ—¢æœ‰é—œä¿‚ï¼Œè¼ƒä¸åˆ©æ–¼æ—©æœŸç™¼æ˜æ–°é—œè¯ï¼›å»ºè­°æ­é…å€™é¸é—œä¿‚æš«å­˜æ± ä½œè£œå¼·ã€‚</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div id="section-3-2">
                    <h3>(2) ä½¿ç”¨è€…å•é¡Œè½‰ Graph DB æŸ¥è©¢ (NL2Cypher)</h3>
                    <ul>
                        <li><strong>æ–¹æ³•</strong>: <code>backend/llm_kg/nl2cypher.py</code> æ¡ <strong>é›™è·¯å¾‘ç­–ç•¥</strong>ï¼š
                            <ul>
                                <li><strong>Path A (LangChain)</strong>: ä½¿ç”¨ <code>GraphCypherQAChain + Neo4jGraph</code> ç›´æ¥å°‡è‡ªç„¶èªè¨€è½‰ Cypherï¼ˆéœ€å®‰è£ <code>langchain</code>/<code>langchain-community</code>ï¼Œä¸”ç›®å‰å¯¦ä½œé™åˆ¶ <code>LLM_PROVIDER=ollama</code>ï¼‰ã€‚</li>
                                <li><strong>Path B (Manual)</strong>: ä½¿ç”¨ <strong>Ministral 3 (14B)</strong> æ­é… <strong>Schema-Aware Prompting</strong> èˆ‡ä¿®å¾©é‡è©¦ï¼ˆself-correctionï¼‰æµç¨‹ã€‚</li>
                                <li>è‹¥ LangChain ä¾è³´æœªå®‰è£æˆ– provider ä¸ç¬¦ï¼Œæœƒè‡ªå‹• fallback åˆ° Manual è·¯å¾‘ï¼Œç¢ºä¿æŸ¥è©¢æµç¨‹ä¸ä¸­æ–·ã€‚</li>
                                <li>Manual è·¯å¾‘æœƒå°‡ Graph Schema (ç¯€é»é¡å‹ã€é—œä¿‚ã€å±¬æ€§) æ³¨å…¥ Promptï¼Œä¸¦ç”¨ Few-Shot Examples å¼•å° Cypher ç”Ÿæˆã€‚</li>
                            </ul>
                        </li>
                    </ul>

                    <h4>ä½¿ç”¨ <code>GraphCypherQAChain</code> çš„å¥½è™•ï¼ˆå®˜æ–¹æ–‡ä»¶å°æ‡‰ï¼‰</h4>
                    <ul>
                        <li><strong>ç«¯åˆ°ç«¯æµç¨‹å…§å»º</strong>ï¼šå¯ç›´æ¥å®Œæˆã€Œè‡ªç„¶èªè¨€å•é¡Œ -> ç”¢ç”Ÿ Cypher -> æŸ¥ Neo4j -> ç”Ÿæˆç­”æ¡ˆã€ï¼Œæ¸›å°‘è‡ªè¡Œä¸²æ¥ prompt/executor/answerer çš„æ¨£æ¿ç¨‹å¼ã€‚</li>
                        <li><strong>Schema å°å‘ï¼Œé™ä½äº‚ç”ŸæŸ¥è©¢</strong>ï¼šå®˜æ–¹æ•´åˆæ–‡ä»¶ç¤ºç¯„ä»¥åœ–è­œ schema ç”Ÿæˆ Cypherï¼Œä¸”å¯ <code>refresh_schema()</code>ï¼›<code>enhanced_schema=True</code> æœƒè‡ªå‹•æƒææ¨£æœ¬å€¼èˆ‡åˆ†ä½ˆè³‡è¨Šï¼Œè®“ç”Ÿæˆæ›´è²¼è¿‘å¯¦éš›è³‡æ–™ã€‚</li>
                        <li><strong>å¯è§€æ¸¬æ€§é«˜ï¼Œä¾¿æ–¼é™¤éŒ¯</strong>ï¼š<code>return_intermediate_steps=True</code> å¯æ‹¿åˆ°ã€Œç”Ÿæˆçš„ Cypher + æŸ¥è©¢ contextã€ï¼Œæ–¹ä¾¿è¿½è¹¤éŒ¯èª¤èˆ‡å»ºç«‹ç¨½æ ¸ç´€éŒ„ã€‚</li>
                        <li><strong>çµæœå¯æ§ï¼Œé¿å…éé‡å›å‚³</strong>ï¼š<code>top_k</code> å¯é™åˆ¶å›å‚³ç­†æ•¸ï¼ˆå®˜æ–¹é è¨­ 10ï¼‰ï¼Œ<code>return_direct=True</code> å¯ç›´æ¥æ‹¿è³‡æ–™åˆ—ï¼Œæ–¹ä¾¿ä¸‹æ¸¸ API/å‰ç«¯è‡ªè¡Œæ ¼å¼åŒ–ã€‚</li>
                        <li><strong>å¯å®¢è£½ Cypher ç”Ÿæˆå“è³ª</strong>ï¼šå¯é€é <code>cypher_prompt</code> æ³¨å…¥ few-shot ç¯„ä¾‹ï¼›äº¦å¯åˆ†é›¢ <code>cypher_llm</code> èˆ‡ <code>qa_llm</code>ï¼Œåˆ†åˆ¥å„ªåŒ–ã€ŒæŸ¥è©¢ç”Ÿæˆã€èˆ‡ã€Œç­”æ¡ˆæ•˜è¿°ã€ã€‚</li>
                        <li><strong>å¯é™åˆ¶ schema å­é›†ï¼Œæ¸›å°‘èª¤æŸ¥</strong>ï¼š<code>include_types</code> / <code>exclude_types</code> å¯åœ¨ç”Ÿæˆéšæ®µæ’é™¤ç‰¹å®šç¯€é»æˆ–é—œä¿‚ï¼Œç¸®å°æŸ¥è©¢ç©ºé–“ã€‚</li>
                        <li><strong>å¯åšé—œä¿‚æ–¹å‘æ ¡æ­£</strong>ï¼š<code>validate_cypher=True</code> å¯é©—è­‰ä¸¦ä¿®æ­£é—œä¿‚æ–¹å‘ï¼Œé™ä½å› æ–¹å‘éŒ¯èª¤å°è‡´çš„ç©ºçµæœæˆ–éŒ¯èª¤æŸ¥è©¢ã€‚</li>
                        <li><strong>å¯ç”¨ function/tool response å¼·åŒ–ç­”æ¡ˆè²¼åœ°æ€§</strong>ï¼š<code>use_function_response=True</code> æœƒä»¥å·¥å…·è¼¸å‡ºæ–¹å¼æä¾›è³‡æ–™åº« contextï¼Œå®˜æ–¹æ–‡ä»¶æ˜ç¢ºæŒ‡å‡ºå¯æå‡ç­”æ¡ˆæº–ç¢ºæ€§èˆ‡ç›¸é—œæ€§ï¼ˆéœ€æ¨¡å‹æ”¯æ´ function callingï¼‰ã€‚</li>
                    </ul>

                    <p><strong>å®˜æ–¹ä¾†æºï¼ˆLangChainï¼‰</strong></p>
                    <ol>
                        <li>Neo4j integrationï¼š<a href="https://docs.langchain.com/oss/python/integrations/graphs/neo4j_cypher" target="_blank">https://docs.langchain.com/oss/python/integrations/graphs/neo4j_cypher</a></li>
                        <li>GraphCypherQAChain API Referenceï¼š<a href="https://api.python.langchain.com/en/latest/community/chains/langchain_community.chains.graph_qa.cypher.GraphCypherQAChain.html" target="_blank">https://api.python.langchain.com/en/latest/community/chains/langchain_community.chains.graph_qa.cypher.GraphCypherQAChain.html</a></li>
                        <li>LangChain Securityï¼š<a href="https://docs.langchain.com/oss/python/security-policy" target="_blank">https://docs.langchain.com/oss/python/security-policy</a></li>
                    </ol>

                    <blockquote>å®‰å…¨è¨»è¨˜ï¼ˆå®˜æ–¹ï¼‰ï¼š<code>GraphCypherQAChain</code> éœ€æ˜ç¢º <code>allow_dangerous_requests=True</code> æ‰å¯åŸ·è¡Œï¼Œä¸”å®˜æ–¹è¦æ±‚è³‡æ–™åº«å¸³è™Ÿå¿…é ˆä½¿ç”¨æœ€å°æ¬Šé™ï¼ˆnarrowly-scoped credentialsï¼‰ã€‚</blockquote>

                    <ul>
                        <li><strong>é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±º</strong>:
                            <ul>
                                <li><strong>èªæ³•éŒ¯èª¤ (Syntax Error)</strong>: ç”Ÿæˆçš„ Cypher ç„¡æ³•åŸ·è¡Œã€‚
                                    <ul>
                                        <li><strong>è§£æ±º</strong>: å¯¦ä½œ <strong>Self-Correction Loop</strong>ã€‚æ•æ‰ Neo4j éŒ¯èª¤è¨Šæ¯ï¼Œå°‡éŒ¯èª¤å›å‚³çµ¦ LLM è¦æ±‚ä¿®æ­£ (Retry up to 3 times)ã€‚</li>
                                    </ul>
                                </li>
                                <li><strong>èªæ„ä¸æ¸…</strong>: ä½¿ç”¨è€…å•ã€Œè‘£äº‹é•·ã€ä½† Schema åªæœ‰ <code>CHAIRED_BY</code> é—œä¿‚ã€‚
                                    <ul>
                                        <li><strong>è§£æ±º</strong>: åœ¨ System Prompt ä¸­åŠ å…¥ <strong>Semantic Mapping Rules</strong> (e.g., "è‘£äº‹é•·" maps to <code>CHAIRED_BY</code> relationship)ã€‚</li>
                                    </ul>
                                </li>
                                <li><strong>è²¡å ±æ•¸æ“šé€ å‡</strong>: LLM å‚¾å‘ç›´æ¥ç”Ÿæˆæ•¸å­—è€ŒéæŸ¥è©¢è³‡æ–™åº«ã€‚
                                    <ul>
                                        <li><strong>è§£æ±º</strong>: åŠ å…¥ <strong>Guardrails</strong>ï¼Œæª¢æ¸¬ Cypher æ˜¯å¦åŒ…å« <code>AS revenue</code> ç­‰ç¡¬ç·¨ç¢¼å¸¸æ•¸ï¼Œè‹¥ç™¼ç¾å‰‡å¼·åˆ¶ä½¿ç”¨é å®šç¾©çš„ Template Query æŸ¥è©¢çœŸå¯¦è·¯å¾‘ã€‚</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div id="section-3-3">
                    <h3>(3) é¸æ“‡ Neo4j çš„åŸå› èˆ‡æ¯”è¼ƒ</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>åœ–è³‡æ–™åº« (Graph DB)</th>
                                    <th>ç‰¹é»èˆ‡å„ªå‹¢ (Pros)</th>
                                    <th>åŠ£å‹¢èˆ‡é™åˆ¶ (Cons)</th>
                                    <th>æœ¬å°ˆæ¡ˆé©ç”¨æ€§åˆ†æ (Verdict)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Neo4j</strong> (æœ¬å°ˆæ¡ˆæ¡ç”¨)</td>
                                    <td>1. <strong>æˆç†Ÿåº¦é«˜</strong>ï¼šå¸‚å ´ä½”æœ‰ç‡æœ€é«˜ï¼Œç¤¾ç¾¤è³‡æºæœ€è±å¯Œã€‚<br>2. <strong>æŸ¥è©¢èªè¨€</strong>ï¼šCypher ç›´è§€ä¸”é¡ä¼¼ SQLï¼Œæ˜“æ–¼ LLM å­¸ç¿’èˆ‡ç”Ÿæˆã€‚<br>3. <strong>è¦–è¦ºåŒ–å¼·</strong>ï¼šå…§å»º Neo4j Browser èˆ‡ Bloomï¼Œæ–¹ä¾¿é™¤éŒ¯ã€‚</td>
                                    <td>å¤§è¦æ¨¡åˆ†æ•£å¼é‹ç®—éœ€ä¼æ¥­ç‰ˆæ”¯æ´ï¼›å¯«å…¥ååé‡åœ¨æ¥µç«¯å ´æ™¯ä¸‹å¯èƒ½ä¸å¦‚å°ˆé–€çš„åˆ†æ•£å¼åœ–è³‡æ–™åº«ã€‚</td>
                                    <td><strong>æœ€ä½³é¸æ“‡</strong><br>é©åˆæœ¬å°ˆæ¡ˆçš„ä¸­å°å‹è¦æ¨¡ï¼ŒDocker éƒ¨ç½²ç°¡å–®ï¼Œä¸” Cypher å° LLM æœ€å‹å–„ã€‚</td>
                                </tr>
                                <tr>
                                    <td><strong>TigerGraph</strong></td>
                                    <td><strong>åˆ†æ•£å¼é‹ç®—å¼·</strong>ï¼šé©åˆè¶…å¤§è¦æ¨¡ (TBç´š) æ•¸æ“šåˆ†æã€‚</td>
                                    <td><strong>å­¸ç¿’æ›²ç·šé™¡</strong>ï¼šGSQL è¼ƒè¤‡é›œã€‚<br><strong>ç¤¾ç¾¤ç‰ˆé™åˆ¶</strong>ï¼šåŠŸèƒ½èˆ‡é™åˆ¶è¼ƒå¤šã€‚</td>
                                    <td><strong>ä¸é©åˆ</strong><br>æœ¬å°ˆæ¡ˆè¦æ¨¡æœªé” TB ç´šï¼Œä¸” Neo4j å°æ–¼ä¸­å°å‹è¦æ¨¡æ›´æ˜“æ–¼ä¸Šæ‰‹èˆ‡éƒ¨ç½²ã€‚</td>
                                </tr>
                                <tr>
                                    <td><strong>ArangoDB</strong></td>
                                    <td><strong>å¤šæ¨¡è³‡æ–™åº« (Multi-model)</strong>ï¼šåŒæ™‚æ”¯æ´ Document, Key-Value, Graphï¼Œéˆæ´»æ€§é«˜ã€‚</td>
                                    <td><strong>éåŸç”Ÿåœ–è³‡æ–™åº«</strong>ï¼šåœ¨ç´”åœ–æ¼”ç®—æ³•èˆ‡æ·±åº¦éæ­·æ•ˆèƒ½ä¸Šé€šå¸¸ä¸å¦‚åŸç”Ÿçš„ Neo4jã€‚</td>
                                    <td><strong>ä¸é©åˆ</strong><br>æœ¬å°ˆæ¡ˆå°ˆæ³¨æ–¼è¤‡é›œé—œä¿‚éˆæŸ¥è©¢ï¼ŒåŸç”Ÿåœ–è³‡æ–™åº« (Native Graph DB) è¼ƒç‚ºåˆé©ã€‚</td>
                                </tr>
                                <tr>
                                    <td><strong>NebulaGraph</strong></td>
                                    <td><strong>å¯«å…¥ååé‡é«˜</strong>ï¼šé‡å°æµ·é‡æ•¸æ“šè¨­è¨ˆçš„é–‹æºåˆ†ä½ˆå¼åœ–è³‡æ–™åº«ã€‚</td>
                                    <td><strong>éƒ¨ç½²è¤‡é›œ</strong>ï¼šåœ¨å–®æ©Ÿé–‹ç™¼ç’°å¢ƒçš„è¼•é‡ç´šéƒ¨ç½²ä¸Šï¼Œé…ç½®è¼ƒ Neo4j ç¹ç‘£ã€‚</td>
                                    <td><strong>å‚™é¸</strong><br>Docker ç‰ˆçš„ Neo4j é…ç½®è¼ƒç‚ºç°¡å–®ï¼Œç¬¦åˆç›®å‰å¿«é€Ÿé–‹ç™¼éœ€æ±‚ã€‚</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="section-3-4">
                    <h3>(4) è©³ç´°æµç¨‹åœ–ï¼ˆå»ºåœ– + æŸ¥è©¢å…¨æµç¨‹ï¼‰</h3>
                    <p>ä»¥ä¸‹ä»¥å››å¼µåˆ†å±¤æµç¨‹åœ–ï¼Œå°æ‡‰ç›®å‰å¯¦ä½œä¸­çš„å‡½å¼èˆ‡é—œéµç’°å¢ƒè®Šæ•¸ï¼Œå®Œæ•´å±•ç¤º Domain KG å¾ ingest åˆ° query çš„åŸ·è¡Œè·¯å¾‘èˆ‡å®ˆé–€é‚è¼¯ï¼ˆé»æ“Šæ¨™é¡Œå±•é–‹æŸ¥çœ‹ï¼‰ã€‚</p>

                    <!-- åœ– Aï¼šDomain KG å»ºåœ–ä¸»æµç¨‹ -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Aï¼šDomain KG å»ºåœ–ä¸»æµç¨‹ï¼ˆIngest -> Chunk -> Extract -> Sanitize -> Upsertï¼‰</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    subgraph API["API å…¥å£ (backend/main.py)"]
        A1["POST /api/process_text(_async)"]
        A2["POST /api/process_url(_async)"]
        A3["POST /api/process_keyword(_async)"]
    end

    subgraph INGEST["Ingest èˆ‡åˆ‡å¡Š (backend/logic.py)"]
        B1["logic.process_text_to_kg / process_url_to_kg / process_keyword_to_kg"]
        B2["chunk_text (provider-aware token/char budget)"]
        B3["_resolve_chunk_limit (chunk_limit or INGEST_CHUNK_LIMIT)"]
        B4["build_kg_from_chunks (iterate chunk_progress)"]
    end

    subgraph EXTRACT["æŠ½å–èˆ‡æ¸…æ´— (backend/llm_kg/kg_builder.py)"]
        C1["KnowledgeGraphBuilder.extract_entities_relations"]
        C2{"GEMINI_TWO_PASS_EXTRACTION and provider=gemini?"}
        C3["Single-pass relation prompt"]
        C4["Two-pass: Phase-1 entity inventory -> prefill missing -> Phase-2 relation extraction"]
        C5["_extract_json_with_retry (EXTRACTION_JSON_MODE / EXTRACTION_MAX_JSON_RETRIES / EXTRACTION_NUM_PREDICT)"]
        C6["_sanitize_extraction (ALLOWED_ENTITY_TYPES / ALLOWED_RELATION_TYPES / RELATION_DIRECTION_RULES / ENTITY_RESOLVE_THRESHOLD / FOR_PERIOD consistency)"]
    end

    subgraph UPSERT["Neo4j Upsert (backend/llm_kg/kg_builder.py)"]
        D1["populate_graph"]
        D2["_ensure_constraints (Entity.name unique / normalizedName index)"]
        D3["_create_entity (MERGE node + aliases + props)"]
        D4["_create_relation (MERGE relation)"]
    end

    E1["è¼¸å‡º: stats + summary + chunk_progress + json_retries + dropped_relations"]
    ENV1["Env: CHUNK_SIZE_MODE / CHUNK_SIZE_TOKENS / CHUNK_MIN_TOKENS / INGEST_CHUNK_LIMIT / EXTRACTION_JSON_MODE / EXTRACTION_MAX_JSON_RETRIES / EXTRACTION_NUM_PREDICT"]
    ENV2["Env: GEMINI_TWO_PASS_EXTRACTION"]

    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> B4
    B4 --> C1
    C1 --> C2
    C2 -- "No" --> C3
    C2 -- "Yes" --> C4
    C3 --> C5
    C4 --> C5
    C5 --> C6
    C6 --> D1
    D1 --> D2
    D1 --> D3
    D1 --> D4
    D2 --> E1
    D3 --> E1
    D4 --> E1
    ENV1 -.->|controls| B2
    ENV1 -.->|controls| C5
    ENV2 -.->|controls| C2
</div>
                            <p>åœ– A é‡æ¸…äº†æ¯å€‹ API è«‹æ±‚å¦‚ä½•ç¶“éåˆ‡å¡Šã€é‡è©¦æŠ½å–ã€schema æ¸…æ´—èˆ‡ Neo4j upsertï¼Œä¸¦æŠŠè¼¸å‡ºæŒ‡æ¨™ï¼ˆ`json_retries`ã€`dropped_relations`ï¼‰å’Œä¸Šæ¸¸ env æ§åˆ¶é»é€£åœ¨åŒä¸€å¼µåœ–ä¸Šï¼Œæ–¹ä¾¿æ’éšœèˆ‡å®¹é‡è¦åŠƒã€‚</p>
                            <h5>åœ– A å‡½å¼ä½œç”¨è©³è§£</h5>
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>å‡½å¼</th>
                                            <th>æª”æ¡ˆ</th>
                                            <th>ä¸»è¦ä½œç”¨</th>
                                            <th>é—œéµè¼¸å…¥ / è¼¸å‡º</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>process_text_to_kg</code></td>
                                            <td><code>backend/logic.py</code></td>
                                            <td>æ–‡å­—å»ºåœ–å…¥å£ï¼›è² è²¬å‰ç½®åƒæ•¸æ•´ç†ã€åˆ‡å¡Šèˆ‡å‘¼å«å»ºåœ–ä¸»æµç¨‹ã€‚</td>
                                            <td>In: raw textï¼›Out: <code>stats/summary/chunk_progress</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>process_url_to_kg</code></td>
                                            <td><code>backend/logic.py</code></td>
                                            <td>URL å»ºåœ–å…¥å£ï¼›æŠ“å–ç¶²é å…§å®¹å¾Œå°å…¥ç›¸åŒçš„åˆ‡å¡Šèˆ‡æŠ½å–éˆè·¯ã€‚</td>
                                            <td>In: URLï¼›Out: åŒå»ºåœ–çµ±è¨ˆçµæœ</td>
                                        </tr>
                                        <tr>
                                            <td><code>process_keyword_to_kg</code></td>
                                            <td><code>backend/logic.py</code></td>
                                            <td>é—œéµå­—å…¥å£ï¼›æ•´åˆå¤šä¾†æºå…§å®¹ä¸¦èšåˆ chunk èˆ‡æŠ½å–çµæœã€‚</td>
                                            <td>In: keywordï¼›Out: èšåˆå¾Œ stats èˆ‡ä¾†æºç‹€æ…‹</td>
                                        </tr>
                                        <tr>
                                            <td><code>chunk_text</code></td>
                                            <td><code>backend/logic.py</code></td>
                                            <td>ä¾ provider/token/char è¦å‰‡åˆ‡å¡Šï¼Œæ§åˆ¶æŠ½å–ä¸Šä¸‹æ–‡å¤§å°èˆ‡å™ªéŸ³ã€‚</td>
                                            <td>In: text + chunk policyï¼›Out: <code>List[Chunk]</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>_resolve_chunk_limit</code></td>
                                            <td><code>backend/logic.py</code></td>
                                            <td>æ•´åˆ request åƒæ•¸èˆ‡ <code>INGEST_CHUNK_LIMIT</code>ï¼Œæ±ºå®šå–®æ¬¡è™•ç†ä¸Šé™ã€‚</td>
                                            <td>In: request chunk_limit + envï¼›Out: effective limit</td>
                                        </tr>
                                        <tr>
                                            <td><code>build_kg_from_chunks</code></td>
                                            <td><code>backend/logic.py</code></td>
                                            <td>é€ chunk è§¸ç™¼æŠ½å–èˆ‡å¯«å…¥ï¼Œç´¯è¨ˆ chunk_progress èˆ‡éŒ¯èª¤çµ±è¨ˆã€‚</td>
                                            <td>In: chunk listï¼›Out: aggregate <code>stats</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>extract_entities_relations</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>æŠ½å–æ ¸å¿ƒï¼›æ ¹æ“šè¨­å®šèµ° single-pass æˆ– two-pass ä¸¦å›å‚³å¯¦é«”/é—œä¿‚ã€‚</td>
                                            <td>In: chunk textï¼›Out: <code>entities + relations + meta</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>_extract_json_with_retry</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>å°è£ LLM JSON æŠ½å–èˆ‡ä¿®å¾©é‡è©¦ï¼Œé¿å…å£ JSON ç›´æ¥ä¸­æ–·æµç¨‹ã€‚</td>
                                            <td>In: prompt + retry policyï¼›Out: valid payload / raise error</td>
                                        </tr>
                                        <tr>
                                            <td><code>_sanitize_extraction</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>å¥—ç”¨ schema èˆ‡è²¡å‹™æœŸé–“å®ˆé–€ï¼Œæ¸…ç†ä¸åˆæ³•æˆ–æ–¹å‘éŒ¯èª¤çš„é—œä¿‚ã€‚</td>
                                            <td>In: raw entities/relationsï¼›Out: sanitized result</td>
                                        </tr>
                                        <tr>
                                            <td><code>populate_graph</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>å°‡æ¸…æ´—å¾Œçµæœå¯«å…¥ Neo4jï¼Œå”èª¿ constraintsã€ç¯€é»èˆ‡é—œä¿‚ upsertã€‚</td>
                                            <td>In: sanitized extractionï¼›Out: upsert stats</td>
                                        </tr>
                                        <tr>
                                            <td><code>_ensure_constraints</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>ç¢ºä¿å¯¦é«”å”¯ä¸€éµèˆ‡ç´¢å¼•å­˜åœ¨ï¼Œé¿å…é‡è¤‡ç¯€é»èˆ‡æ…¢æŸ¥è©¢ã€‚</td>
                                            <td>In: graph handleï¼›Out: constraint/index ready</td>
                                        </tr>
                                        <tr>
                                            <td><code>_create_entity</code> / <code>_create_relation</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>æœ€çµ‚ MERGE å±¤ï¼šå¯«å…¥ç¯€é»å±¬æ€§ã€åˆ¥åèˆ‡é—œä¿‚é‚Šã€‚</td>
                                            <td>In: normalized entity/relationï¼›Out: merged node/edge</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- åœ– Bï¼šæŠ½å–æ ¸å¿ƒä¸»æµç¨‹ -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Bï¼šæŠ½å–æ ¸å¿ƒä¸»æµç¨‹ï¼ˆTwo-pass / Single-pass + Sanitizationï¼‰</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    X0["extract_entities_relations entry"] --> X1{"GEMINI_TWO_PASS_EXTRACTION and provider=gemini?"}
    X1 -- "Yes" --> X2["Phase-1 prompt: entity inventory"]
    X2 --> X4["_extract_json_with_retry (phase1)"]
    X4 --> X5["_fetch_existing_entity_keys"]
    X5 --> X6["_prefill_missing_entities"]
    X6 --> X7["Phase-2 prompt with seed entities"]
    X7 --> X8["_extract_json_with_retry (phase2)"]

    X1 -- "No" --> X3["Single-pass prompt: entities + relations"]
    X3 --> X9["_extract_json_with_retry (single pass)"]

    X4 -.->|internal loop detail| CREF["åœ– C å±•é–‹: Retry and Repair loop"]
    X8 -.->|internal loop detail| CREF
    X9 -.->|internal loop detail| CREF
    Y0 --> Y1["Alias canonicalization (_name_variants / _best_match / ENTITY_RESOLVE_THRESHOLD)"]
    Y1 --> Y2["Relation validation (ALLOWED_RELATION_TYPES / RELATION_DIRECTION_RULES / reverse-if-possible)"]
    Y2 --> Y3["Financial guard (FOR_PERIOD mismatch drop / infer metric period)"]
    Y3 --> Y4["Output: entities + relations + meta(two_pass, json_retries, merged_entities, dropped_relations)"]
    X8 --> Y0["_sanitize_extraction"]
    X9 --> Y0
</div>
                            <p>åœ– B åªä¿ç•™æŠ½å–æ ¸å¿ƒä¸»å¹¹ï¼Œå…ˆçœ‹ two-pass/single-pass åˆ†æµï¼Œå†çœ‹ sanitize èˆ‡æœ€çµ‚è¼¸å‡ºã€‚é‡è©¦ç´°ç¯€ç¨ç«‹åˆ°åœ– Cï¼Œé–±è®€é †åºæœƒæ›´ç›´è¦ºã€‚</p>
                            <h5>åœ– B å‡½å¼ä½œç”¨è©³è§£</h5>
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>å‡½å¼</th>
                                            <th>æª”æ¡ˆ</th>
                                            <th>ä¸»è¦ä½œç”¨</th>
                                            <th>åœ¨åœ–ä¸­çš„ä½ç½®</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>extract_entities_relations</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>æŠ½å–ä¸»æ§åˆ¶å™¨ï¼›æ±ºå®šèµ° two-pass æˆ– single-passï¼Œä¸¦è² è²¬æœ€å¾Œçµ„è£è¼¸å‡ºã€‚</td>
                                            <td><code>X0 -> X1</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>_extract_json_with_retry</code> (phase1/phase2/single)</td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>åœ¨ä¸‰å€‹æŠ½å–æ™‚æ©Ÿé»åŸ·è¡Œ LLM è«‹æ±‚ï¼Œç¢ºä¿å›å‚³å¯ç”¨ JSONã€‚</td>
                                            <td><code>X4 / X8 / X9</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>_fetch_existing_entity_keys</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>è®€å–æ—¢æœ‰å¯¦é«”éµï¼Œé¿å… two-pass ç¬¬ 2 éšæ®µé‡è¤‡å‰µå»ºæˆ–å‘½åé£„ç§»ã€‚</td>
                                            <td><code>X5</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>_prefill_missing_entities</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>æŠŠ Phase-1 çš„å¯¦é«”ç›¤é»è£œå…¥å€™é¸é›†åˆï¼Œæå‡ Phase-2 é—œä¿‚æŠ½å–å‘½ä¸­ç‡ã€‚</td>
                                            <td><code>X6</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>_sanitize_extraction</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>æ•´é«”æ¸…æ´—å…¥å£ï¼šåˆ¥åæ­£è¦åŒ–ã€é—œä¿‚å‹åˆ¥/æ–¹å‘æª¢æŸ¥ã€è²¡å ±æœŸé–“ä¸€è‡´æ€§éæ¿¾ã€‚</td>
                                            <td><code>Y0</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>_name_variants</code> / <code>_best_match</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>åˆ¥åèˆ‡è¿‘ä¼¼æ¯”å°è¼”åŠ©å™¨ï¼›å°‡èªç¾©ç›¸è¿‘åç¨±æ”¶æ–‚æˆåŒä¸€ canonical entityã€‚</td>
                                            <td><code>Y1</code></td>
                                        </tr>
                                        <tr>
                                            <td>é—œä¿‚é©—è­‰é‚è¼¯ï¼ˆç™½åå–® + æ–¹å‘è¦å‰‡ï¼‰</td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>å¥—ç”¨ <code>ALLOWED_RELATION_TYPES</code> èˆ‡ <code>RELATION_DIRECTION_RULES</code>ï¼Œå¿…è¦æ™‚åè½‰ï¼Œä¸å¯ä¿®å¾©å‰‡ä¸Ÿæ£„ã€‚</td>
                                            <td><code>Y2</code></td>
                                        </tr>
                                        <tr>
                                            <td>è²¡å‹™æœŸé–“å®ˆé–€ï¼ˆFOR_PERIODï¼‰</td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>æª¢æŸ¥ metric èˆ‡ period æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´é—œä¿‚æ¨™è¨˜ dropped ä»¥é¿å…éŒ¯èª¤æ¨è«–ã€‚</td>
                                            <td><code>Y3</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- åœ– Cï¼šRetry & Repair loop -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Cï¼šRetry & Repair Loopï¼ˆ_extract_json_with_retryï¼‰</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    R0["entry: _extract_json_with_retry"] --> R1["Attempt i (0..N)"]
    R1 --> R2{"Mode: strict_json / auto / text (EXTRACTION_JSON_MODE)"}
    R2 --> R3["llm_client.chat_json or chat_text (EXTRACTION_NUM_PREDICT)"]
    R3 --> R4{"_validate_extraction_payload ok?"}
    R4 -- "Yes" --> R8["return valid payload and json_retries=i"]
    R4 -- "No" --> R5["JSON parse or schema fail -> build repair prompt"]
    R5 --> R6{"attempt below EXTRACTION_MAX_JSON_RETRIES?"}
    R6 -- "Yes" --> R1
    R6 -- "No" --> R7["raise ValueError after max attempts"]
</div>
                            <p>åœ– C å°ˆé–€å±•é–‹ `_extract_json_with_retry` å…§éƒ¨ï¼Œèšç„¦ mode åˆ‡æ›ã€é©—è­‰å¤±æ•—ä¿®å¾©èˆ‡æœ€å¤§é‡è©¦é€€å‡ºæ¢ä»¶ï¼Œæ–¹ä¾¿ç›´æ¥æ’æŸ¥ JSON æ ¼å¼éŒ¯èª¤ã€‚</p>
                            <h5>åœ– C å‡½å¼ä½œç”¨è©³è§£</h5>
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>å‡½å¼</th>
                                            <th>æª”æ¡ˆ</th>
                                            <th>ä¸»è¦ä½œç”¨</th>
                                            <th>å¤±æ•—è™•ç†é‡é»</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>_extract_json_with_retry</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>æŠ½å–å¯é æ€§æ ¸å¿ƒï¼›åŒ…ä½ LLM å‘¼å«ã€JSON é©—è­‰ã€ä¿®å¾©é‡è©¦èˆ‡æœ€çµ‚å¤±æ•—æ‹‹éŒ¯ã€‚</td>
                                            <td>è¶…é <code>EXTRACTION_MAX_JSON_RETRIES</code> å¾Œåœæ­¢ï¼Œé¿å…ç„¡é™é‡è©¦ã€‚</td>
                                        </tr>
                                        <tr>
                                            <td><code>llm_client.chat_json</code></td>
                                            <td><code>backend/llm_kg/llm_client.py</code></td>
                                            <td>å„ªå…ˆè¦æ±‚æ¨¡å‹å›å‚³ JSONï¼›åœ¨ strict/auto æ¨¡å¼ä¸‹æå‡å¯è§£æç‡ã€‚</td>
                                            <td>è‹¥å›å‚³éé æœŸæ ¼å¼ï¼Œäº¤ç”±å¾ŒçºŒé©—è­‰èˆ‡ repair prompt ä¿®å¾©ã€‚</td>
                                        </tr>
                                        <tr>
                                            <td><code>llm_client.chat_text</code></td>
                                            <td><code>backend/llm_kg/llm_client.py</code></td>
                                            <td>æ–‡å­—è¼¸å‡ºå‚™æ´è·¯å¾‘ï¼›å†ç”±ç¨‹å¼ç«¯åš JSON èƒå–/ä¿®å¾©ã€‚</td>
                                            <td>æ–‡æœ¬è‡ªç”±åº¦é«˜ï¼Œè§£æå¤±æ•—æ©Ÿç‡è¼ƒé«˜ï¼Œéœ€ä¾é  retry loopã€‚</td>
                                        </tr>
                                        <tr>
                                            <td><code>_validate_extraction_payload</code></td>
                                            <td><code>backend/llm_kg/kg_builder.py</code></td>
                                            <td>æª¢æŸ¥ payload æ˜¯å¦ç¬¦åˆå¯¦é«”/é—œä¿‚çµæ§‹è¦æ±‚ï¼Œæ””æˆªæ ¼å¼éŒ¯èª¤èˆ‡æ¬„ä½ç¼ºæ¼ã€‚</td>
                                            <td>é©—è­‰å¤±æ•—æœƒè§¸ç™¼ repair promptï¼Œé™„å¸¶éŒ¯èª¤è¨Šæ¯å›é€çµ¦ LLMã€‚</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- åœ– Dï¼šæŸ¥è©¢æµç¨‹ -->
                    <div class="diagram-collapsible">
                        <div class="diagram-collapsible-header">
                            <span class="toggle-icon">â–¶</span>
                            <h4>åœ– Dï¼šæŸ¥è©¢æµç¨‹ï¼ˆNL2Cypher + Guardrails + Answer Fallbackï¼‰</h4>
                        </div>
                        <div class="diagram-collapsible-content">
                            <div class="mermaid">flowchart TB
    Q1["POST /api/query"] --> Q2["logic.query_kg"]
    Q2 --> Q3["answer_with_manual_prompt"]
    Q3 --> Q4["load_schema_snapshot + fetch_entity_names + fetch_organization_names"]
    Q4 --> Q5["natural_language_to_cypher"]
    Q5 --> Q6["link_entity_literals"]
    Q6 --> Q7{"Finance question?"}

    Q7 -- "No" --> Q8["validate_cypher_relationships"]
    Q7 -- "Yes" --> Q9{"_cypher_uses_hardcoded_finance_constants OR not _cypher_has_required_finance_path (FINANCE_REQUIRED_REL_TYPES)?"}
    Q9 -- "Yes" --> Q10["_build_finance_template_cypher fallback"]
    Q9 -- "No" --> Q8

    Q8 --> Q11["execute_cypher"]
    Q10 --> Q11
    Q11 --> Q12{"Neo4j error or empty rows and attempt count below CYPHER_REPAIR_RETRIES+1?"}
    Q12 -- "Yes" --> Q5
    Q12 -- "No" --> Q13["rows ready (may be empty)"]

    Q13 --> Q14{"KG_QA_USE_LLM?"}
    Q14 -- "Yes" --> Q15["_generate_kg_answer_with_llm"]
    Q15 --> Q16{"LLM rewrite valid?"}
    Q16 -- "Yes" --> Q17["answer_source = qa_llm"]
    Q16 -- "No" --> Q18["template fallback summary (_summarize_query_rows)"]
    Q14 -- "No" --> Q18
    Q18 --> Q19["answer_source = template_fallback"]
</div>
                            <p>åœ– D é¡¯ç¤ºæŸ¥è©¢éšæ®µä¸¦éå–®ä¸€è·¯å¾‘ï¼Œè€Œæ˜¯ã€ŒCypher ç”Ÿæˆä¿®å¾© + è²¡å ±å®ˆé–€ + ç­”æ¡ˆæ”¹å¯«å›é€€ã€çš„çµ„åˆæµç¨‹ã€‚é€™å¼µåœ–å¯ç”¨ä¾†è§£é‡‹ç‚ºä½•åŒä¸€å€‹å•é¡Œå¯èƒ½èµ°ä¸åŒ fallback åˆ†æ”¯ã€‚</p>
                        </div>
                    </div>

                    <h4>æœ¬ç¯€æµç¨‹åœ–æ¶‰åŠçš„ Env è®Šæ•¸ä½œç”¨è¡¨</h4>
                    <p>ä»¥ä¸‹åƒ…åˆ—å‡ºã€Œåœ– A / åœ– B / åœ– C / åœ– Dã€ç›´æ¥æ¶‰åŠçš„ç’°å¢ƒè®Šæ•¸èˆ‡å…¶åœ¨æµç¨‹ä¸­çš„å½±éŸ¿é»ã€‚</p>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Env è®Šæ•¸</th>
                                    <th>ä¸»è¦è®€å–ä½ç½®</th>
                                    <th>ä½œç”¨èªªæ˜</th>
                                    <th>æµç¨‹å½±éŸ¿é»</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>CHUNK_SIZE_MODE</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>æ§åˆ¶ chunk ç­–ç•¥ï¼š<code>provider|token|char</code>ã€‚<code>provider</code> æ¨¡å¼ä¸‹ Gemini èµ° token chunkï¼Œå…¶ä»–èµ° char chunkã€‚</td>
                                    <td>åœ– Aï¼š<code>chunk_text</code></td>
                                </tr>
                                <tr>
                                    <td><code>CHUNK_SIZE_TOKENS</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>token chunk ä¸Šé™ï¼›è¶…é•·æ®µè½æœƒè§¸ç™¼äºŒæ¬¡åˆ‡åˆ†ã€‚</td>
                                    <td>åœ– Aï¼š<code>chunk_text</code> / token budget</td>
                                </tr>
                                <tr>
                                    <td><code>CHUNK_MIN_TOKENS</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>chunk æœ€å° token é–€æª»ï¼›éçŸ­ç‰‡æ®µå¯è¢«è·³éï¼Œé¿å…å™ªéŸ³è¼¸å…¥æŠ½å–ã€‚</td>
                                    <td>åœ– Aï¼šchunk ç”¢å‡ºå“è³ª</td>
                                </tr>
                                <tr>
                                    <td><code>INGEST_CHUNK_LIMIT</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>å…¨åŸŸ chunk è™•ç†ä¸Šé™ï¼ˆèˆ‡ request çš„ <code>chunk_limit</code> åˆä½µåˆ¤æ–·ï¼‰ï¼Œé™ä½å–®æ¬¡ ingest è² è¼‰ã€‚</td>
                                    <td>åœ– Aï¼š<code>_resolve_chunk_limit</code></td>
                                </tr>
                                <tr>
                                    <td><code>EXTRACTION_JSON_MODE</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æŠ½å– JSON è§£æç­–ç•¥ï¼š<code>strict_json</code>ã€<code>auto</code>ã€<code>text</code>ã€‚</td>
                                    <td>åœ– A/B/Cï¼š<code>_extract_json_with_retry</code></td>
                                </tr>
                                <tr>
                                    <td><code>EXTRACTION_MAX_JSON_RETRIES</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>JSON ä¿®å¾©é‡è©¦æ¬¡æ•¸ä¸Šé™ï¼›ç¸½å˜—è©¦æ¬¡æ•¸ç‚º <code>retries + 1</code>ã€‚</td>
                                    <td>åœ– Cï¼šRetry & Repair loop</td>
                                </tr>
                                <tr>
                                    <td><code>EXTRACTION_NUM_PREDICT</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æŠ½å–éšæ®µè¼¸å‡º token é ç®—ï¼ˆé Gemini æ™‚å„ªå…ˆä½¿ç”¨ï¼‰ï¼Œå½±éŸ¿é•·è¼¸å‡ºè¢«æˆªæ–·é¢¨éšªã€‚</td>
                                    <td>åœ– A/B/Cï¼š<code>_extract_json_with_retry</code></td>
                                </tr>
                                <tr>
                                    <td><code>GEMINI_TWO_PASS_EXTRACTION</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>å•Ÿç”¨ Gemini å…©éšæ®µæŠ½å–ï¼ˆPhase-1 å¯¦é«”ç›¤é» + prefill + Phase-2 é—œä¿‚æŠ½å–ï¼‰ã€‚</td>
                                    <td>åœ– A/Bï¼šSingle-pass vs Two-pass åˆ†æ”¯</td>
                                </tr>
                                <tr>
                                    <td><code>CYPHER_REPAIR_RETRIES</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>NL2Cypher å¤±æ•—ä¿®å¾©è¿´åœˆä¸Šé™ï¼Œæ§åˆ¶ã€Œç”Ÿæˆ -> åŸ·è¡Œ -> ä¿®æ­£ã€å˜—è©¦æ¬¡æ•¸ã€‚</td>
                                    <td>åœ– Dï¼šCypher repair loop</td>
                                </tr>
                                <tr>
                                    <td><code>KG_QA_USE_LLM</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>æ˜¯å¦å•Ÿç”¨æŸ¥è©¢çµæœæ”¹å¯«ã€‚é—œé–‰æ™‚ç›´æ¥èµ°æ¨¡æ¿æ‘˜è¦ fallbackã€‚</td>
                                    <td>åœ– Dï¼š<code>qa_llm</code> vs <code>template_fallback</code></td>
                                </tr>
                                <tr>
                                    <td><code>KG_QA_MAX_TOKENS</code> / <code>KG_QA_TEMPERATURE</code> / <code>KG_QA_MODEL</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>æ§åˆ¶ç­”æ¡ˆæ”¹å¯«æ¨¡å‹ã€è¼¸å‡ºé•·åº¦èˆ‡ç©©å®šåº¦ï¼ˆæº«åº¦ï¼‰ï¼›ç›´æ¥å½±éŸ¿æœ€çµ‚å›ç­”å“è³ªèˆ‡å¯è®€æ€§ã€‚</td>
                                    <td>åœ– Dï¼š<code>_generate_kg_answer_with_llm</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4>æœ¬ç¯€æµç¨‹åœ–æ¶‰åŠçš„æ ¸å¿ƒå‡½å¼ä½œç”¨è¡¨</h4>
                    <p>å‡½å¼ä¾è³‡æ–™æµåˆ†ç¾¤ï¼šIngest/Chunkã€æŠ½å–/æ¸…æ´—/å¯«å…¥ã€æŸ¥è©¢å®ˆé–€èˆ‡å›ç­”å›é€€ã€‚</p>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>å‡½å¼</th>
                                    <th>æª”æ¡ˆ</th>
                                    <th>ä½œç”¨</th>
                                    <th>è¼¸å…¥ / è¼¸å‡ºé‡é»</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>process_text_to_kg</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>æ–‡å­—è¼¸å…¥çš„ KG å»ºåœ–å…¥å£ï¼Œè² è²¬å‰ç½®åˆ‡å¡Šèˆ‡å¾ŒçºŒå»ºåœ–å‘¼å«ã€‚</td>
                                    <td>In: raw textï¼›Out: <code>stats/summary/chunk_progress</code></td>
                                </tr>
                                <tr>
                                    <td><code>process_url_to_kg</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>URL ingest å…¥å£ï¼Œå…ˆæŠ“å–æ¸…æ´—é é¢æ–‡å­—ï¼Œå†å°å…¥åˆ‡å¡Šèˆ‡å»ºåœ–ã€‚</td>
                                    <td>In: URLï¼›Out: åŒä¸Š</td>
                                </tr>
                                <tr>
                                    <td><code>process_keyword_to_kg</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>é—œéµå­—çˆ¬å–å…¥å£ï¼Œèšåˆå¤š URL çš„æŠ½å–çµæœï¼Œä¸¦ç´¯è¨ˆæˆåŠŸ/å¤±æ•—ä¾†æºã€‚</td>
                                    <td>In: keywordï¼›Out: aggregated stats + fetched/failed urls</td>
                                </tr>
                                <tr>
                                    <td><code>chunk_text</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>provider-aware åˆ‡å¡Šæ ¸å¿ƒï¼›æ ¹æ“šæ¨¡å¼é¸ token æˆ– char budgetã€‚</td>
                                    <td>In: text/source metadataï¼›Out: <code>List[Chunk]</code></td>
                                </tr>
                                <tr>
                                    <td><code>_resolve_chunk_limit</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>çµ±ä¸€è§£æ chunk ä¸Šé™ï¼ˆrequest + envï¼‰ï¼Œä¸¦åšåˆæ³•ç¯„åœé˜²è­·ã€‚</td>
                                    <td>In: optional limitï¼›Out: normalized limit or <code>None</code></td>
                                </tr>
                                <tr>
                                    <td><code>build_kg_from_chunks</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>é€ chunk åŸ·è¡ŒæŠ½å–èˆ‡ upsertï¼Œç¶­è­·æ¯å¡Šç‹€æ…‹ã€çµ±è¨ˆèˆ‡é€²åº¦å›å ±ã€‚</td>
                                    <td>In: chunksï¼›Out: build result payload</td>
                                </tr>
                                <tr>
                                    <td><code>extract_entities_relations</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æŠ½å–ç¸½å…¥å£ï¼›åˆ¤æ–· single-pass æˆ– Gemini two-pass è·¯å¾‘ã€‚</td>
                                    <td>In: chunk textï¼›Out: sanitized entities/relations + meta</td>
                                </tr>
                                <tr>
                                    <td><code>_extract_entities_relations_two_pass</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>å…©éšæ®µæŠ½å–ï¼šå…ˆç›¤é»å¯¦é«”ï¼Œå†è£œé½Šç¼ºæ¼ï¼Œå†æŠ½é—œä¿‚ã€‚</td>
                                    <td>Out meta: <code>phase1_entities/prefilled_missing_entities</code></td>
                                </tr>
                                <tr>
                                    <td><code>_extract_json_with_retry</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>JSON è§£æä¿è­·å±¤ï¼›è§£æå¤±æ•—æ™‚ç”Ÿæˆä¿®å¾© prompt é‡è©¦ã€‚</td>
                                    <td>Out: parsed payload + retry count æˆ– raise error</td>
                                </tr>
                                <tr>
                                    <td><code>_sanitize_extraction</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>æŠ½å–å¾Œæ¸…æ´—ï¼šç™½åå–®éæ¿¾ã€åˆ¥ååˆä½µã€é—œä¿‚æ–¹å‘æ ¡æ­£ã€è²¡å ±å­£åº¦ä¸€è‡´æ€§æª¢æŸ¥ã€‚</td>
                                    <td>Out meta: <code>merged_entities/dropped_relations</code></td>
                                </tr>
                                <tr>
                                    <td><code>populate_graph</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>å°‡æ¸…æ´—å¾Œè³‡æ–™å¯«å…¥ Neo4jï¼Œå½™æ•´ upsert çµ±è¨ˆã€‚</td>
                                    <td>Out: <code>GraphBuildStats</code></td>
                                </tr>
                                <tr>
                                    <td><code>_ensure_constraints</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>å»ºç«‹å”¯ä¸€éµèˆ‡ç´¢å¼•ï¼Œç¢ºä¿ä¸»éµä¸€è‡´æ€§èˆ‡æŸ¥è©¢æ•ˆç‡ã€‚</td>
                                    <td>Creates: unique constraint + normalizedName index</td>
                                </tr>
                                <tr>
                                    <td><code>_create_entity</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>ç”¨ <code>MERGE</code> upsert å¯¦é«”ï¼Œç¶­è­· aliases èˆ‡é¡å¤–å±¬æ€§ã€‚</td>
                                    <td>Node labels: concrete type + <code>:Entity</code></td>
                                </tr>
                                <tr>
                                    <td><code>_create_relation</code></td>
                                    <td><code>backend/llm_kg/kg_builder.py</code></td>
                                    <td>ç”¨ <code>MERGE (a)-[:REL]->(b)</code> upsert é—œä¿‚ä¸¦æ›´æ–°æ™‚é–“æˆ³ã€‚</td>
                                    <td>Rel type validated by allowlist</td>
                                </tr>
                                <tr>
                                    <td><code>query_kg</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>æŸ¥è©¢å…¥å£ï¼›å…ˆå–å¾— Cypher rowsï¼Œå†å˜—è©¦ LLM æ”¹å¯«ç­”æ¡ˆã€‚</td>
                                    <td>Out: <code>answer + answer_source + rows</code></td>
                                </tr>
                                <tr>
                                    <td><code>answer_with_manual_prompt</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>NL2Cypher ä¸»è·¯å¾‘ï¼›çµåˆ schemaã€å®ˆé–€è¦å‰‡ã€é‡è©¦ä¿®å¾©èˆ‡ fallbackã€‚</td>
                                    <td>Out: <code>question/cypher/rows/attempt</code></td>
                                </tr>
                                <tr>
                                    <td><code>load_schema_snapshot</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>å¾ Neo4j å– labels/relations/propertiesï¼Œç”Ÿæˆ prompt ç”¨ schema æè¿°ã€‚</td>
                                    <td>Out: <code>SchemaSnapshot</code></td>
                                </tr>
                                <tr>
                                    <td><code>natural_language_to_cypher</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>æŠŠè‡ªç„¶èªè¨€å•é¡Œè½‰ç‚ºå¯åŸ·è¡Œ Cypherï¼Œå¿…è¦æ™‚å¸¶å…¥å‰æ¬¡éŒ¯èª¤åšä¿®å¾©ã€‚</td>
                                    <td>In: question + schema (+ previous error)</td>
                                </tr>
                                <tr>
                                    <td><code>validate_cypher_relationships</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>æª¢æŸ¥ Cypher é—œä¿‚å‹åˆ¥æ˜¯å¦å­˜åœ¨æ–¼ schemaï¼Œé˜»æ“‹æœªçŸ¥é—œä¿‚æŸ¥è©¢ã€‚</td>
                                    <td>Raises on unknown relationship type</td>
                                </tr>
                                <tr>
                                    <td><code>_cypher_uses_hardcoded_finance_constants</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>åµæ¸¬è²¡å ±æŸ¥è©¢æ˜¯å¦ä½œå¼Šï¼ˆç¡¬ç·¨ç¢¼å¸¸å€¼å›è¦†ï¼‰ã€‚</td>
                                    <td>Finance guard trigger</td>
                                </tr>
                                <tr>
                                    <td><code>_cypher_has_required_finance_path</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>è¦æ±‚è²¡å ±æŸ¥è©¢å¿…é ˆèµ°çœŸå¯¦åœ–è­œè·¯å¾‘ï¼ˆ<code>HAS_FINANCIAL_METRIC</code> + <code>FOR_PERIOD</code>ï¼‰ã€‚</td>
                                    <td>Finance guard trigger</td>
                                </tr>
                                <tr>
                                    <td><code>_build_finance_template_cypher</code></td>
                                    <td><code>backend/llm_kg/nl2cypher.py</code></td>
                                    <td>ç•¶è²¡å ±æŸ¥è©¢ä¸åˆè¦æˆ–å¤šæ¬¡å¤±æ•—æ™‚ï¼Œå›é€€åˆ°å›ºå®šæ¨¡æ¿æŸ¥è©¢çœŸå¯¦è³‡æ–™ã€‚</td>
                                    <td>Fallback Cypher path</td>
                                </tr>
                                <tr>
                                    <td><code>_generate_kg_answer_with_llm</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>ä»¥ rows ç‚ºåŸºç¤ç”Ÿæˆå¯è®€ç­”æ¡ˆï¼Œä¸¦é©—è­‰æ˜¯å¦å¼•ç”¨æŸ¥è©¢å€¼ã€é˜²æ­¢ç©ºæ´å›è¦†ã€‚</td>
                                    <td>Success => <code>answer_source=qa_llm</code></td>
                                </tr>
                                <tr>
                                    <td><code>_summarize_query_rows</code></td>
                                    <td><code>backend/logic.py</code></td>
                                    <td>ç•¶ QA LLM ä¸å¯ç”¨æˆ–è¼¸å‡ºä¸åˆæ ¼æ™‚ï¼Œä½¿ç”¨æ¨¡æ¿è¦å‰‡ç”¢ç”Ÿ fallback ç­”æ¡ˆã€‚</td>
                                    <td>Fallback => <code>answer_source=template_fallback</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="section-4">
                <h2>4. OpenClaw ç³»çµ±æ¶æ§‹èˆ‡æŠ€èƒ½å®‰å…¨åˆ†æ</h2>

                <div id="section-4-1">
                    <h3>(1) ç³»çµ±æ¶æ§‹èˆ‡ä¸»è¦çµ„ä»¶</h3>
                    <p>ä»¥ä¸‹ä¾ <code>ARCHITECTURE.md</code> å½™æ•´ï¼š</p>
                    <ul>
                        <li><strong>Gateway Server (<code>src/gateway</code>)</strong>ï¼š
                            <ul>
                                <li>ä»¥å¾®æ ¸å¿ƒæ¶æ§‹ç‚ºä¸­æ¨ï¼Œè² è²¬é…ç½®è¼‰å…¥ã€Plugin æ›è¼‰ã€HTTP/WebSocket æœå‹™ã€äº‹ä»¶å»£æ’­èˆ‡å­æœå‹™ç”Ÿå‘½é€±æœŸã€‚</li>
                                <li>å…§å« Discoveryã€Tailscaleã€Exec Approval Manager ç­‰é—œéµèƒ½åŠ›ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Channel System (<code>src/channels</code>)</strong>ï¼š
                            <ul>
                                <li>å°‡ WhatsApp / Telegram / Discord / Slack ç­‰ç•°è³ªè¨Šæ¯æ¨™æº–åŒ–ï¼Œçµ±ä¸€è¼¸å…¥äº‹ä»¶æ ¼å¼ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Auto-reply Engine (<code>src/auto-reply</code>)</strong>ï¼š
                            <ul>
                                <li>è² è²¬è¨Šæ¯è·¯ç”±ã€Session ç®¡ç†ã€æ¨¡å‹é¸æ“‡ã€ReAct å·¥å…·è¿´åœˆåŸ·è¡Œèˆ‡æœ€çµ‚å›è¦†ç”Ÿæˆã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Plugin / Skill ç”Ÿæ…‹ (<code>extensions/</code>, <code>skills/</code>)</strong>ï¼š
                            <ul>
                                <li>é€éå¤–æ›æ“´å…… Channelã€Toolsã€CLI æŒ‡ä»¤èˆ‡ HTTP Routesï¼Œæ˜¯å¹³å°æ“´å±•æ€§æ ¸å¿ƒã€‚</li>
                            </ul>
                        </li>
                        <li><strong>åŸºç¤è¨­æ–½å±¤ (<code>src/cron</code>, <code>src/media</code>)</strong>ï¼š
                            <ul>
                                <li>æä¾›æ’ç¨‹ã€åª’é«”è½‰æ›ã€çŸ­æœŸæª”æ¡ˆæœå‹™èˆ‡æ¸…ç†æ©Ÿåˆ¶ã€‚</li>
                            </ul>
                        </li>
                    </ul>

                    <p><strong>è³‡æ–™æµï¼ˆData Flowï¼Œå¼•ç”¨ <code>ARCHITECTURE.md</code>ï¼‰</strong></p>

                    <h4>4.1 è¨Šæ¯è™•ç†æµç¨‹</h4>
                    <div class="mermaid">sequenceDiagram
    participant User
    participant ChannelPlugin as Channel Plugin
    participant Gateway
    participant Dispatcher
    participant AgentRunner
    participant LLM

    User->>ChannelPlugin: ç™¼é€è¨Šæ¯
    ChannelPlugin->>Gateway: æ¨™æº–åŒ–è¨Šæ¯ (Normalized Event)
    Gateway->>Dispatcher: dispatchInboundMessage()

    note over Dispatcher: Security Check (Command Gating)

    Dispatcher->>Dispatcher: å»ºç«‹ MsgContext
    Dispatcher->>AgentRunner: è§¸ç™¼ Agent åŸ·è¡Œ

    loop Thinking Process
        AgentRunner->>LLM: ç™¼é€ Prompt + Context
        LLM-->>AgentRunner: å›å‚³ Thought / Tool Call
        opt Tool Execution
            AgentRunner->>Gateway: åŸ·è¡Œå·¥å…· (e.g., search, query)
            Gateway-->>AgentRunner: å›å‚³ Tool Result
        end
    end

    AgentRunner-->>Dispatcher: ç”Ÿæˆæœ€çµ‚å›è¦† (Payload)
    Dispatcher->>ChannelPlugin: ç™¼é€å›è¦†
    ChannelPlugin->>User: é¡¯ç¤ºè¨Šæ¯
</div>

                    <h4>4.2 Agent æ€è€ƒéç¨‹è©³è§£ (Agent Execution Loop)</h4>
                    <p>Agent çš„åŸ·è¡Œé‚è¼¯ä½æ–¼ <code>src/auto-reply/reply/agent-runner.ts</code> èˆ‡ <code>agent-runner-execution.ts</code>ï¼Œå…¶æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š</p>
                    <ol>
                        <li><strong>ä¸Šä¸‹æ–‡æº–å‚™ (Context Prep)</strong>ï¼š
                            <ul>
                                <li>å¾ Session Store è¼‰å…¥å°è©±æ­·å²ã€‚</li>
                                <li>æ³¨å…¥ç³»çµ±æç¤ºè© (System Prompt) èˆ‡ç•¶å‰å¯ç”¨å·¥å…· (Tools)ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>æ¬Šé™æª¢æŸ¥ (Security)</strong>ï¼š
                            <ul>
                                <li><strong>Command Gating</strong>ï¼šæª¢æŸ¥ç™¼é€è€…æ˜¯å¦åœ¨å…è¨±æ¸…å–® (Allowlist) ä¸­ï¼Œä»¥æ±ºå®šæ˜¯å¦åŸ·è¡Œæ•æ„ŸæŒ‡ä»¤ã€‚</li>
                                <li><strong>Access Groups</strong>ï¼šæ”¯æ´ç¾¤çµ„å±¤ç´šçš„æ¬Šé™ç®¡ç†ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>æ¨¡å‹èª¿ç”¨ (Model Invocation)</strong>ï¼š
                            <ul>
                                <li>å°‡ä¸Šä¸‹æ–‡ç™¼é€è‡³é…ç½®çš„ LLM (OpenAI, Anthropic ç­‰)ã€‚</li>
                                <li>è‹¥é…ç½®äº† Fallbackï¼Œç•¶ä¸»è¦æ¨¡å‹å¤±æ•—æ™‚æœƒè‡ªå‹•åˆ‡æ›è‡³å‚™æ´æ¨¡å‹ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>æ¨ç†èˆ‡å·¥å…· (Reasoning & Tools)</strong>ï¼š
                            <ul>
                                <li><strong>Thinking</strong>ï¼šAgent ç”¢ç”Ÿæ€è€ƒéç¨‹ (CoT)ã€‚</li>
                                <li><strong>Action</strong>ï¼šè‹¥ Agent æ±ºå®šä½¿ç”¨å·¥å…·ï¼Œç³»çµ±æœƒæ””æˆª Tool Callï¼ŒåŸ·è¡Œå°æ‡‰çš„ TypeScript å‡½æ•¸ï¼Œä¸¦å°‡çµæœ (Observation) é™„åŠ å›å°è©±æ­·å²ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>ä¸²æµå›æ‡‰ (Streaming)</strong>ï¼š
                            <ul>
                                <li>æ”¯æ´ <strong>Block Streaming</strong>ï¼Œå³æ™‚å°‡ Agent çš„éƒ¨åˆ†æ€è€ƒæˆ–å›æ‡‰æ¨é€çµ¦ä½¿ç”¨è€…ï¼Œæ¸›å°‘ç­‰å¾…æ„Ÿã€‚</li>
                                <li>è™•ç† <strong>Typing Indicators</strong>ï¼Œåœ¨ Agent æ€è€ƒæˆ–åŸ·è¡Œå·¥å…·æ™‚é¡¯ç¤ºã€Œæ­£åœ¨è¼¸å…¥...ã€ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>è¨˜æ†¶é«”ç®¡ç† (Memory Management)</strong>ï¼š
                            <ul>
                                <li>åŸ·è¡Œå¾Œè‡ªå‹•æª¢æŸ¥ Context Windowï¼Œå¿…è¦æ™‚è§¸ç™¼ <strong>Compaction</strong>ï¼ˆæ‘˜è¦/å£“ç¸®æ­·å²ç´€éŒ„ï¼‰ã€‚</li>
                            </ul>
                        </li>
                    </ol>

                    <h4>4.3 åª’é«”è™•ç†ç®¡é“ (Media Pipeline)</h4>
                    <p>ä½æ–¼ <code>src/media/</code>ï¼Œè² è²¬è™•ç†åœ–ç‰‡ã€éŸ³è¨Šèˆ‡å½±ç‰‡æª”æ¡ˆã€‚</p>
                    <ul>
                        <li><strong>æš«å­˜ä¼ºæœå™¨ (Ephemeral Server)</strong>ï¼šå•Ÿå‹•ä¸€å€‹ Express Server æä¾›æœ¬åœ°åª’é«”æª”æ¡ˆçš„ HTTP å­˜å–ã€‚</li>
                        <li><strong>ç”Ÿå‘½é€±æœŸç®¡ç†</strong>ï¼šä¸Šå‚³çš„åª’é«”æª”æ¡ˆé è¨­æœ‰ TTL (Time-To-Liveï¼Œä¾‹å¦‚ 2 åˆ†é˜)ï¼ŒéæœŸå¾Œæœƒç”± <code>cleanOldMedia</code> å®šæœŸæ¸…ç†ï¼Œç¢ºä¿ç£ç¢Ÿç©ºé–“ä¸è¢«ä½”ç”¨ã€‚</li>
                        <li><strong>MIME åµæ¸¬</strong>ï¼šä½¿ç”¨ <code>detectMime</code> è‡ªå‹•è­˜åˆ¥æª”æ¡ˆé¡å‹ã€‚</li>
                    </ul>
                </div>

                <div id="section-4-2">
                    <h3>(2) OpenClaw å®‰å…¨é¢¨éšªï¼ˆ3 å¤§é¡ 10 é …ï¼‰</h3>

                    <h4>A. Skill ç”Ÿæ…‹ç³»é¢¨éšªï¼ˆ5 é …ï¼Œæœ€é«˜å„ªå…ˆï¼‰</h4>
                    <ol>
                        <li><strong>ä»»æ„ç¨‹å¼ç¢¼åŸ·è¡Œ (RCE)</strong>ï¼šSkill é€é <code>eval</code> / shell pipe / <code>child_process</code> åŸ·è¡Œæƒ¡æ„æŒ‡ä»¤ã€‚</li>
                        <li><strong>è·¯å¾‘éæ­· (Path Traversal)</strong>ï¼šæƒ¡æ„è·¯å¾‘ï¼ˆå¦‚ <code>../../etc/passwd</code>ï¼‰è®€å–è¶…å‡ºæˆæ¬Šç¯„åœæª”æ¡ˆã€‚</li>
                        <li><strong>è³‡æ–™å¤–æ´© (Exfiltration)</strong>ï¼šSkill è®€å–æœ¬æ©Ÿæ•æ„Ÿæª”å¾Œé€éç¶²è·¯ä¸Šå‚³åˆ°å¤–éƒ¨ç«¯é»ã€‚</li>
                        <li><strong>ä¾›æ‡‰éˆæ”»æ“Š (Supply Chain Poisoning)</strong>ï¼šæƒ¡æ„ Skill å½è£å¯¦ç”¨å·¥å…·æ··å…¥ç”Ÿæ…‹ã€‚</li>
                        <li><strong>Prompt Injection via Skill Output</strong>ï¼šSkill è¼¸å‡ºå¤¾å¸¶æƒ¡æ„æŒ‡ä»¤ï¼Œèª˜å° Agent è¦†å¯«å®‰å…¨é‚Šç•Œã€‚</li>
                    </ol>

                    <h4>B. åŸ·è¡Œç’°å¢ƒé¢¨éšªï¼ˆ3 é …ï¼‰</h4>
                    <ol start="6">
                        <li><strong>æ²™ç®±é€ƒé€¸ (Sandbox Escape)</strong>ï¼švm/å®¹å™¨éš”é›¢ä¸è¶³æ™‚ï¼Œæƒ¡æ„ç¨‹å¼çªç ´åŸ·è¡Œé‚Šç•Œã€‚</li>
                        <li><strong>éåº¦é«˜æ¬Šé™åŸ·è¡Œ</strong>ï¼šSkill ç›´æ¥å–å¾—éå¤§ç³»çµ±æ¬Šé™ï¼ˆæª”æ¡ˆã€ç¶²è·¯ã€å‘½ä»¤åŒæ™‚é–‹æ”¾ï¼‰ã€‚</li>
                        <li><strong>èŠå¤©è¨Šæ¯æ³¨å…¥å‘é‡</strong>ï¼šå¤–éƒ¨è¨Šæ¯ç›´æ¥æ‹¼æ¥åˆ°é«˜æ¬Šé™å·¥å…· prompt/å‘½ä»¤ï¼Œé€ æˆé–“æ¥æ³¨å…¥ã€‚</li>
                    </ol>

                    <h4>C. ç³»çµ±æ•´åˆèˆ‡æ²»ç†é¢¨éšªï¼ˆ2 é …ï¼‰</h4>
                    <ol start="9">
                        <li><strong>æ¬Šé™ç²’åº¦ä¸è¶³</strong>ï¼šç¼ºå°‘ capability ç´šåˆ¥æˆæ¬Šï¼Œç„¡æ³•æœ€å°æ¬Šé™åŒ–ã€‚</li>
                        <li><strong>Token/Secrets ç®¡ç†ä¸è¶³</strong>ï¼šç¬¬ä¸‰æ–¹ API Token è‹¥æœªåŠ å¯†ã€æœªè¼ªæ›¿ã€ç¼ºç¨½æ ¸ï¼Œå¤–æ´©é¢¨éšªé«˜ã€‚</li>
                    </ol>

                    <p><strong>ç¾æ³è§€å¯Ÿï¼ˆæœ¬ repoï¼‰</strong>ï¼š</p>
                    <ul>
                        <li>å·²æœ‰ <code>genai_project/openclaw/security/skill_audit.ts</code>ï¼Œå¯æŠ“åˆ° <code>curl|bash</code>ã€<code>eval</code>ã€<code>sudo</code>ã€<code>elevated:true</code> ç­‰é«˜é¢¨éšªæ¨¡å¼ã€‚</li>
                        <li>ç›®å‰å±¬æ–¼ <strong>éœæ…‹ Regex åŸºç·šæª¢æŸ¥</strong>ï¼Œå°šæœªè¦†è“‹ AST è¡Œç‚ºåˆ†æã€æ²™ç®±å‹•æ…‹é©—è­‰ã€ä¾†æºç°½ç« èˆ‡å®Œæ•´æ¬Šé™æ”¿ç­–ã€‚</li>
                    </ul>
                </div>

                <div id="section-4-3">
                    <h3>(3) æŠ€èƒ½å®‰å…¨å¯©æŸ¥æ©Ÿåˆ¶è¨­è¨ˆï¼ˆå»ºè­°è½åœ°ç‰ˆï¼‰</h3>

                    <h4>3.1 å››éšæ®µå¯©æŸ¥ç¸½è¦½ï¼ˆä¸Šæ¶å‰ï¼‰</h4>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th>åç¨±</th>
                                    <th>æ ¸å¿ƒæ–¹æ³•</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><strong>Manifest Audit</strong></td>
                                    <td>å¿…è¦æ¬„ä½é©—è­‰ã€æ¬Šé™ç™½åå–®æ¯”å°ã€sandbox å¼·åˆ¶é™åˆ¶</td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td><strong>Static Analysis</strong></td>
                                    <td>å±éšª API Regex/è¦å‰‡æƒæ + æ··æ·†åµæ¸¬ï¼ˆé•·è¡Œã€Hex/Unicode è·³è„«ï¼‰</td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td><strong>Sandbox Trial</strong></td>
                                    <td>å—æ§åŸ·è¡Œã€ç¶²è·¯æ””æˆªã€ç³»çµ±å‘¼å«ç›£æ§ã€è³‡æºä¸Šé™</td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td><strong>Signature Verification</strong></td>
                                    <td><code>SHA-256(manifest + entrypoint)</code> + ç™¼å¸ƒè€…å…¬é‘°ï¼ˆRSA/ç­‰æ•ˆï¼‰é©—è­‰</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p><strong>æ±ºç­–é‚è¼¯</strong></p>
                    <ul>
                        <li>æœ‰ <code>CRITICAL/ERROR</code>ï¼šè‡ªå‹•æ‹’çµ•ã€‚</li>
                        <li>æœ‰ <code>HIGH/WARN</code>ï¼šè½‰äººå·¥è¤‡å¯©ã€‚</li>
                        <li>å…¨é€šéä¸”ç°½ç« æœ‰æ•ˆï¼šå…è¨±ä¸Šæ¶ã€‚</li>
                    </ul>

                    <h4>3.2 Phase 1ï¼šManifest Auditï¼ˆæ¸…å–®å¯©æŸ¥ï¼‰</h4>
                    <p>å…ˆå¯©æŸ¥ Skill çš„ <code>skill.json</code>ï¼ˆè‡ªæˆ‘è²æ˜ï¼‰ï¼Œä¸åˆè¦ç›´æ¥æ“‹ä¸‹ï¼Œä¸é€²ä¸‹ä¸€é—œã€‚</p>

                    <p><strong>å¿…è¦æ¬„ä½é©—è­‰</strong></p>
                    <pre><code class="language-json">{
  "name": "file_summarizer",
  "version": "1.0.0",
  "author": "demo-author",
  "permissions": ["fs.read.whitelist"],
  "entrypoint": "index.js",
  "sandbox": {
    "exec": false,
    "network": false,
    "fs_read": ["/home/user/documents"],
    "fs_write": []
  }
}</code></pre>

                    <p><strong>æ¬Šé™ç™½åå–®æ¯”å°</strong></p>
                    <ul>
                        <li>å…è¨±ï¼š<code>system.time</code>ã€<code>fs.read.whitelist</code>ã€<code>network.outbound.allowlist</code></li>
                        <li>æ‹’çµ•ï¼š<code>system.root</code>ã€<code>fs.read.*</code>ã€<code>exec.shell</code></li>
                    </ul>

                    <p><strong>Sandbox å¼·åˆ¶è¦å‰‡</strong></p>
                    <ul>
                        <li><code>sandbox.exec=true</code>ï¼šç›´æ¥ <code>CRITICAL</code>ï¼ˆæ‹’çµ•ï¼‰ã€‚</li>
                        <li><code>sandbox.network=true</code> ä½†æœªå®£å‘Šå°æ‡‰ç¶²è·¯æ¬Šé™ï¼š<code>ERROR</code>ï¼ˆæ‹’çµ•ï¼‰ã€‚</li>
                        <li><code>fs_read/fs_write</code> å¿…é ˆæ˜¯æ˜ç¢ºç™½åå–®è·¯å¾‘ã€‚</li>
                    </ul>

                    <h4>3.3 Phase 2ï¼šStatic Analysisï¼ˆéœæ…‹æƒæï¼‰</h4>
                    <p>ä¸åŸ·è¡Œç¨‹å¼ï¼Œç›´æ¥æƒæåŸå§‹ç¢¼æ¨¡å¼ã€‚</p>

                    <p><strong>å±éšª API é¢¨éšªåˆ†ç´š</strong></p>
                    <ul>
                        <li><code>CRITICAL</code>ï¼š<code>child_process</code>ã€<code>exec()</code>ã€<code>execSync</code>ã€<code>spawn()</code>ã€<code>eval()</code>ã€<code>new Function()</code></li>
                        <li><code>HIGH</code>ï¼šæœªæˆæ¬Šç¶²è·¯å‘¼å«ï¼ˆ<code>http/https/fetch</code>ï¼‰ã€æª”æ¡ˆç ´å£æ“ä½œï¼ˆ<code>fs.writeFile/fs.unlink/fs.rmdir</code>ï¼‰</li>
                        <li><code>MEDIUM</code>ï¼š<code>process.env</code>ã€<code>process.exit()</code>ã€å¯ç–‘è§£ç¢¼ï¼ˆ<code>Buffer.from(base64)</code>ï¼‰</li>
                        <li><code>LOW</code>ï¼šHex/Unicode è·³è„«å­—ä¸²ã€éåº¦æ··æ·†ç—•è·¡</li>
                    </ul>

                    <p><strong>æ··æ·†åµæ¸¬</strong></p>
                    <ul>
                        <li>å–®è¡Œè¶…é 500 å­—å…ƒè§¸ç™¼è­¦ç¤ºï¼ˆå¸¸è¦‹æ–¼æ··æ·†æˆ–æƒ¡æ„ payloadï¼‰ã€‚</li>
                        <li>åµæ¸¬ <code>\xNN</code>ã€<code>\uNNNN</code> å¤§é‡è·³è„«å­—å…ƒã€‚</li>
                    </ul>

                    <p><strong>é™åˆ¶èªªæ˜ï¼ˆéœ€æ­é… Phase 3ï¼‰</strong></p>
                    <pre><code class="language-javascript">const mod = "child" + "_" + "process";
require(mod).exec("rm -rf /");</code></pre>
                    <p>ä¸Šè¿°å‹•æ…‹çµ„å­—å¯èƒ½ç¹éç´”å­—ä¸²è¦å‰‡ï¼Œå› æ­¤éœ€é€²å…¥æ²™ç®±å‹•æ…‹é©—è­‰ã€‚</p>

                    <h4>3.4 Phase 3ï¼šSandbox Trialï¼ˆæ²™ç®±è©¦è·‘ï¼‰</h4>
                    <p>åœ¨éš”é›¢ç’°å¢ƒå¯¦éš›åŸ·è¡Œ Skillï¼Œé©—è­‰è¡Œç‚ºæ˜¯å¦èˆ‡å®£å‘Šä¸€è‡´ã€‚</p>

                    <p><strong>éš”é›¢å±¤ç´šï¼ˆç”±å¼±åˆ°å¼·ï¼‰</strong></p>
                    <ul>
                        <li>Node.js <code>vm</code>ï¼ˆä¸å»ºè­°å–®ç¨ä¾è³´ï¼Œæ­·å²ä¸Šæœ‰é€ƒé€¸é¢¨éšªï¼‰</li>
                        <li>gVisorï¼ˆsyscall å±¤æ””æˆªï¼‰</li>
                        <li>Firecracker microVMï¼ˆé«˜éš”é›¢ï¼‰</li>
                    </ul>

                    <p><strong>è©¦è·‘ç›£æ§</strong></p>
                    <ul>
                        <li>ç¶²è·¯ï¼šDNS/TCP é€£ç·šç´€éŒ„ï¼Œæœªæˆæ¬Šå¤–è¯ç«‹å³æ¨™è¨˜ã€‚</li>
                        <li>æª”æ¡ˆï¼š<code>open/read/write</code> å­˜å–æ˜¯å¦è¶…å‡ºç™½åå–®ã€‚</li>
                        <li>ç¨‹åºï¼šç¦æ­¢ <code>fork/exec</code>ï¼›CPU > 5 ç§’æˆ–è¨˜æ†¶é«” > 128 MB å³çµ‚æ­¢ã€‚</li>
                        <li>è¡Œç‚ºä¸€è‡´æ€§ï¼šä»¥ mock è¼¸å…¥åŸ·è¡Œï¼Œæª¢æŸ¥è¼¸å‡ºæ˜¯å¦ç¬¦åˆ manifest schemaã€‚</li>
                    </ul>

                    <pre><code class="language-javascript">const result = await skill.run(
  { filepath: "/home/user/documents/test.txt" },
  { permissions: mockPermissions, logger: mockLogger }
);
validateAgainstSchema(result, skill.manifest.schema.output);</code></pre>

                    <h4>3.5 Phase 4ï¼šSignature Verificationï¼ˆæ•¸ä½ç°½ç« é©—è­‰ï¼‰</h4>
                    <p>ç¢ºä¿ã€Œé€šéå¯©æŸ¥çš„å…§å®¹ã€åœ¨ç™¼å¸ƒèˆ‡å®‰è£éç¨‹ä¸­æœªè¢«ç«„æ”¹ã€‚</p>

                    <p><strong>ç™¼å¸ƒç«¯</strong></p>
                    <ol>
                        <li>å° <code>manifest + entrypoint</code> åš SHA-256ã€‚</li>
                        <li>ç”¨ç™¼å¸ƒè€…ç§é‘°ç°½ç« ï¼Œç”¢ç”Ÿ <code>skill.sig</code>ã€‚</li>
                    </ol>

                    <p><strong>å¹³å°é©—è­‰ç«¯</strong></p>
                    <ol>
                        <li>å°æ”¶åˆ°çš„ <code>manifest + entrypoint</code> é‡æ–°è¨ˆç®— SHA-256ã€‚</li>
                        <li>ç”¨è¨»å†Šå…¬é‘°é©—è­‰ç°½ç« ã€‚</li>
                        <li>ä¸ä¸€è‡´å³æ‹’çµ•ä¸Šæ¶/å®‰è£ã€‚</li>
                    </ol>

                    <h4>3.6 å…©å€‹ Skill Pluginï¼ˆè½åœ°ç¤ºä¾‹ï¼‰</h4>
                    <ol>
                        <li><strong><code>system_info</code></strong>ï¼šæŸ¥è©¢ç³»çµ±æ™‚é–“ã€æ™‚å€ã€hostnameï¼›<code>network=false</code>ã€<code>exec=false</code>ï¼Œä¸¦åœ¨åŸ·è¡Œæ™‚ä»¥ <code>context.permissions.require()</code> å†åš runtime gateã€‚</li>
                        <li><strong><code>file_summarizer</code></strong>ï¼šè®€å–ç™½åå–®ç›®éŒ„æ–‡å­—æª”ï¼ŒåŒ…å«äº”å±¤é˜²è­·ï¼ˆnull byte é˜²è­·ã€<code>path.resolve()</code> æ­£è¦åŒ–ã€ç™½åå–®ç›®éŒ„æ¯”å°ã€å‰¯æª”åç™½åå–®ã€1MB å¤§å°é™åˆ¶ï¼‰ã€‚</li>
                    </ol>

                    <h4>3.7 ç¸±æ·±é˜²ç¦¦ç¸½çµ</h4>
                    <p><code>Phase 1 -> Phase 2 -> Phase 3 -> Phase 4</code> åˆ†åˆ¥è™•ç†å®£å‘Šåˆè¦ã€éœæ…‹é¢¨éšªã€å‹•æ…‹è¡Œç‚ºèˆ‡å®Œæ•´æ€§é©—è­‰ã€‚ä»»ä¸€éšæ®µå‘½ä¸­ <code>CRITICAL/ERROR</code> å³ä¸­æ­¢æµç¨‹ï¼Œé™ä½æƒ¡æ„ Skill é€²å…¥ç”Ÿæ…‹ç³»æ©Ÿç‡ã€‚</p>
                </div>
            </section>

            <section id="section-5">
                <h2>5. OpenClaw è‡ªè¨‚ Skill Plugin èˆ‡è‡ªå‹•åŒ– Agent å¯¦ä½œèªªæ˜</h2>

                <div id="section-5-1">
                    <h3>(1) è‡ªè¨‚ OpenClaw Skill Pluginï¼ˆ<code>todo-helper</code>ï¼‰</h3>
                    <p>å·²å¯¦ä½œå…¨æ–° pluginï¼š<code>extensions/todo-helper/</code>ï¼Œæä¾›ä¸‰å€‹å·¥å…·èƒ½åŠ›ï¼š</p>
                    <ol>
                        <li><code>local_time({ timezone? })</code>ï¼šå›å‚³æœ¬åœ°æˆ–æŒ‡å®šæ™‚å€æ™‚é–“ï¼ˆISOã€local stringã€epochï¼‰ã€‚</li>
                        <li><code>read_and_summarize({ path, maxBytes?, maxSentences? })</code>ï¼šåœ¨ allowlist è·¯å¾‘å…§è®€å–æª”æ¡ˆä¸¦å›å‚³æ‘˜è¦ã€‚</li>
                        <li><code>read_todo_snapshot({ path?, includeCompleted?, lookaheadHours? })</code>ï¼šè®€å– To-do å¿«ç…§ JSONï¼Œåˆ†é¡é€¾æœŸ / ä»Šæ—¥ / å³å°‡åˆ°æœŸ / æœªè¨­å®šåˆ°æœŸï¼Œä¸¦åš stale æª¢æŸ¥ã€‚</li>
                    </ol>
                    <p><strong>ç›¸é—œæª”æ¡ˆ</strong></p>
                    <ul>
                        <li><code>extensions/todo-helper/index.ts</code></li>
                        <li><code>extensions/todo-helper/openclaw.plugin.json</code></li>
                        <li><code>extensions/todo-helper/skills/todo-sync/SKILL.md</code></li>
                        <li><code>extensions/todo-helper/skills/todo-notify/SKILL.md</code></li>
                    </ul>
                </div>

                <div id="section-5-2">
                    <h3>(2) è‡ªå‹•åŒ– Agent å·¥ä½œæµç¨‹ï¼ˆè‡³å°‘å…©å€‹ skillï¼‰</h3>
                    <p>æœ¬å¯¦ä½œä½¿ç”¨ <strong>3 å€‹ skill</strong>ï¼ˆç¬¦åˆã€Œå…©å€‹ä»¥ä¸Š skillã€è¦æ±‚ï¼‰ï¼š</p>
                    <ol>
                        <li><code>todo-sync</code></li>
                        <li><code>organize-files</code></li>
                        <li><code>todo-notify</code></li>
                    </ol>

                    <p>æ’ç¨‹ï¼šæ¯æ—¥ <code>09:00</code>ï¼ˆæœ¬åœ°æ™‚å€ï¼‰å•Ÿå‹•ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
                    <ol>
                        <li><strong>todo-sync</strong>ï¼šå…ˆå‘¼å« <code>local_time</code>ï¼Œå†å‘¼å« <code>read_todo_snapshot</code>ï¼Œå®Œæˆé€¾æœŸ/ä»Šæ—¥/å³å°‡åˆ°æœŸåˆ†é¡èˆ‡ stale æª¢æŸ¥ã€‚</li>
                        <li><strong>organize-files</strong>ï¼šæ•´ç†æŒ‡å®šè³‡æ–™å¤¾ï¼ˆå¦‚ <code>~/Downloads</code>ï¼‰ï¼Œè¼¸å‡ºæ•´ç†çµæœã€‚</li>
                        <li><strong>todo-notify</strong>ï¼šç”Ÿæˆæé†’æ‘˜è¦ï¼ˆå«ä¸‹ä¸€æ­¥è¡Œå‹•ï¼‰ä¸¦ç™¼é€åˆ° <code>last route</code>ã€‚</li>
                    </ol>

                    <h4>è‡ªå‹•åŒ– Agent å·¥ä½œæµç¨‹åœ–</h4>
                    <div class="mermaid">flowchart TB
                        subgraph SCHEDULE["æ’ç¨‹è§¸ç™¼ (æ¯æ—¥ 09:00)"]
                            S1["Cron Job è§¸ç™¼"]
                        end

                        subgraph SYNC["Skill 1: todo-sync"]
                            S2["è®€å– SKILL.md"]
                            S3["å‘¼å« local_time å·¥å…·"]
                            S4["å‘¼å« read_todo_snapshot å·¥å…·"]
                            S5{"åˆ†æçµæœ"}
                            S6["åˆ†é¡: é€¾æœŸ/ä»Šæ—¥/å³å°‡åˆ°æœŸ/ç„¡åˆ°æœŸæ—¥"]
                            S7["Stale æª¢æŸ¥"]
                        end

                        subgraph ORGANIZE["Skill 2: organize-files"]
                            O1["è®€å– SKILL.md"]
                            O2["è®€å– inbox è³‡æ–™å¤¾"]
                            O3{"æª”æ¡ˆé¡å‹"}
                            O4["ç§»å‹•: documents (.pdf, .docx)"]
                            O5["ç§»å‹•: images (.jpg, .png)"]
                            O6["è¼¸å‡ºæ•´ç†çµæœ"]
                        end

                        subgraph NOTIFY["Skill 3: todo-notify"]
                            N1["è®€å– SKILL.md"]
                            N2["ç”Ÿæˆæ‘˜è¦å ±å‘Š"]
                            N3["åŒ…å«: Time / Snapshot Health / Priority Focus / Upcoming / File Organization / Next Step"]
                            N4["ç™¼é€åˆ° last route"]
                            N5["å®Œæˆ"]
                        end

                        SCHEDULE --> SYNC
                        S2 --> S3
                        S3 --> S4
                        S4 --> S5
                        S5 --> S6
                        S6 --> S7
                        S7 --> ORGANIZE

                        O1 --> O2
                        O2 --> O3
                        O3 -->|*.pdf, *.docx| O4
                        O3 -->|*.jpg, *.png| O5
                        O4 --> O6
                        O5 --> O6
                        O6 --> NOTIFY

                        N1 --> N2
                        N2 --> N3
                        N3 --> N4
                        N4 --> N5

                        style SCHEDULE fill:#e0f2fe,stroke:#075985
                        style SYNC fill:#dcfce7,stroke:#166534
                        style ORGANIZE fill:#fef9c3,stroke:#854d0e
                        style NOTIFY fill:#fee2e2,stroke:#991b1b
                    </div>

                    <h4>è©³ç´°è¨­å®šæ­¥é©Ÿï¼ˆå¯¦éš›å¯åŸ·è¡Œï¼‰</h4>

                    <p><strong>1) æº–å‚™ To-do snapshot æª”æ¡ˆï¼ˆè³‡æ–™ä¾†æºï¼‰</strong></p>
                    <ul>
                        <li>åœ¨ To-do å‰ç«¯é€£æ¥ snapshot æª”ï¼Œå»ºè­°ä½¿ç”¨ Host è·¯å¾‘ï¼š<code>/Users/silver/.openclaw/workspace/openclaw-data/todo-snapshot.json</code></li>
                        <li>Gateway å®¹å™¨å…§å°æ‡‰è·¯å¾‘ï¼š<code>/home/node/.openclaw/workspace/openclaw-data/todo-snapshot.json</code></li>
                    </ul>

                    <p><strong>2) è¨­å®š <code>todo-helper</code> plugin config</strong></p>
                    <p>åœ¨ <code>~/.openclaw/openclaw.json</code> ç¢ºèª <code>allowedRoots</code> èˆ‡ <code>defaultSnapshotPath</code>ï¼š</p>
                    <pre><code class="language-json">{
  "plugins": {
    "entries": {
      "todo-helper": {
        "enabled": true,
        "config": {
          "allowedRoots": [
            "/home/node/.openclaw/workspace/openclaw-data",
            "/home/node/.openclaw/workspace/automation-demo"
          ],
          "defaultSnapshotPath": "/home/node/.openclaw/workspace/openclaw-data/todo-snapshot.json",
          "maxReadBytes": 262144,
          "staleMinutes": 180,
          "enableReadSummary": true
        }
      }
    }
  }
}</code></pre>

                    <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose restart openclaw-gateway</code></pre>

                    <p><strong>3) å»ºç«‹/æ›´æ–° cron jobï¼ˆå›ºå®š skill é †åºï¼‰</strong></p>
                    <pre><code class="language-bash">AUTOMATION_MESSAGE=$(cat <<'PROMPT'
You are executing a cron automation verification run.

Mandatory requirements (do not skip):
1) Read /app/extensions/todo-helper/skills/todo-sync/SKILL.md.
2) Call local_time exactly once.
3) Call read_todo_snapshot exactly once with:
   /home/node/.openclaw/workspace/openclaw-data/todo-snapshot.json
4) Read /app/extensions/todo-helper/skills/organize-files/SKILL.md.
5) Use exec to organize /home/node/.openclaw/workspace/automation-demo/inbox:
   - documents: *.pdf, *.docx
   - images: *.jpg, *.png
   - top-level files only (maxdepth 1)
6) Read /app/extensions/todo-helper/skills/todo-notify/SKILL.md.

Final output headings:
Time
Snapshot Health
Priority Focus
Upcoming
File Organization
Next Step
PROMPT
)

cd /Users/silver/Documents/openclaw-main
docker compose run --rm openclaw-cli cron add \
  --name "verify-todo-workflow" \
  --cron "0 9 * * *" \
  --session isolated \
  --message "$AUTOMATION_MESSAGE" \
  --deliver \
  --channel last \
  --best-effort-deliver</code></pre>

                    <p>è‹¥ job å·²å­˜åœ¨ï¼Œæ”¹ç”¨ï¼š</p>
                    <pre><code class="language-bash">docker compose run --rm openclaw-cli cron edit &lt;jobId&gt; \
  --message "$AUTOMATION_MESSAGE" \
  --deliver \
  --channel last \
  --best-effort-deliver</code></pre>

                    <p><strong>4) æ‰‹å‹•è§¸ç™¼èˆ‡é©—è­‰ï¼ˆå« log å–è­‰ï¼‰</strong></p>
                    <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose run --rm openclaw-cli cron list
docker compose run --rm openclaw-cli cron run &lt;jobId&gt; --force --timeout 180000
docker compose run --rm openclaw-cli cron runs --id &lt;jobId&gt; --limit 5</code></pre>

                    <pre><code class="language-bash">docker compose exec openclaw-gateway sh -lc '
S=$(ls -t /home/node/.openclaw/agents/main/sessions/*.jsonl | head -n 1)
echo "$S"
grep -n "todo-sync\|organize-files\|todo-notify\|local_time\|read_todo_snapshot\|\"name\":\"exec\"" "$S" | sed -n "1,120p"
'</code></pre>

                    <p><strong>5) é©—æ”¶é‡é»</strong></p>
                    <ul>
                        <li>session log å¯çœ‹åˆ° <code>todo-sync -&gt; organize-files -&gt; todo-notify</code> å°æ‡‰è®€å–/å·¥å…·å‘¼å«ã€‚</li>
                        <li><code>read_todo_snapshot</code> ä½¿ç”¨ <code>openclaw-data/todo-snapshot.json</code> è·¯å¾‘ã€‚</li>
                        <li><code>organize-files</code> åªæ•´ç† top-level çš„ç›®æ¨™å‰¯æª”åæª”æ¡ˆã€‚</li>
                        <li>é‡è·‘å¾Œæª”æ¡ˆçµæ§‹ç¶­æŒä¸è®Šï¼ˆidempotentï¼‰ã€‚</li>
                        <li>è‹¥æœªè¨­å®š <code>--to</code> recipientï¼Œ<code>cron runs</code> å¯èƒ½é¡¯ç¤º <code>Delivery skipped</code>ï¼Œæ­¤æ™‚ä»¥ session log é©—è­‰æµç¨‹æ˜¯å¦å®Œæ•´åŸ·è¡Œã€‚</li>
                    </ul>

                    <p><strong>éŒ¯èª¤åˆ†æ”¯</strong></p>
                    <ul>
                        <li>è‹¥ snapshot è®€å–å¤±æ•—æˆ– staleï¼Œå›è¦†å¿…å«å¤±æ•—åŸå› èˆ‡ä¿®å¾©å»ºè­°ã€‚</li>
                    </ul>

                    <p><strong>å®Œæ•´æµç¨‹èˆ‡å‘½ä»¤å±•ç¤ºæ–‡ä»¶</strong></p>
                    <ul>
                        <li><code>docs/automation/todo-web-agent-workflow.md</code></li>
                    </ul>
                </div>
            </section>

            <section id="section-6">
                <h2>6. é™„ä»¶ï¼šå¦‚ä½•å•Ÿå‹•ï¼ˆFrontend + OpenClaw + Dockerï¼‰</h2>

                <h3>(1) å•Ÿå‹• OpenClaw Gatewayï¼ˆDockerï¼‰</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose up -d openclaw-gateway
docker compose ps openclaw-gateway</code></pre>

                <h3>(2) é–‹å•Ÿ Control UIï¼ˆå¸¶ Tokenï¼‰</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
source .env
open "http://127.0.0.1:18789/?token=$OPENCLAW_GATEWAY_TOKEN"</code></pre>

                <p>è‹¥å‡ºç¾ <code>pairing required</code>ï¼š</p>
                <pre><code class="language-bash">docker compose exec openclaw-gateway node dist/index.mjs devices list --json
docker compose exec openclaw-gateway node dist/index.mjs devices approve <requestId> --json</code></pre>

                <h3>(3) å•Ÿå‹• To-do å‰ç«¯</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/To-do
docker compose up -d --build todo-app
docker compose ps todo-app</code></pre>
                <p>ç€è¦½å™¨é–‹å•Ÿï¼š<code>http://localhost:8080</code></p>
                <p>ï¼ˆTo-do å°ˆæ¡ˆ compose æœå‹™ï¼š<code>todo-app</code>ï¼Œå®šç¾©æ–¼ <code>/Users/silver/Documents/To-do/docker-compose.yml</code>ï¼‰</p>

                <h3>(4) å®‰è£èˆ‡å•Ÿç”¨ <code>todo-helper</code> plugin</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose run --rm openclaw-cli plugins install ./extensions/todo-helper
docker compose run --rm openclaw-cli plugins enable todo-helper
docker compose restart openclaw-gateway</code></pre>

                <h3>(5) é©—è­‰æ’ç¨‹æµç¨‹ï¼ˆæ‰‹å‹•è§¸ç™¼ï¼‰</h3>
                <pre><code class="language-bash">cd /Users/silver/Documents/openclaw-main
docker compose run --rm openclaw-cli cron list
docker compose run --rm openclaw-cli cron run <jobId> --force
docker compose run --rm openclaw-cli cron runs --id <jobId> --limit 20</code></pre>
            </section>
        </main>
    </div>
<script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";

    // Preserve original mermaid source for Section-3 collapsible re-rendering.
    document.querySelectorAll("#section-3-4 .diagram-collapsible .mermaid").forEach((el) => {
        el.dataset.mermaidSource = el.textContent.trim();
    });

    mermaid.initialize({
        startOnLoad: true,
        theme: "default",
        securityLevel: "strict",
        fontFamily: "Noto Sans TC, PingFang TC, Microsoft JhengHei, sans-serif",
        flowchart: {
            useMaxWidth: false,
            htmlLabels: false,
            nodeSpacing: 40,
            rankSpacing: 55,
            padding: 12
        }
    });

    async function rerenderMermaidInContent(contentEl) {
        const nodes = Array.from(contentEl.querySelectorAll(".mermaid"));
        if (!nodes.length) return;

        nodes.forEach((node) => {
            const source = node.dataset.mermaidSource || node.textContent.trim();
            node.innerHTML = source;
            node.removeAttribute("data-processed");
        });

        try {
            await mermaid.run({ nodes });
        } catch (err) {
            console.error("Mermaid re-render failed:", err);
        }
    }

    function setCollapsibleState(collapsible, open) {
        const header = collapsible.querySelector(".diagram-collapsible-header");
        const icon = header ? header.querySelector(".toggle-icon") : null;
        if (open) {
            collapsible.classList.add("open");
            if (icon) icon.textContent = "â–¼";
            if (header) header.setAttribute("aria-expanded", "true");
        } else {
            collapsible.classList.remove("open");
            if (icon) icon.textContent = "â–¶";
            if (header) header.setAttribute("aria-expanded", "false");
        }
    }

    // Collapsible diagrams - default collapsed, click header to expand.
    function initCollapsibleDiagrams() {
        const collapsibles = document.querySelectorAll("#section-3-4 .diagram-collapsible");

        collapsibles.forEach((collapsible) => {
            const header = collapsible.querySelector(".diagram-collapsible-header");
            const content = collapsible.querySelector(".diagram-collapsible-content");

            if (!header || !content) return;
            header.setAttribute("role", "button");
            header.setAttribute("tabindex", "0");
            setCollapsibleState(collapsible, false);

            const toggle = async () => {
                const willOpen = !collapsible.classList.contains("open");
                setCollapsibleState(collapsible, willOpen);
                if (willOpen) {
                    // Always re-render when expanding to avoid hidden-render layout issues.
                    await rerenderMermaidInContent(content);
                }
            };

            header.addEventListener("click", toggle);
            header.addEventListener("keydown", (event) => {
                if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault();
                    toggle();
                }
            });
        });
    }

    window.addEventListener("load", () => {
        initCollapsibleDiagrams();
    });
</script>
</body>
</html>
