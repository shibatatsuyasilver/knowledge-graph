services:
  neo4j:
    image: neo4j:5.26-community
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_server_memory_heap_initial__size: 512m
      NEO4J_server_memory_heap_max__size: 1024m
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p password 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 20s
    volumes:
      - neo4j_data_e2e:/data

  llm_api:
    build:
      context: ..
      dockerfile: llm_kg/Dockerfile
    environment:
      OLLAMA_BASE_URL: "${OLLAMA_BASE_URL:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${NL2CYPHER_MODEL:-ministral-3:14b}"
      OLLAMA_NUM_CTX: 4096
      OLLAMA_NUM_PREDICT: 256
      OLLAMA_TEMPERATURE: 0.1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=3).read()\"",
        ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 5s

  api_smoke:
    image: python:3.11-slim
    depends_on:
      llm_api:
        condition: service_healthy
    command:
      [
        "sh",
        "-lc",
        "python -c \"import json,urllib.request; body=json.dumps({'question':'請用一句話說明知識圖譜'}, ensure_ascii=False).encode('utf-8'); req=urllib.request.Request('http://llm_api:8000/api/chat', data=body, headers={'Content-Type':'application/json; charset=utf-8'}); print(json.loads(urllib.request.urlopen(req, timeout=120).read().decode('utf-8'))['answer'])\"",
      ]
    restart: "no"

  tester:
    image: python:3.11-slim
    working_dir: /workspace
    volumes:
      - ../../:/workspace
    depends_on:
      neo4j:
        condition: service_healthy
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password
      OLLAMA_BASE_URL: "${OLLAMA_BASE_URL:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${NL2CYPHER_MODEL:-ministral-3:14b}"
      EXTRACTION_MODEL: "${EXTRACTION_MODEL:-sam860/deepseek-r1-0528-qwen3:8b}"
      NL2CYPHER_MODEL: "${NL2CYPHER_MODEL:-ministral-3:14b}"
      EXTRACTION_TIMEOUT_SECONDS: "600"
      EXTRACTION_NUM_PREDICT: "8192"
      NL2CYPHER_TIMEOUT_SECONDS: "300"
      NL2CYPHER_NUM_PREDICT: "128"
      E2E_SAMPLE_TEXT: "台積電由張忠謀創立，總部在新竹科學園區。台積電供應晶片給 Apple 與 NVIDIA。"
      MIN_QA_SUCCESS: "2"
      PYTHONUNBUFFERED: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command:
      [
        "sh",
        "-lc",
        "pip install --no-cache-dir -r backend/llm_kg/requirements.txt pytest && python -m pytest -m e2e -v",
      ]

volumes:
  neo4j_data_e2e:
